<!DOCTYPE html>
<!-- This work is licensed under the Creative Commons Attribution-ShareAlike 4.0 International License. To view a copy of this license, visit https://creativecommons.org/licenses/by-sa/4.0/ -->
<html>
<head>
  <title>Statewide Planning Map</title>
  <meta http-equiv="X-UA-Compatible" content="IE=EDGE">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="-1">
  <meta http-equiv="CACHE-CONTROL" content="NO-CACHE">
  <link rel="stylesheet" href="https://js.arcgis.com/3.32/dijit/themes/claro/claro.css">
  <link rel="stylesheet" href="https://js.arcgis.com/3.32/esri/css/esri.css">
  <style>
	 #maskDiv{
	 	height: 100%;
	 	width: 100%;
	 	top: 0;
  	left: 0;
	 	background-color: rgba(0,0,0,.5);
	 	position: fixed;
	 	display: none;
	 	z-index: 100;
	 }
	 #releaseNotesDiv{
	 	height: auto;
	 	width: 350px;
    margin:auto;
    transform: translate(0%,50%);
	 	background-color: rgba(245,245,245,1);
	 	color: #444444;
	 	font-size: .8em;
	 	text-align: center;
	  border-radius: 5px;
	  padding: 10px;
	 	position: relative;
	 	display: none;
	 	z-index: 101;
	 }
	 #overlaysWarningDiv, #getCoordsDiv{
	 	height: 160px;
	 	width: 200px;
	 	left:0;
    right:0;
    top: 0;
    bottom: 0;
    margin-left:auto;
    margin-right:auto;
    margin-top: auto;
    margin-bottom: auto;
	 	background-color: rgba(245,245,245,1);
	 	color: #444444;
	 	font-size: .8em;
	 	text-align: center;
	  border-radius: 5px;
	  padding: 10px;
	 	position: absolute;
	 	display: none;
	 	z-index: 101;
	 }
	 h1 {
	    background-color: #143c5c;
	    color: #FFFFFF;
	    cursor: default;
	    font-size: 1.5em;
	    border-radius: 5px;
	    padding: 5px;
	    text-align: center;
	    margin-top: auto;
	 }
	 li {
	    color: #444444;
	    cursor: default;
	    font-size: 1.1em;
	    padding: 5px;
	    text-align: left;
	 }
	 #toc{
	  border: 2px solid;
	  border-radius: 5px;
	  border-color: #FFFFFF;
	  width:250px;
	  position: absolute;
	  left: 2px;
	  top: 2px;
	  bottom: 40px;
	  overflow: auto;
	 }
	 #mapDiv{
	  border: 2px solid;
	  border-radius: 5px;
	  border-color: #F8F8F8;
	  height:99%;
	  position: absolute;
	  left: 255px;
	  bottom: 2px;
	  right: 2px;
	  top: 2px;
	  overflow: hidden;
	 }
	 span{
	  display:block;
	 }
	 #info{
	  position: absolute;
	  bottom: 3px;
	  left: 22px;
	  z-index: 50;
	  color: #303030;
	  font-weight: bold;
	  text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;
	 }
	 #info2{
	  position: absolute;
	  bottom: 3px;
	  left: 90px;
	  z-index: 50;
	  color: #303030;
	  font-weight: bold;
	  text-shadow: -1px 0 white, 0 1px white, 1px 0 white, 0 -1px white;
	 }
	 #tcTabs{
	  cursor: pointer;
	  font-size: 15px;
	 }
	 #tcTabs td{
	  text-align: -webkit-center;
	  width: 10%;
	 }
	 #tcTabs td:hover{
	  background: lightgrey !important;
	 }
	 #tocMaps tr:nth-child(odd) {
	  color: #000000;
      background-color: #F0F0F0;
	 }
	 #tocMaps td:hover{
	  background: lightgrey;
	 }
	 #tocData tr:nth-child(odd) {
	  color: #000000;
      background-color: #F0F0F0;
	 }
	 #tocData td:hover{
	  background: lightgrey;
	 }
	 th{
	  background-color: #143c5c;
      color: #FFFFFF;
	  cursor: default;
	  font-size: 15px;
	  border-radius: 2px;
	 }
     .lrsTH{
      background-color: #FFFFFF;
      color: #143c5c;
   	  cursor: default;
   	  font-size: 15px;
      border: solid;
      border-color: #143c5c;
   	  border-radius: 2px;
     }
	 td{
	 border-radius: 2px;
	 }
	 .MeasureUnits{
	 	cursor: pointer;
	 }
	 #mapTab{
	  display: block;
	 }
	 #search {
	  display: block;
	  position: absolute;
	  z-index: 31;
	  top: 20px;
	  left: 277px;
     }
     .arcgisSearch .searchMenu .menuHeader{
       background:#143c5c;
	 }
	 .arcgisSearch .searchMenu li.active {
	   background-color: #143c5c;
	 }
	 .arcgisSearch .searchClear{
	 	color:#FFFF00;
	 	background-color:#D3D3D3;
	 }
	 .arcgisSearch .searchBtn{
	 	padding: 6px 5px;
	 }
	 .arcgisSearch .searchGroup .searchInput{
	 	width: 214px;
	 }
	 #measureTab{
	   display: none;
	 }
	 #queryTab{
	   display: none;
	 }
     #lrsTab{
       display: none;
     }
	 #sketchTab{
	   display: none;
	 }
	 #legendTab{
		display: none;
	    overflow: auto;
		height: auto;
	 }
	 #aboutTab{
	   display: none;
	 }
	 .tocTables{
	  cursor: default;
	  font-size: 13px;
	  width: 98%;
	 }
	select {
	 display: block;
     width: 98%;
     cursor: pointer;
    }
    button {
    	cursor: pointer;
    }
	#btnReleaseNotes{
		background: none;
		cursor: pointer;
		font-size: 13px;
	    font-family: inherit;
		color: #3333ff;
		border: none;
		margin: 0px;
		padding: 0px;
	  	z-index: 50;
    }
    #btnSurvey{
	  position: absolute;
	  bottom: 10px;
	  left: 70px;
	  z-index: 50;
    }
    #btnOpenDataPortal {
    	position: absolute;
    	background-color: #143c5c;
		font-size: 15px;
	    font-family: inherit;
		border: none;
		margin: 0px;
		padding: 0px;
	 	z-index: 101;
	 	bottom: 2px;
	  	left: 2px;
	  	width: 250px;
    	margin-left:auto;
    	margin-right:auto;
    	margin-top: auto;
    	margin-bottom: auto;
	 	color: #fff;
	 	text-align: center;
	  	border-radius: 2px;
	  	padding: 2px;
	 	position: absolute;
	 	display: block;
	 }
	 #btnOpenDataPortal:hover {
	 	background: grey;
	 }
	 .HomeButton .home {
        background-image: url("https://maps.dot.state.tx.us/Images/TexasIcon.png");
        background-color: #143c5c;
        background-size: 24px 24px;
        width: 28px;
      }
      #HomeButton {
        position: absolute;
        left: 20px;
        top: 133px;
        z-index: 30;
        display: block;
      }
    .Overlay, .Basemaps, .SearchResult, .clickable{
    	cursor: pointer;
    }
	#searchResults{
	 position: relative;
	 overflow: auto;
	 min-height: initial;
	 color: blue;
	 font-size: 15px;
	}
	#queryResults{
	 overflow: auto;
	 height: 200px;
	 color: blue;
	 font-size: 15px;
	}
	.PRJFields {
		width: 175px;
	}
	.queryFields {
		width: 127px;
	}

	nav {
	position: absolute;
    top: 20px;
    right: 20px;
	text-align: center;
	}
	nav ul ul {
		display: none;
	}
		nav ul li:hover > ul {
			display: block;
		}
	nav ul {
		background: #143c5c;
		/*box-shadow: 0px 0px 10px rgba(0,0,0,0.5);*/
		padding: 0 0px;
		border-radius: 5px;
		list-style: none;
		position: relative;
		display: inline-table;
		margin: inherit;
	}
		nav ul:after {
			content: "";
			clear: both;
			display: block;

		}
		nav ul li {
			float: left;
			font-size: .95em;
		}
			nav ul li a {
				display: block;
				padding: 0px 5px;
				color: #fff;
				text-decoration: none;
			}
		nav ul ul {
			background: #5f6975;
			border-radius: 0px 0px 5px 5px;
			padding: 0;
			position: absolute;
			top: 88%;
			left:0%;
			right:0%;

		}
			nav ul ul li {
				float: none;
				border-radius: 0px 0px 5px 5px;
				border-top: 1px solid #6b727c;
				border-bottom: 1px solid #575f6a;
				position: relative;
				font-size: 0.8em;
			}
				nav ul ul li a {
					padding: 0px 5px;
					color: #fff;
					border-radius: 5px;
				}
					nav ul ul li a:hover {
						background: #4b545f;
						border-radius: 0px;
					}

	#credits {
		position: absolute;
		right: 15px;
		bottom: 10px;
		font-size: .8em;
	 	z-index: 51;
	    color: #666666;
    	background: rgba(255,255,255,0.7);
    	padding: 0px 5px;
	}
	.esriAttributionList {
		display: none;
	}
	#btnClearHighlighter {
		position: absolute;
		top: 90px;
		left: 20px;
		z-index: 30;
		width: 32px;
		height: 32px;
	    border: 1px solid #57585A;
        background-color: rgb(255, 255, 184);
	    color: #4C4C4C;
		border-radius: 5px;
		text-align: center;
		font-size: 20px;
		font-family: verdana,helvetica;
		line-height: 25px;
	    direction: ltr;
        outline: none;
    	padding-bottom: 5px;
    	background: radial-gradient(white, lightyellow, yellow);
	}
	.esriLegendLayerLabel td{
	     display: none;
	     font-weight:bold;
	     color: #4C4C4C;
	}
	.esriLegendMsg{
	 	display: none;
	}
	.esriSimpleSlider{
	 	top:60px;
	 	left:20px;
	 	z-index:30;
	}
	.esriPopupWrapper .title {
    	cursor: move;
	}
	.esriPopup .hidden {
    	display: none !important;
	}

  /*CSS for Query Form*/
  .qryButton {
    width: 100%;
    background-color: gray;
    color: white;
    padding: 7px 10px;
    margin: 4px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: Arial;
    font-size: 14px;
  }
  .qryInputs {
    width: 100%;
    padding: 7px 10px;
    margin: 4px 0px;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-family: Arial;
    font-size: 14px;
  }
  .qryLabel {
    font-family: Arial;
    font-size: 14px;
  }
  /*End CSS for Query Form*/

  </style>
  <!-- Google Analystics -->
  <script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-103754009-1', 'auto');
	  ga('send', 'pageview');

  </script>
  <script>
      var dojoConfig = {
        has: {
          "esri-featurelayer-webgl": 1
        }
      };
  </script>
  <script src="https://js.arcgis.com/3.31/"></script>
  <script>
    //Check if using IE and get version
    var ua = window.navigator.userAgent;
    var isIE = /MSIE|Trident/.test(ua);
  </script>
  <script>

  //Map and measure variables
	var map,osmLayer,projectsRI,esri,measureClicked=false,gidWithMeasuresGeom,gidWithMeasuresGeomMPT,mapPoint,queryTaskDFO,queryTaskMPT,queryM,featurePartIndex,toolbar,xPointArray=new Array(),globalX,globalY
	,measureUnits="Miles",theDistMeasured=0,theLegend,tiled,polyline,activeOverlaysArray=[],vectorTileLayer,layerInfo=[],credits="TxDOT, TPP-GIS",credits,layer0,layer1,google,TxDOTVectorTileLayer,txAccessToken,appVersion="4.4.11 Singer";

  //Route Event Variables
	var dropbox,currentRoute="Nope",previousRoute="",currentGeometry;

	//Overlay variables
  var aadtLyr,labelLayerAADT,areaOfficeLyr,COGLyr,FCLyr,fcLastEditDate,UZAlyr,NatlFreightLyr,TXFreightLyr,NHSLyr,maintOfficeLyr,maintSecRoutesLyr,txTrunkLyr,MarkerLyr,labelLayerMarker,MPOLyr,nonAttainLyr,controlSectionLyr,energySectorLyr,
  labelLayerCS,USHouseLyr,railRoadLyr,speedLimitLyr,StateHouseLyr,StateSenateLyr,futureTrafficLyr,longTermPlanLyr,constScheduledLyr,finalForConstLyr,underDevLyr,minuteOrderLyr,pavementConditionLyr,VerticalLyr,permStationLyr,
  top100Lyr,labelLayerTop100,rdwyInvLyr,cemeteryLyr,shalePlaysLyr,shaleBasinsLyr,RMAlyr,tollLyr,futTollLyr,hurrEvacLyr, altFuelPoints, inrixTrafficLyr,memorialHighwayLyr,curCongLyr,futCongLyr,facLyr,bridgeLyr,connCorrLyr,MAP21Lyr,STRAHNETLyr,bikeLayer,activeOverlay;

  //Measure, tab, coords, url and marker offset variables
	var currentMeasure=0,activeTab='tcMap',deLength=0,coords,url,markerAndOffset;

	require(["esri/map","esri/layers/OpenStreetMapLayer","esri/request","esri/renderers/Renderer","dojo/dom-construct","esri/layers/LayerInfo","esri/dijit/Scalebar","dojo/on","dojo/dom-class","dojo/query","dojo/dnd/Moveable",
		"esri/dijit/HomeButton","esri/tasks/query","esri/tasks/QueryTask","esri/arcgis/utils","esri/domUtils","esri/dijit/Legend","esri/dijit/Search","esri/geometry/webMercatorUtils","dojo/dom","esri/layers/KMLLayer","dojo/parser",
		"esri/toolbars/draw","esri/geometry/geometryEngine","esri/geometry/geodesicUtils","esri/units","esri/graphic","esri/layers/GraphicsLayer","esri/graphicsUtils","esri/SpatialReference","esri/geometry/Extent","esri/layers/FeatureLayer","esri/symbols/SimpleLineSymbol",
		"esri/symbols/CartographicLineSymbol","esri/renderers/UniqueValueRenderer","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/TextSymbol","esri/renderers/SimpleRenderer","esri/renderers/ClassBreaksRenderer",
		"esri/layers/LabelLayer","esri/layers/LabelClass","esri/Color","esri/InfoTemplate","esri/layers/ArcGISTiledMapServiceLayer","esri/geometry/Polyline","esri/geometry/Point","esri/symbols/Font","esri/dijit/PopupTemplate",
		"dojo/number","dojo/_base/array","esri/layers/VectorTileLayer","esri/layers/WMTSLayer","esri/layers/WMTSLayerInfo","esri/layers/WebTiledLayer","esri/geometry/Circle", "esri/config","dojo/domReady!"],
    function (Map, OpenStreetMapLayer, esriRequest, Renderer, domConstruct, LayerInfo, Scalebar, on, domClass, query, Moveable, HomeButton,Query, QueryTask, arcgisUtils, domUtils, Legend, Search, webMercatorUtils, dom, KMLLayer, parser, Draw, geometryEngine,
		geodesicUtils, Units, Graphic, GraphicsLayer, graphicsUtils, SpatialReference, Extent, FeatureLayer,SimpleLineSymbol, CartographicLineSymbol, UniqueValueRenderer, SimpleMarkerSymbol,
		SimpleFillSymbol, TextSymbol, SimpleRenderer, ClassBreaksRenderer, LabelLayer, LabelClass, Color, InfoTemplate, Tiled,Polyline, Point, Font, PopupTemplate, number, array, VectorTileLayer, WMTSLayer, WMTSLayerInfo, WebTiledLayer, Circle, esriConfig)
    {

		parser.parse();

		window.onresize = handleIEProblem;
		handleIEProblem();

		map = new Map("mapDiv", {center: [-99.341389, 31.132222], zoom: 6, minZoom:5, maxZoom:20, logo: false, extent: new Extent({xmin:-20098296,ymin:-2804413,xmax:5920428,ymax:15813776,spatialReference:{wkid:102100}})});
		map.infoWindow.set("titleInBody", false);
		var theExtent = new esri.geometry.Extent({"xmin":-20098296,"ymin":-2804413,"xmax":5920428,"ymax":15813776,"spatialReference":{"wkid":102100}});
		var theCenter = new Point([-99.341389, 31.132222]);
		var theZoom = 6;

    //IF THERE ARE URL PARAMS, CENTER AND ZOOM
    var urlObject = esri.urlToObject(document.location.href);
    if(urlObject.query && urlObject.query.coords && urlObject.query.z){
        var coords = urlObject.query.coords.split(',');
        var lat = parseFloat(coords[0]);
        var long = parseFloat(coords[1]);
        var z = parseInt(urlObject.query.z);
        var point = esri.geometry.geographicToWebMercator(new esri.geometry.Point(long,lat));
        map.centerAndZoom(point,z);
    }

		// Vector basemap service
		TxDOTVectorTileLayer = new VectorTileLayer("https://tiles.arcgis.com/tiles/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vector_Tile_Basemap/VectorTileServer"); // TxDOT Vector Tile Basemap
		map.addLayer(TxDOTVectorTileLayer);

		// Google Imagery WMTS layer info
    var GoogleLayerInfo = new WMTSLayerInfo({
      identifier: "texas",
      tileMatrixSet: "0to20",
      format: "png"
    });

    var GoogleLayerOptions = {
      serviceMode: "KVP",
      layerInfo: GoogleLayerInfo
    };

		// Name server with CORS enabled for Google Imagery
		esri.config.defaults.io.corsEnabledServers.push ("https://txgi.tnris.org");

		// Add Google Imagery WMTS layer
	  google = new WMTSLayer("https://txgi.tnris.org/login/path/corner-express-popcorn-compact/wmts", GoogleLayerOptions);

		//Add Roadway Inventory data to map but don't show until needed during Query.
		addInventoryData();
    addBridgeData();

		// Add Home Button
    var home = new HomeButton({
      map: map,
    }, "HomeButton");
    home.startup();

		map.on("load", function() {
  		map.on("mouse-move", showCoordinates);
  		map.on("mouse-drag", showCoordinates);
    	map.on("mouse-move", showZoom);
  		map.on("mouse-drag", showZoom);
  		map.on("extent-change", showZoom);
      map.on("zoom-end", preventZoomOnImagery);
  		map.on("zoom-end", scaleDependentQueries);
		});

		map.on("load", function () {
			createToolbar();
			getBasemapLayers();
			loadRoadwaysLyr();
		});

    on(dom.byId("HomeButton"), "click", function(){
        if(urlObject.query){
            map.centerAndZoom(theCenter,theZoom);
        };
    });

    //Query Tab buttons and events
    on(dom.byId("btnAddSecondCondition"), "click", addSecondCondition);
    on(dom.byId("btnRemoveLastCondition"), "click", removeLastCondition);
    on(dom.byId("btnRunQuery"), "click", runQuery);
    on(dom.byId("radBridge"), "click", activateBridge);
    on(dom.byId("radRoadwayInventory"), "click", activateRoadwayInventory);
    on(dom.byId("riAttributes"), "change", function() {document.getElementById("conditions").value="";});
    on(dom.byId("bridgeAttributes"), "change", function() {document.getElementById("conditions").value="";});

    map.on("click", logCoords);
    map.on("click", identRouteForM);
    map.on("mouse-up", function() {
      if (document.getElementById("lrsTab").style.display=="block"){
          document.getElementById("mapDiv_container").style.cursor = "crosshair";
      }
    });

		// Clear graphic line on Measure Tab if when a new line is started
		map.on("click", clearMeasuredLineGraphic);
		map.on("mouse-move", newCoords);

    //- - - Drag and Drop Route Events - - -
    map.on("load", addDropListeners);

    function addDropListeners() {
      dropbox = document.getElementById("mapDiv");
      dropbox.addEventListener("dragenter", dragenter, false);
      dropbox.addEventListener("dragover", dragover, false);
      dropbox.addEventListener("drop", drop, false);
    }

    function dragenter(e) {
      e.stopPropagation();
      e.preventDefault();
    }

    function dragover(e) {
      e.stopPropagation();
      e.preventDefault();
    }

    function drop(e) {
      e.stopPropagation();
      e.preventDefault();

      const dt = e.dataTransfer;
      const files = dt.files;

      readFile(files);
    }

    function readFile(input) {
      var fileType = getRightCharacters(input[0].name,4);

      if (fileType==".csv") {
        map.graphics.clear();

        var file = input[0];
        var reader = new FileReader();

        reader.readAsText(file);

        reader.onload = function() {
          mapIt(reader.result.split("\n"));
        };

        reader.onerror = function() {
          console.log(reader.error);
        };
      }
      else {
        alert("Only .csv files are supported at this time.");
        document.getElementById("fileLoad").value="";
      }
    }

    function columnsList(theColumns) {
        var columnAssignments = {};
        var columns = theColumns.split("|");
        var fileRoute = columns.indexOf("RIA_RTE_ID");
        var fileFrom = columns.indexOf("FRM_DFO");
        var fileTo = columns.indexOf("TO_DFO");
        var fileColor = columns.indexOf("COLOR");
        var fileWidth = columns.indexOf("WIDTH");
        var fileDescription = columns.indexOf("DESCRIPTION");

        if (fileRoute>=0) {
          columnAssignments.RTE_NM = fileRoute;
        }
        if (fileFrom>=0) {
          columnAssignments.FROM = fileFrom;
        }
        if (fileTo>=0) {
          columnAssignments.TO = fileTo;
        }
        if (fileColor>=0) {
          columnAssignments.COLOR = fileColor;
        }
        if (fileWidth>=0) {
          columnAssignments.WIDTH = fileWidth;
        }
        if (fileDescription>=0) {
          columnAssignments.DESCRIPTION = fileDescription;
        }

        return columnAssignments;
    }

    function getRouteType(availableColumns) {
      var routeCheck = "RTE_NM" in availableColumns;
      var fromCheck = "FROM" in availableColumns;
      var toCheck = "TO" in availableColumns;
      var theRoute;
      var fromStatus = false;
      var toStatus = false;

      if (routeCheck) {
        theRoute = "RTE_NM";
      }
      else {
        theRoute = "None";
      }

      if (fromCheck) {
        fromStatus = true;
      }

      if (toCheck) {
        toStatus = true;
      }

      var headerStatus = [theRoute,fromCheck,toCheck];
      return headerStatus;
    }

    function setOrder(currentRecord,availableColumns) {
        var orderedData = [];
        var routeType = getRouteType(availableColumns);

        orderedData.push(routeType[0]);

        //Checking for route identifier
        if (routeType[0]=="RTE_NM") {
          orderedData.push(currentRecord[availableColumns.RTE_NM].toUpperCase());
        }

        orderedData.push(Number(currentRecord[availableColumns.FROM]));
        orderedData.push(Number(currentRecord[availableColumns.TO]));

        //Checks for missin elements and application of defaults
        var colorCheck = "COLOR" in availableColumns;
        var widthCheck = "WIDTH" in availableColumns;
        var descriptionCheck = "DESCRIPTION" in availableColumns;

        //Check Color, this one is causing it to crash for some reason
        if (colorCheck) {
          orderedData.push(currentRecord[availableColumns.COLOR]);
        }
        else {
          // orderedData.push("#0000FF");
          orderedData.push(getRandomColor());
        }

        //Check Width
        if (widthCheck) {
          orderedData.push(currentRecord[availableColumns.WIDTH]);
        }
        else {
          orderedData.push("4");
        }

        //Check Description
        if (descriptionCheck) {
          orderedData.push(currentRecord[availableColumns.DESCRIPTION]);
        }
        else {
          orderedData.push("No description available.<br><br>Adding location info. <br>From: " + currentRecord[availableColumns.FROM] + "<br>To: " + currentRecord[availableColumns.TO]);
        }

        return orderedData;
    }

    function mapIt(theData) {
      var currentRecord = [];
      var organizedRecord = [];
      var fileHeaderCheck = theData[0].trim();
      var availableColumns = columnsList(fileHeaderCheck);

      console.log("Record Count = " + theData.length);

      if (theData.length>=100) {
        var r = confirm("Mapping " + theData.length + " records could take a few minutes. The recommended record count is 100 or less. Continue?");
        if (r != true) {
          return;
        }
      }

      //checking for a RTE_NM or CTRL_SECT_NBR, FROM, TO
      var routeType = getRouteType(availableColumns);

      if (routeType[0]=="None"||routeType[1]==false||routeType[2]==false) {
        alert("No valid route or measures fields found. Please check your data and try again.");
        return;
      }

      if (Object.keys(availableColumns).length>=3) {
        for (var i = 1; i < theData.length; i ++) {
          currentRecord = theData[i].split("|");
          organizedRecord = setOrder(currentRecord,availableColumns);
          // console.log(organizedRecord);
          if (currentRecord.length>0) {
            getSegmentWithM(organizedRecord);
          }
        }
      }
      else {
        alert("File header record unrecognized.\n\nMinimum columns expected:\nRIA_RTE_ID|FRM_DFO|TO_DFO\nor\nCTRL_SECT_NBR|BMP|EMP\n\nFull header record example:\n\nRIA_RTE_ID|FRM_DFO|TO_DFO|COLOR|WIDTH|DESCRIPTION\n\nPlease check your file and try again.");
      }
    }

    function getSegmentWithM(theData) {
        //Checking for undefined parameters, stop process if found.
        for (var i = 0; i < theData.length; i++) {
          if (theData[i]==undefined) {
            console.log("Too few parameters.  Please check the URL");
            console.log(theData);
            return;
          }
        }

        currentRoute = theData[1];

        if (currentRoute==previousRoute) {
          findVertices("static",currentGeometry,theData[1],theData[2],theData[3],theData[4],theData[5],theData[6]);
        }
        else {
          var xmlhttp = new XMLHttpRequest();
          //Comment the following line out for synchronous
          //xmlhttp.responseType = 'json';
          xmlhttp.onreadystatechange=function() {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)	{
              //Post edit activities
              currentGeometry = xmlhttp.response;
              findVertices("static",xmlhttp.response,theData[1],theData[2],theData[3],theData[4],theData[5],theData[6]);
            }
          };

          var serviceString;
          var paraString;

          if (theData[0]=="RTE_NM"||theData[0]=="TE_NM") {
            serviceString = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0";
            paraString = "/query?f=json&where=RTE_NM='" + theData[1] + "'&returnGeometry=true&returnM=true";
          }
          if (theData[0]=="CTRL_SECT_NBR"||theData[0]=="TRL_SECT_NBR") {
            serviceString = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0";
            paraString = "/query?f=json&where=CTRL_SECT_NBR='" + theData[1] + "'&returnGeometry=true&returnM=true";
          }

          previousRoute = currentRoute;

          var queryString = serviceString+paraString;
          //Synchronous
           xmlhttp.open("POST",queryString,false);
          //Asynchronous
          //xmlhttp.open("POST",queryString,true);
          xmlhttp.send();
        }
    }

    function findVertices(requestType,geomWithM,theRoute,theFrom,theTo,theColor,theSize,theDescription) {
        var theGeomPart;
        var theGeometry;

        if (requestType=="static") {
          theGeometry = JSON.parse(geomWithM);
        }
        else {
          theGeometry = geomWithM;
        }

        var PrevCoordM;
        var CurCoordM;
        var partNumberBegin;
        var partNumberEnd;
        var vertexNumberBegin;
        var vertexNumberEnd;
        var beginM = 0;
        var endM = 0;

        var beginPoint=[];
        var endPoint=[];

        //Round measure parameters to prevent errors outside measure range
        theFrom = roundToDecimalPlace(theFrom,3);
        theTo = roundToDecimalPlace(theTo,3);

        var maxFeatureM = 0;
        var minFeatureM = 0;
        var maxCoordsLength = 0;
        //var tempTo = 0;

        for (var a=0; a < theGeometry.features.length; a++) {
          theGeomPart = theGeometry.features[a].geometry.paths;

          //Check Event M's and Feature M's
          maxCoordsLength = theGeometry.features[a].geometry.paths[0].length-1;
          minFeatureM = roundToDecimalPlace(theGeometry.features[a].geometry.paths[0][0][2],3);
          maxFeatureM = roundToDecimalPlace(theGeometry.features[a].geometry.paths[0][maxCoordsLength][2],3);

          //if from >= minM and to <= maxM run normally
          //if from < minM and to > maxM take the whole segment

          if (theFrom<=minFeatureM&&theTo>=maxFeatureM) {
            //Take the whole segment
            partNumberBegin = a;
            partNumberEnd = a;
            vertexNumberBegin = 0;
            vertexNumberEnd = theGeometry.features[a].geometry.paths[0].length-1;
            beginM = minFeatureM;
            endM = maxFeatureM;
            theFrom = minFeatureM;
            theTo = maxFeatureM;
          }
          else {
            //Run normally
            for (var j = 1; j < theGeomPart[0].length; j++) {
              PrevCoordM = roundToDecimalPlace(theGeomPart[0][j-1][2],3);
              CurCoordM = roundToDecimalPlace(theGeomPart[0][j][2],3);

              //Finding the Begin Vertex
              if (theFrom>=PrevCoordM&&theFrom<=CurCoordM) {
                partNumberBegin = a;
                vertexNumberBegin = j-1;
                beginM = theGeomPart[0][j-1][2];
                beginPoint.push(theGeomPart[0][j-1][0],theGeomPart[0][j-1][1]);
              }

              //Finding the End Vertex
              if (theTo>=PrevCoordM&&theTo<=CurCoordM) {
                partNumberEnd = a;
                vertexNumberEnd = j;
                endM = theGeomPart[0][j][2];
                endPoint.push(theGeomPart[0][j][0],theGeomPart[0][j][1]);
              }

            }
          }
        }

        if (partNumberBegin!=partNumberEnd) {
          return;
        }

        //Build Line 102100
        var newPolyline = new esri.geometry.Polyline(new esri.SpatialReference({wkid:102100}));
        newPolyline.type = "polyline";
        var tmpAttLine = [];

        for (var x = vertexNumberBegin; x <= vertexNumberEnd; x++) {
          tmpAttLine.push([theGeometry.features[partNumberBegin].geometry.paths[0][x][0],theGeometry.features[partNumberBegin].geometry.paths[0][x][1]]);
        }

        newPolyline.addPath(tmpAttLine);

        //4326
        var spatialReferenceLatLong = new SpatialReference({wkid:4326});

        //-- Set Radius for Begin Circle --
        var beginCircleRadius = Math.abs(beginM-theFrom) * 1609.344;

        if (beginCircleRadius<=0) {
          beginCircleRadius=1;
        }

        var beginCircleLatLong = webMercatorUtils.xyToLngLat(tmpAttLine[0][0], tmpAttLine[0][1]);

        //Build Circle from begin point
        var beginCircle = new Circle([beginCircleLatLong[0], beginCircleLatLong[1]],{
          "radius": beginCircleRadius,
          "radiusUnit": Units.METERS,
          "geodesic": true,
          "spatialReference": spatialReferenceLatLong
        });

        //Convert Begin Circle to Polygon 4326
        var beginPolygon = new esri.geometry.Polygon(new esri.SpatialReference({wkid:4326}));
        beginPolygon.type = "polygon";
        beginPolygon.addRing(beginCircle.rings[0]);

        //Convert Lat Long to Web Mercator, so everything is the same
        var beginPolygonWebMer = webMercatorUtils.geographicToWebMercator(beginPolygon);

        //-- Set Radius for End Circle --
        var endCircleRadius = Math.abs(endM-theTo) * 1609.344; //was theTo

        if (endCircleRadius<=0) {
          endCircleRadius=1;
        }

        var endCircleLatLong = webMercatorUtils.xyToLngLat(tmpAttLine[tmpAttLine.length-1][0], tmpAttLine[tmpAttLine.length-1][1]);

        //Build Circle from end point
        var endCircle = new Circle([endCircleLatLong[0], endCircleLatLong[1]],{
          "radius": endCircleRadius,
          "radiusUnit": Units.METERS,
          "geodesic": true,
          "spatialReference": spatialReferenceLatLong
        });

        //Convert End Circle to Polygon 4326
        var endPolygon = new esri.geometry.Polygon(new esri.SpatialReference({wkid:4326}));
        endPolygon.type = "polygon";
        endPolygon.addRing(endCircle.rings[0]);

        //Convert Lat Long to Web Mercator, so everything is the same
        var endPolygonWebMer = webMercatorUtils.geographicToWebMercator(endPolygon);

        //Trimming event linework if needed from beginning and ending of segment
        var finalLinework = newPolyline;
        var beginClip;
        var endClip;

        if (Math.abs(beginM-theFrom)>=.001) { // was .002
          beginClip = intersectLinework(newPolyline,beginPolygonWebMer);
          finalLinework = cutLinework(newPolyline,beginClip);
        }

        if (Math.abs(endM-theTo)>=.001) { // was .002
          endClip = intersectLinework(newPolyline,endPolygonWebMer);
          finalLinework = cutLinework(finalLinework,endClip);
        }

        if (tmpAttLine.length>1) {
          addEventToMap(finalLinework,theRoute,theFrom,theTo,theColor,theSize,theDescription,beginPolygon,endPolygon);
        }
        else {
          alert("No points found within range " + theFrom + "-" + theTo);
        }

      }

      function intersectLinework(linework,polygon) {
        var newGeometry = geometryEngine.intersect(linework, polygon);
        return newGeometry;
      }

      function cutLinework(linework,clipper) {
        var newGeometry = geometryEngine.difference(linework,clipper);
        return newGeometry;
      }

      function addEventToMap(theGeom,theRoute,theFrom,theTo,theColor,theSize,theDescription,beginPolygon,endPolygon) {
        var symbol = new esri.symbol.SimpleLineSymbol("solid", theColor, theSize);

        //Replace All, new method not common enough in new browsers yet
        //theDescription = theDescription.replaceAll("%20", " ");

        //Replace All, works in all browsers
        theDescription = theDescription.replace(/%20/g, ' ');

        var attr = {"Route Name":theRoute,"Description":theDescription,"From":theFrom,"To":theTo};
        var infoTemplate = new InfoTemplate("${Route Name}","<br/>${Description} <br/><br/>");

        map.graphics.add(new esri.Graphic(theGeom, symbol, attr, infoTemplate));
      }

      function roundToDecimalPlace(value,decimals) {
        return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
      }

      function getRightCharacters(theData,theNumber) {
        return theData.substring(theData.length-theNumber, theData.length);
      }

      function getRandomColor() {
        var availableColors = ["#ff0000","#ffbf00","#ffff00","#00ff00","#0000ff","#808080"];
        var ranColor = availableColors[getRandomIntInclusive(0,availableColors.length-1)];
        return ranColor;
      }

      //Random Number
      function getRandomIntInclusive(min,max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
      //- - - End Drag and Drop Route Events - - -

      var scalebar = new Scalebar({
          map: map,
          scalebarUnit: "english",
		      attachTo: "bottom-left"
      });

      map.on("layer-add-result", function (evt) {
	        // var layerInfo = arrayUtils.map(evt.layers, function (layer, index) {
	          // return {layer:layer.layer, title:layer.layer.name};
	        	// });
    	});

  		//Set up the legend and create an array of the layers that will show in the legend
      var layerInfo = [];
  		theLegend = new Legend({map:map},"legendDiv");
  		theLegend.layerInfos=layerInfo;

		  // when the infoWindow is moved, hide the arrow
		  var handle = query(".title", map.infoWindow.domNode)[0];
    	var dnd = new Moveable(map.infoWindow.domNode, {
        handle: handle
    	});

        on(dnd, 'FirstMove', function() {
            // hide pointer and outerpointer (used depending on where the pointer is shown)
            var arrowNode =  query(".outerPointer", map.infoWindow.domNode)[0];
            domClass.add(arrowNode, "hidden");

            var arrowNode =  query(".pointer", map.infoWindow.domNode)[0];
            domClass.add(arrowNode, "hidden");
        }.bind(this));

		    // Set up the search widget
        var search = new Search({
            enableButtonMode: true, //this enables the search widget to display as a single button
            enableLabel: false,
            enableSuggestions:true,
            enableInfoWindow: false,
            showInfoWindowOnSelect: false,
            allPlaceholder:"City, County, District, Hwy, CSJ...",
            map: map,
         }, "search");


         var sources = search.get("sources");

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_City_Boundaries/FeatureServer/0"),
            searchFields: ["CITY_NM"],
            displayField: "CITY_NM",
            exactMatch: false,
            name: "City",
            outFields: ["*"],
            placeholder: "City",
            highlightSymbol: new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),new esri.Color([255,255,255,0.0])),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0"),
            searchFields: ["CTRL_SECT_NBR"],
            displayField: "CTRL_SECT_NBR",
            exactMatch: false,
            outFields: ["CTRL_SECT_NBR","RTE_NM","BEGIN_MPT","END_MPT"],
            name: "Control Section",
            placeholder: "001001",
            highlightSymbol: new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0

         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0"),
            searchFields: ["CONTROL_SECT_JOB"],
            displayField: "CONTROL_SECT_JOB",
            exactMatch: false,
            outFields: ["CONTROL_SECT_JOB ","DISTRICT_NUMBER ","LAYMAN_DESCRIPTION1","HIGHWAY_NUMBER"],
            name: "Control Section Job (CSJ)",
            placeholder: "001001001",
            highlightSymbol: new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Counties_Detailed/FeatureServer/0"),
            searchFields: ["CNTY_NM"],
            displayField: "CNTY_NM",
            exactMatch: false,
            name: "County",
            outFields: ["*"],
            placeholder: "County",
            highlightSymbol: new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),new esri.Color([255,255,255,0.0])),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Districts/FeatureServer/0"),
            searchFields: ["DIST_NM"],
            displayField: "DIST_NM",
            exactMatch: false,
            name: "District",
            outFields: ["*"],
            placeholder: "District",
            highlightSymbol: new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),new esri.Color([255,255,255,0.0])),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways_Search/FeatureServer/0"),
            searchFields: ["RTE_CNTY"],
            displayField: "RTE_CNTY",
            exactMatch: false,
            name: "On System Highway",
            outFields: ["*"],
            placeholder: "Ex: IH0035, US0083, SH0079",
            highlightSymbol: new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),
            maxResults: 12,
            maxSuggestions: 12,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Top_100_Congested_Roadways/FeatureServer/0"),
            searchFields: ["RANK"],
            displayField: "RANK",
            exactMatch: false,
            name: "Top 100 Rank",
            outFields: ["*"],
            placeholder: "Enter a Rank (1-100)",
            highlightSymbol: new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Highway_Designations/FeatureServer/0"),
            searchFields: ["MO_NBR"],
            displayField: "MO_NBR",
            exactMatch: false,
            name: "Minute Order Number",
            outFields: ["*"],
            placeholder: "Minute Order Number",
            highlightSymbol: new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new esri.Color([255,255,0,0.5]), 7),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources.push({
            featureLayer: new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Bridges/FeatureServer/0"),
            searchFields: ["BRDG_ID"],
            displayField: "BRDG_ID",
            exactMatch: false,
            name: "NBI Structure Number (Bridge ID)",
            outFields: ["*"],
            placeholder: "NBI Structure Number (Bridge ID)",
            highlightSymbol: new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 16, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255,255,0, 0.5]), 1), new Color([255,255,0,0.5])),
            maxResults: 6,
            maxSuggestions: 6,
            enableSuggestions: true,
            minCharacters: 0
         });

         sources[0].categories = ["Coordinate System"];
         sources[0].placeholder= "-97.745520, 30.257332";
         sources[0].name = "Latitude/Longitude";

         //Set the sources above to the search widget
         search.set("sources", sources);
         search.on("select-result", function(evt) {
         	search.set("value", evt.result.name);
         });

         search.on("blur",expandSearch);

         function expandSearch(){
         	var x=document.getElementById("search_input");
         	if ((x.value).length > 0){
         		search.expand();
         	}
         }

   	     search.startup();

		function loadRoadwaysLyr(){
      var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Roadbed Type","${RDBD_TYPE}"],["Name/Number","${MAP_LBL}"],["Begin DFO","${BEGIN_DFO:NumberFormat(places:3)}"],["End DFO","${END_DFO:NumberFormat(places:3)}"]]);

			// TxDOT Roadways layer, used only for identifying roadways in the basemap
			var roadsInfoTemplate = new InfoTemplate("Roadway:", tableText);
			roadwaysLyr = new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0",{opacity: 0.0, outFields: ["RTE_NM", "RDBD_TYPE", "MAP_LBL", "RTE_PRFX", "BEGIN_DFO", "END_DFO"]});
			map.addLayer(roadwaysLyr);
			roadwaysLyr.setDefinitionExpression("RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'");
			roadwaysLyr.setInfoTemplate(roadsInfoTemplate);
			map.infoWindow.resize(310,300);
			map.on("zoom-start", function(){
				roadwaysLyr.setVisibility(false); //toggling the visibility prevents console errors related to trying to perform the query while the layer is redrawing (or because there are too many features to draw)
			});

      //zoom-end definition queries for roadways moved to scaleDependentQueries()
		}

		function getBasemapLayers(){
				layer0 = (map.getLayer(map.layerIds[0])); //This should be the SPM Basemap layer
				layer1 = (map.getLayer(map.layerIds[1])); //This will be INRIX if present
				document.getElementById("credits").innerHTML = credits;
		}

		//Function to force IE8 to work, eventually this will not be needed.
		function handleIEProblem() {
			var ua = window.navigator.userAgent;
			var msie = ua.indexOf ( "MSIE " );

			if ( msie > 0 ) {
				var theVersion = parseInt(ua.substring (msie+5, ua.indexOf (".", msie )));
				if (theVersion<8) {
					var outerDiv = document.getElementById("mapDiv");
					outerDiv.style.width = document.body.clientWidth-215;
				}
			}
		}

		function createLegend() {
			if (activeOverlay) {
				var div = document.getElementById("legendDiv");
				var divDesc = document.getElementById("legendDescDiv");
				div.innerHTML = '';
				divDesc.innerHTML = '';
				document.getElementById("legendNotesDiv").style.display="none";
        clearInrixLegend();
				array.forEach(activeOverlaysArray, function(name){
					var para = document.createElement("P");
					var link = document.createElement("a");
					var para2 = document.createElement("P");
					var link2 = document.createElement("a");
					para2.appendChild(link2);
					link.target="_blank";
					link2.target="_blank";
					document.getElementById("legendDescDiv").appendChild(para);
					document.getElementById("legendDescDiv").appendChild(link);
					document.getElementById("legendDescDiv").appendChild(para2);
					if (name == "Natl_Freight_Network") {
						var text = document.createTextNode('The National Highway Freight Network (NHFN) was developed by the Federal Highway Administration under the FAST Act, and replaces the National Freight Network previously developed under MAP-21.');
						var linkText = document.createTextNode('FHWA Website');
						para.appendChild(text);
						link.appendChild(linkText);
						link.href = "https://ops.fhwa.dot.gov/freight/infrastructure/nfn/index.htm"
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name == "TX_Freight_Network") {
						var linkText = document.createTextNode("Texas Freight Mobility Plan Website");
						link.appendChild(linkText);
						link.href = "https://www.dot.state.tx.us/move-texas-freight/";
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name == "Functional_Classification") {
						var date = new Date(fcLastEditDate);
						var year = date.getFullYear();
						var month = date.getMonth() + 1;
						var day = date.getDay();
						var text = document.createTextNode("Functional Classification last updated on: " + month + "/" + day + "/" + year);
						para.appendChild(text);
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name == "Shale_Plays") {
						var text = document.createTextNode('Credits: Esri Federal User Community');
						para.appendChild(text);
						var linkText = document.createTextNode("ArcGIS Online User Profile");
						link.appendChild(linkText);
						link.href = "https://txdot.maps.arcgis.com/home/user.html?user=Federal_User_Community";
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name =="Top_100"){
						var title = document.createTextNode('No Legend for Top 100 due to number of segment colors.');
						para.appendChild(title);
						var br = document.createElement("br");
						para.appendChild(br);
						var br = document.createElement("br");
						para.appendChild(br);
						var text = document.createTextNode('The Top 100 layer provides a list of the Top 100 Most Congested Roadways in the State as determined by Texas A&M Transportation Institute (TTI). For more information please visit the link below.');
						para.appendChild(text);
						var linkText = document.createTextNode("TTI Website");
						link.appendChild(linkText);
						link.href = "https://mobility.tamu.edu/texas-most-congested-roadways/";
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name =="Construction_Scheduled" | name =="Finalizing_for_Construction" | name =="Under_Development" | name =="Long_Term_Planning"){
						var linkText = document.createTextNode("Project Tracker Website");
						link.appendChild(linkText);
						link.href = "https://www.txdot.gov/apps-cq/project_tracker/";
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name == "Memorial_Highway") {
						var title = document.createTextNode('No Legend for Memorial Highways due to number of segment colors.');
						para.appendChild(title);
						var br = document.createElement("br");
						para.appendChild(br);
						var br = document.createElement("br");
						para.appendChild(br);
						var text = document.createTextNode('Memorial Highways pay tribute to notable people or groups and can be designated by the state or by local governments. State-designated Memorial Highways are designated by the Texas Legislature and typically get 2 signs that TxDOT is responsible for maintaining. Chapter 225 of the Transportation code shows the list of legislated memorial highways and is updated after each legislative session. Any local government can designate a memorial highway; however, in order to install signage on TxDOT right of way, the proposed designation must be approved by the TxDOT Commission or Executive Director.');
						var linkText = document.createTextNode('Transportation Code');
						para.appendChild(text);
						link.appendChild(linkText);
						link.href = "https://statutes.capitol.texas.gov/Docs/TN/htm/TN.225.htm";
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name == "Roadway_Inventory") {
						var text = document.createTextNode('The TxDOT Roadway Inventory is an annually produced dataset containing key attributes about each roadway, such as number of lanes, speed limits, and traffic volumes.  Typically, the dataset is aggregated and published for centerlines only.  However, this dataset shows data for each roadbed, including frontage roads.');
						para.appendChild(text);
						document.getElementById("legendNotesDiv").style.display="block";
					}

					else if (name == "Current_Congestion" || name == "Future_Congestion" ) {
						var text = document.createTextNode('This congestion calculation was performed using a method created by TxDOT referred to as the Car Space method. This method differs from other, more traditional methods by determining the space between cars in one-mile increments.  This method factors number of lanes, Annual Average Daily Traffic (AADT), and average car length to calculate the space remaining between vehicles for each 1 mile segment of roadway during the 30th highest peak hour. The calculated space between cars, or lack thereof, is categorized to illustrate levels of congestion.');
						para.appendChild(text);
						var linkText = document.createTextNode("Calculating congestion using the Car Space method.");
						link.appendChild(linkText);
						link.href = "https://ftp.dot.state.tx.us/pub/txdot-info/tpp/maps/congestion/calculating-congestion.pdf";
						document.getElementById("legendNotesDiv").style.display="block";
					}
					else if (name == "Bridges") {
						var text = document.createTextNode('The Bridges overlay is derived from the Bridge Inventory, Inspection, and Appraisal Files maintained by TxDOT.  All bridge structures located on public roadways are represented, whether managed by TxDOT, Metropolitan Planning Organizations, Toll Authorities, Counties, Municipalities, or others.');
						para.appendChild(text);
						var br = document.createElement("br");
						para.appendChild(br);
						var br = document.createElement("br");
						para.appendChild(br);
						var text2 = document.createTextNode('Bridge Division - Field Operations Section - Bridge Information Management (512) 416-2278');
						para.appendChild(text2);
						document.getElementById("legendNotesDiv").style.display="block";
					}

					else if (name == "Connectivitiy_Corridors") {
						var text = document.createTextNode('The Statewide Connectivity Corridors represent the Texas Transportation Commission approved corridors under the Unified Transportation Programs Category 4 funding category.  Category 4 provides funding for mobility and added capacity projects on major state highway system corridors, which provide statewide connectivity between urban areas and corridors. This network is composed of: the Texas Trunk System, National Highway System (NHS), Connections from the Texas Trunk System or the NHS to major ports on international borders or Texas water ports, National Freight Network, Texas Freight Network, and Hurricane Evacuation Routes.');
						para.appendChild(text);
						document.getElementById("legendNotesDiv").style.display="block";
					}

					else if (name == "NHS") {
						var text = document.createTextNode('MAP-21 Principal Arterials have been added as a separate layer when NHS is turned, since NHS routes are now extracted from the Geospatial Roadway Inventory Database (GRID) application, which does not contain that classification.  This was done as a courtesy to aid in the transition away from the old format.  Eventually, this additional layer will be removed.');
						para.appendChild(text);
						document.getElementById("legendNotesDiv").style.display="block";
					}

          else if (name == "Bicycle_Trails") {
            var text = document.createTextNode("From January 2017 to July 2018, TxDOT's Bicycle Tourism Trails Study examined the potential for a statewide network of long-distance bicycle routes to accommodate tourism and local needs. This feature class shows the Example Network segments, which may indicate future demand for long distance and local bicycling. Example Network routes represent an application of the qualitative and quantitative criteria established as part of the study. A more thorough analysis of local conditions and extensive stakeholder engagement is needed to advance development of any route.");
					  para.appendChild(text);
            var linkText = document.createTextNode("For more information, please consult TxDOT's Bicycle Tourism Trails Study Final Report");
					  link.appendChild(linkText);
					  link.href = "https://www.txdot.gov/inside-txdot/modes-of-travel/bicycle/plan-design/tourism-study.html";
					  document.getElementById("legendNotesDiv").style.display="block";
          }

          else if (name == "INRIX_Traffic") {
            // Create legend using html5 canvas
						var text = document.createTextNode('Data provided by INRIX Traffic');
            var br = document.createElement('br');
            var canv = document.createElement('canvas');
            canv.width = 225;
            canv.height = 130;
            var ctx = canv.getContext("2d");
            ctx.font = '11px sans-serif';
            ctx.lineWidth = 4;
            // Black
            ctx.beginPath();
            ctx.moveTo(2,120);
            ctx.lineTo(35,120);
            ctx.strokeStyle='#646464';
            ctx.stroke();
            ctx.fillText('Most Congested', 45, 122.5);
            // Red
            ctx.beginPath();
            ctx.moveTo(2,90);
            ctx.lineTo(35,90);
            ctx.strokeStyle='#FD6464';
            ctx.stroke();
            // Yellow
            ctx.beginPath();
            ctx.moveTo(2,60);
            ctx.lineTo(35,60);
            ctx.strokeStyle='#F9F960';
            ctx.stroke();
            // Green
            ctx.beginPath();
            ctx.moveTo(2,30);
            ctx.lineTo(35,30);
            ctx.strokeStyle='#78B778';
            ctx.stroke();
            ctx.fillText('Least Congested', 45, 32.5);
            ctx.fillText('Live Traffic', 2, 10);
            // Create legend div for INRIX
            var inrixDiv = document.createElement('div');
            inrixDiv.id='inrixDiv';
            inrixDiv.appendChild(canv);
            inrixDiv.appendChild(br);
            inrixDiv.appendChild(text);
            inrixDiv.appendChild(br);
            inrixDiv.style.display="block";
            inrixDiv.style.paddingBottom="20px";
            document.getElementById('legendDiv').insertAdjacentElement('afterend',inrixDiv);
					}

					else {
						div.innerHTML = '';
						theLegend.refresh();
					}
				});

				theLegend.refresh();
			}
			else {
				var div = document.getElementById("legendDiv");
				var divDesc = document.getElementById("legendDescDiv");
				div.innerHTML = 'Select an overlay from the Maps tab to see its legend.';
				divDesc.innerHTML = '';
				document.getElementById("legendNotesDiv").style.display="none";
			}
		}

    // Remove INRIX legend on tab change
    function clearInrixLegend() {
      if (!!document.getElementById('inrixDiv')){
        document.getElementById('inrixDiv').remove();
      }
    }

		function logCoords() {
		  if (document.getElementById("measureTab").style.display=="block"||document.getElementById("sketchTab").style.display=="block") {
			xPointArray.push([Number(globalX),Number(globalY)]);
			calculateDistance();
		  }
		}

        function calcMessage(msg) {
            // DISPLAY FOR USER
            document.getElementById("rteNM").innerHTML = "";
            document.getElementById("calculatedDFO").innerHTML = msg;
            document.getElementById("beginDFO").innerHTML = "";
            document.getElementById("endDFO").innerHTML = "";
            document.getElementById("long").innerHTML = msg;
            document.getElementById("lat").innerHTML = msg;

            document.getElementById("csNBR").innerHTML = "";
            document.getElementById("calculatedMPT").innerHTML = msg;
            document.getElementById("beginMPT").innerHTML = "";
            document.getElementById("endMPT").innerHTML = "";

            document.getElementById("refMarker").innerHTML = msg
            document.getElementById("offset").innerHTML = msg;
        }

        function identRouteForM(event) { // -mw
            if (document.getElementById("lrsTab").style.display=="block") {
                calcMessage("Calculating...");

                queryTaskDFO = new esri.tasks.QueryTask("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0");
                queryTaskMPT = new esri.tasks.QueryTask("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0");

                queryM = new esri.tasks.Query();
                queryM.returnGeometry = true;
                queryM.outFields = ["*"];
                queryM.geometry = event.mapPoint;

                mapPoint = event.mapPoint;

                var point = event.mapPoint;
                var pxWidth = map.extent.getWidth() / map.width;
                var padding = 15 * pxWidth;
                var newGeom = new esri.geometry.Extent({
                    "xmin": point.x - padding,
                    "ymin": point.y - padding,
                    "xmax": point.x + padding,
                    "ymax": point.y + padding,
                    "spatialReference": point.spatialReference
                });

                queryM.geometry = newGeom;
                queryTaskDFO.execute(queryM, getSegmentWithDFOs);
                queryTaskMPT.execute(queryM, getSegmentWithMPTs);
            }
        }

        function getSegmentWithDFOs(results) {
            if (document.getElementById("lrsTab").style.display=="block") {
                map.graphics.clear();
                if (results.features.length == 0) {
                    alert("Please click closer to a line.");
                    calcMessage("");
                    // map.graphics.clear();
                    return;
                }

                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        if (isIE) { //Handle hot IE garbage
                            gidWithMeasuresGeom = JSON.parse(xmlhttp.response);
                        }
                        else {
                            gidWithMeasuresGeom = xmlhttp.response;
                        }
                        getPointM(results);
                    }
                };

                var serviceString = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0";
                var paraString = "/query?f=json&where=GID=" + results.features[0].attributes.GID + "&returnGeometry=true&returnM=true&outSR=102100";
                var queryString = serviceString + paraString;
                xmlhttp.open("GET", queryString, true);
                xmlhttp.responseType = 'json';
                xmlhttp.send();
            }
        }
        function getSegmentWithMPTs(results) {
            if (document.getElementById("lrsTab").style.display=="block") {
                if (results.features.length == 0) {
                    document.getElementById("csNBR").innerHTML = "None Selected";
                    document.getElementById("calculatedMPT").innerHTML = "";
                    document.getElementById("beginMPT").innerHTML = "";
                    document.getElementById("endMPT").innerHTML = "";
                    return;
                }

                // map.graphics.clear();
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                        if (isIE) { //Handle hot IE garbage
                            gidWithMeasuresGeomMPT = JSON.parse(xmlhttp.response);
                        }
                        else {
                            gidWithMeasuresGeomMPT = xmlhttp.response;
                        }
                        getPointMforMPT(results);
                    }
                };
                var serviceString = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0";
                var paraString = "/query?f=json&where=GID=" + results.features[0].attributes.GID + " AND CTRL_SECT_NBR='" + results.features[0].attributes.CTRL_SECT_NBR + "'&returnGeometry=true&returnM=true&outSR=102100";
                var queryString = serviceString + paraString;
                xmlhttp.open("GET", queryString, true);
                xmlhttp.responseType = 'json';
                xmlhttp.send();
            }
        }

        function getPointM(results) {
            var attrs = results.features[0].attributes;
            var calculatedM = 0;
            var unitsM;
            var displayM;
            var offsetArray=[];
            var firstIntersectingPoint = findNearestCoordinate(mapPoint);
            drawPoint(firstIntersectingPoint,"#FF0000");
            var firstIntersectingCoord = geometryEngine.nearestVertex(gidWithMeasuresGeom.features[featurePartIndex].geometry, firstIntersectingPoint);
            var vertexIndex = firstIntersectingCoord.vertexIndex;
            var maxVertex = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0].length - 1;

            if (vertexIndex == 0) {
                var coord2 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var point2M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;
                calculatedM = point2M + geoMileValue;
            }

            if (vertexIndex == maxVertex) {
                var coord2 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var point2M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;
                calculatedM = point2M - geoMileValue;
            }

            if (vertexIndex > 0 && vertexIndex < maxVertex) {
                var coord1 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex - 1];
                var coord2 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var coord3 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex + 1];

                var thePoint1 = new esri.geometry.Point([coord1[0], coord1[1]], new SpatialReference({
                    wkid: 3857
                }));
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var thePoint3 = new esri.geometry.Point([coord3[0], coord3[1]], new SpatialReference({
                    wkid: 3857
                }));

                var firstTestSegment = createTwoPointPolyline(thePoint1, thePoint2);
                var secondTestSegment = createTwoPointPolyline(thePoint2, thePoint3);

                var intersectsFirstSegment = geometryEngine.intersects(firstIntersectingPoint, firstTestSegment);
                var intersectsSecondSegment = geometryEngine.intersects(firstIntersectingPoint, secondTestSegment);


                var point1M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex - 1][2];
                var point2M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var point3M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex + 1][2];

                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;

                if (intersectsFirstSegment) {
                    if (point1M > point2M) {
                        calculatedM = point2M + geoMileValue;
                    } else {
                        calculatedM = point2M - geoMileValue;
                    }
                } else {
                    if (point3M > point2M) {
                        calculatedM = point2M + geoMileValue;
                    } else {
                        calculatedM = point2M - geoMileValue;
                    }
                }
            }
            displayM = Math.round(calculatedM * 1000) / 1000;
            // drawPoint(firstIntersectingPoint,"#FF0000");
            // beep();

            //will be separate function in next release
            var markerInfo = new Object();
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
                var trmWithGeom;
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    if (isIE) { //Handle hot IE garbage
                        trmWithGeom = JSON.parse(xmlhttp.response);
                    }
                    else {
                        trmWithGeom = xmlhttp.response;
                    }
                    for (var i = 0; i< trmWithGeom.features.length; i++){
                        var mrkr = trmWithGeom.features[i].attributes;
                        var tstPt = new esri.geometry.Point([trmWithGeom.features[i].geometry.x, trmWithGeom.features[i].geometry.y],new SpatialReference({
                            wkid:3857
                        }));
                        markerInfo[i] = getPointMforMarker(results, mrkr, tstPt, calculatedM);
                        offsetArray.push(markerInfo[i]);
                    }
                    calcOffset(offsetArray);
                }
            }
            //query trm service in 4 mi buffer at point snapped to txdot roadways geom.
            var serviceString = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/TxDOT_Reference_Markers/FeatureServer/0";
            var paraString = "/query?f=json&where=GID='"+attrs.GID+"'&geometry="+firstIntersectingPoint.x+","+firstIntersectingPoint.y+"&geometryType=esriGeometryPoint&inSR=102100&distance=4&units=esriSRUnit_StatuteMile&outFields=MRKR_NBR,DFO,GID&returnGeometry=true&outSR=102100";
            var queryString = serviceString + paraString;
            xmlhttp.open("GET", queryString, true);
            xmlhttp.responseType = 'json';
            xmlhttp.send();

            // SET READOUT VALUES
            document.getElementById("rteNM").innerHTML = attrs.RTE_NM;
            document.getElementById("calculatedDFO").innerHTML = displayM;
            document.getElementById("beginDFO").innerHTML = attrs.BEGIN_DFO;
            document.getElementById("endDFO").innerHTML = attrs.END_DFO;
            document.getElementById("long").innerHTML = globalX;
            document.getElementById("lat").innerHTML = globalY;
        }

        function drawPoint(thePoint) {
            var thePoint = new esri.geometry.Point([thePoint.x, thePoint.y], new SpatialReference({
                wkid: 3857
            }));
            //Point style
            var symbol = new esri.symbol.SimpleMarkerSymbol();
            symbol.style = esri.symbol.SimpleMarkerSymbol.STYLE_X;
            symbol.setSize(14);

            map.graphics.add(new esri.Graphic(thePoint, symbol));

            //Label
            // var label_symbol = new esri.symbol.TextSymbol(theLabel);
            // label_symbol.setColor(new esri.Color(theColor));
            // label_symbol.setFont(new esri.symbol.Font("12pt").setWeight(esri.symbol.Font.WEIGHT_BOLD));
            // label_symbol.font.setFamily("Calibri");
            // label_symbol.setHaloSize(1);
            // label_symbol.setOffset(10,10);
            // label_symbol.setHaloColor(new Color([255,255,255,0.75]));
            //
            // var currentScale = map.getScale();
            // var labelOffset = Math.round(currentScale / 350);
            //
            // //Location for the label
            // var labelLocation = new esri.geometry.Point(thePoint.x, thePoint.y, new SpatialReference({
            //     wkid: 3857
            // }));
            // // var labelLocation = new esri.geometry.Point([thePoint.x, thePoint.y + labelOffset], new SpatialReference({
            // //     wkid: 3857
            // // }));
            // map.graphics.add(new esri.Graphic(labelLocation, label_symbol));
        }

        function createTwoPointPolyline(point1, point2) {
            var newPolyline = new esri.geometry.Polyline(new esri.SpatialReference({
                wkid: 3857
            }));
            newPolyline.type = "polyline";
            var tmpAttLine = [];
            tmpAttLine.push(point1);
            tmpAttLine.push(point2);
            newPolyline.addPath(tmpAttLine);
            return newPolyline;
        }

        function findNearestCoordinate(point) {
            var shortestDistance = 20000;
            var firstIntersectingPoint;
            var firstIntersectingPointTemp;
            featurePartIndex = 0;

            for (var h = 0; h < gidWithMeasuresGeom.features.length; h++) {
                firstIntersectingPointTemp = geometryEngine.nearestCoordinate(gidWithMeasuresGeom.features[h].geometry, point);
                if (firstIntersectingPointTemp.distance < shortestDistance) {
                    shortestDistance = firstIntersectingPointTemp.distance;
                    firstIntersectingPoint = firstIntersectingPointTemp;
                    featurePartIndex = h;
                }
            }
            var returnPoint = new esri.geometry.Point([firstIntersectingPoint.coordinate.x, firstIntersectingPoint.coordinate.y], new SpatialReference({
                wkid: 3857
            }));
            return returnPoint;
        }
        function findNearestCoordinateMPT(point) {
            var shortestDistance = 20000;
            var firstIntersectingPoint;
            var firstIntersectingPointTemp;
            featurePartIndex = 0;

            for (var h = 0; h < gidWithMeasuresGeomMPT.features.length; h++) {
                firstIntersectingPointTemp = geometryEngine.nearestCoordinate(gidWithMeasuresGeomMPT.features[h].geometry, point);
                if (firstIntersectingPointTemp.distance < shortestDistance) {
                    shortestDistance = firstIntersectingPointTemp.distance;
                    firstIntersectingPoint = firstIntersectingPointTemp;
                    featurePartIndex = h;
                }
            }
            var returnPoint = new esri.geometry.Point([firstIntersectingPoint.coordinate.x, firstIntersectingPoint.coordinate.y], new SpatialReference({
                wkid: 3857
            }));
            return returnPoint;
        }

        function getPointMforMPT(results) {
            var attrs = results.features[0].attributes;
            var calculatedM = 0;
            var unitsM;
            var displayM;
            var firstIntersectingPoint = findNearestCoordinateMPT(mapPoint);
            var firstIntersectingCoord = geometryEngine.nearestVertex(gidWithMeasuresGeomMPT.features[featurePartIndex].geometry, firstIntersectingPoint);
            var vertexIndex = firstIntersectingCoord.vertexIndex;
            var maxVertex = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0].length - 1;

            if (vertexIndex == 0) {
                var coord2 = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var point2M = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;
                calculatedM = point2M + geoMileValue;
            }

            if (vertexIndex == maxVertex) {
                var coord2 = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var point2M = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;
                calculatedM = point2M - geoMileValue;
            }

            if (vertexIndex > 0 && vertexIndex < maxVertex) {
                var coord1 = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex - 1];
                var coord2 = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var coord3 = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex + 1];

                var thePoint1 = new esri.geometry.Point([coord1[0], coord1[1]], new SpatialReference({
                    wkid: 3857
                }));
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var thePoint3 = new esri.geometry.Point([coord3[0], coord3[1]], new SpatialReference({
                    wkid: 3857
                }));

                var firstTestSegment = createTwoPointPolyline(thePoint1, thePoint2);
                var secondTestSegment = createTwoPointPolyline(thePoint2, thePoint3);

                var intersectsFirstSegment = geometryEngine.intersects(firstIntersectingPoint, firstTestSegment);
                var intersectsSecondSegment = geometryEngine.intersects(firstIntersectingPoint, secondTestSegment);


                var point1M = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex - 1][2];
                var point2M = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var point3M = gidWithMeasuresGeomMPT.features[featurePartIndex].geometry.paths[0][vertexIndex + 1][2];

                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;

                if (intersectsFirstSegment) {
                    if (point1M > point2M) {
                        calculatedM = point2M + geoMileValue;
                    } else {
                        calculatedM = point2M - geoMileValue;
                    }
                } else {
                    if (point3M > point2M) {
                        calculatedM = point2M + geoMileValue;
                    } else {
                        calculatedM = point2M - geoMileValue;
                    }
                }
            }
            displayM = Math.round(calculatedM * 1000) / 1000;

            document.getElementById("csNBR").innerHTML = attrs.CTRL_SECT_NBR;
            document.getElementById("calculatedMPT").innerHTML = displayM;
            document.getElementById("beginMPT").innerHTML = attrs.BEGIN_MPT;
            document.getElementById("endMPT").innerHTML = attrs.END_MPT;

        }

        function getPointMforMarker(results, mrkr, tstPt, calcM){
            var attrs = results.features[0].attributes;
            var calcRefMarkerM = 0;
            var unitsM;
            var displayM;
            var firstIntersectingPoint = findNearestCoordinate(tstPt);//need to run this to reset featurePartIndex
            var firstIntersectingCoord = geometryEngine.nearestVertex(gidWithMeasuresGeom.features[featurePartIndex].geometry, firstIntersectingPoint);
            var vertexIndex = firstIntersectingCoord.vertexIndex;
            var maxVertex = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0].length - 1;

            if (vertexIndex == 0) {//first vertex
                var coord2 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var point2M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;
                calcRefMarkerM = point2M + geoMileValue;
            }

            if (vertexIndex == maxVertex) {//last vertex
                var coord2 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var point2M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;
                calcRefMarkerM = point2M - geoMileValue;
            }

            if (vertexIndex > 0 && vertexIndex < maxVertex) {//not first or last vertex
                var coord1 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex - 1];
                var coord2 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex];
                var coord3 = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex + 1];

                var thePoint1 = new esri.geometry.Point([coord1[0], coord1[1]], new SpatialReference({
                    wkid: 3857
                }));
                var thePoint2 = new esri.geometry.Point([coord2[0], coord2[1]], new SpatialReference({
                    wkid: 3857
                }));
                var thePoint3 = new esri.geometry.Point([coord3[0], coord3[1]], new SpatialReference({
                    wkid: 3857
                }));

                var firstTestSegment = createTwoPointPolyline(thePoint1, thePoint2);
                var secondTestSegment = createTwoPointPolyline(thePoint2, thePoint3);

                var intersectsFirstSegment = geometryEngine.intersects(firstIntersectingPoint, firstTestSegment);
                var intersectsSecondSegment = geometryEngine.intersects(firstIntersectingPoint, secondTestSegment);


                var point1M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex - 1][2];
                var point2M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex][2];
                var point3M = gidWithMeasuresGeom.features[featurePartIndex].geometry.paths[0][vertexIndex + 1][2];

                var geoMeterLength = geometryEngine.geodesicLength(createTwoPointPolyline(thePoint2, firstIntersectingPoint), 9001);
                var geoMileValue = ((geoMeterLength / 1609.344) * 1000) / 1000;

                if (intersectsFirstSegment) {
                    if (point1M > point2M) {
                        calcRefMarkerM = point2M + geoMileValue;
                    } else {
                        calcRefMarkerM = point2M - geoMileValue;
                    }
                } else {
                    if (point3M > point2M) {
                        calcRefMarkerM = point2M + geoMileValue;
                    } else {
                        calcRefMarkerM = point2M - geoMileValue;
                    }
                }
            }

            var dist = Math.round((calcM - calcRefMarkerM) * 1000) / 1000;
            return {"mrkr": mrkr, "calcRefMarkerM": calcRefMarkerM, "dist": dist};

        }
        // implement logic for which marker to choose
        function calcOffset(array){
            if (array.length == 0) {
                document.getElementById("refMarker").innerHTML = "None Selected";
                document.getElementById("offset").innerHTML = "";
                return;
            }
            var offsetArray = array;
            var compareArray = [];
            var posCount = 0;
            for (var i=0; i<offsetArray.length; i++){
                // setting tolerance and return marker at zero
                if (offsetArray[i].dist <= 0.0005 && offsetArray[i].dist >= -0.0005) {
                    offsetArray[i].dist = 0;
                    // return {"Marker": offsetArray[i].mrkr.MRKR_NBR, "Offset": offsetArray[i].dist}
                    document.getElementById("refMarker").innerHTML = offsetArray[i].mrkr.MRKR_NBR;
                    document.getElementById("offset").innerHTML = offsetArray[i].dist;
                    return;
                }
                // counting number of positive displacement values
                if (offsetArray[i].dist > 0){
                    posCount++
                }
                compareArray.push({"Marker": offsetArray[i].mrkr.MRKR_NBR, "Offset": offsetArray[i].dist});
            }
            // if all values negative, push to temp array and get higest then return marker and negative displacement
            if (posCount == 0){
                var tempArray=[];
                for (var i=0; i<compareArray.length; i++){
                    tempArray.push(compareArray[i].Offset);
                }
                for (var i=0; i<compareArray.length; i++){
                    if (compareArray[i].Offset == Math.max.apply(null, tempArray)){
                        // console.log("Marker = "+compareArray[i].Marker);
                        // console.log("Offset = "+compareArray[i].Offset);
                        // return compareArray[i];
                        document.getElementById("refMarker").innerHTML = compareArray[i].Marker;
                        document.getElementById("offset").innerHTML = compareArray[i].Offset;
                    }
                }

            }
            else if (posCount > 0){
                //get the loweset positive value
                var tempArray=[];
                for (var i=0; i<compareArray.length; i++){
                    if (compareArray[i].Offset > 0){
                        tempArray.push(compareArray[i].Offset);
                    }
                }
                for (var i=0; i<compareArray.length; i++){
                    if (compareArray[i].Offset == Math.min.apply(null, tempArray)){
                        // console.log("Marker = "+compareArray[i].Marker);
                        // console.log("Offset = +"+compareArray[i].Offset);
                        // return compareArray[i];
                        document.getElementById("refMarker").innerHTML = compareArray[i].Marker;
                        document.getElementById("offset").innerHTML = "+"+compareArray[i].Offset;
                    }
                }
            }
            else {
                document.getElementById("refMarker").innerHTML = "";
                document.getElementById("offset").innerHTML = "";
            }
        }

		// Clear graphic line on Measure Tab when a new line is started
		function clearMeasuredLineGraphic(){
			if (document.getElementById("measureTab").style.display=="block"){
				if (document.getElementById("mapDiv_graphics_layer").style.display=="block"){
					if (xPointArray.length<2) {
						document.getElementById("measuredDistance").innerHTML = "0.00";
            currentMeasure = 0;
						map.graphics.clear();
					}
				}
			}
		}

		function newCoords() {
		  if (document.getElementById("measureTab").style.display=="block"||document.getElementById("sketchTab").style.display=="block") {
  			if (xPointArray.length>=1) {
  			   polyline = new Polyline();
  			   polyline.addPath([xPointArray[xPointArray.length - 1],[Number(globalX),Number(globalY)]]);

           var thisMeasured;
           if (measureUnits=="Miles") {
             thisMeasured = geodesicUtils.geodesicLengths([polyline], Units.MILES);
           } else if (measureUnits=="Kilometers") {
             thisMeasured = geodesicUtils.geodesicLengths([polyline], Units.KILOMETERS);
           } else if (measureUnits=="Feet") {
             thisMeasured = geodesicUtils.geodesicLengths([polyline], Units.FEET);
           } else {
             thisMeasured = geodesicUtils.geodesicLengths([polyline], Units.METERS);
           }

   				 var piece = Math.round(thisMeasured*1000)/1000
   				 var potential = currentMeasure + piece;
   				 document.getElementById("measuredDistance").innerHTML = Math.round(potential*1000)/1000 + " " + measureUnits;
  			}
		  }
		}

		function unitsHandler() {
      if (measureUnits=="Miles") {
        theDistMeasured = geodesicUtils.geodesicLengths([polyline], Units.MILES);
      } else if (measureUnits=="Kilometers") {
        theDistMeasured = geodesicUtils.geodesicLengths([polyline], Units.KILOMETERS);
      } else if (measureUnits=="Feet") {
        theDistMeasured = geodesicUtils.geodesicLengths([polyline], Units.FEET);
      } else {
        theDistMeasured = geodesicUtils.geodesicLengths([polyline], Units.METERS);
      }

      document.getElementById("measuredDistance").innerHTML = Math.round(theDistMeasured*1000)/1000 + " " + measureUnits;
      currentMeasure = Math.round(theDistMeasured*1000)/1000;
		}

		function calculateDistance() {
		   if (xPointArray.length>1) {
			   polyline = new Polyline();
			   polyline.addPath(xPointArray);
			   unitsHandler();
			}
		}

		on(dom.byId("clearMeasure"), "click", clearMeasure);
		function clearMeasure() {
			map.graphics.clear();
			deActivateTool("POLYLINE");
			theDistMeasured=0;
			xPointArray.length=0;
			document.getElementById("measuredDistance").innerHTML = "0.00";
      resetReadout();
			currentMeasure=0;
			deLength=0;
			polyline = {};
	    activateTool("POLYLINE");
		}

    on(dom.byId("resetReadout"), "click", resetReadout);
    function resetReadout() {
        map.graphics.clear();
        document.getElementById("rteNM").innerHTML = "";
        document.getElementById("csNBR").innerHTML = "";
        document.getElementById("beginDFO").innerHTML = "";
        document.getElementById("endDFO").innerHTML = "";
        document.getElementById("beginMPT").innerHTML = "";
        document.getElementById("endMPT").innerHTML = "";
        document.getElementById("refMarker").innerHTML = "";
        document.getElementById("offset").innerHTML = "";
        document.getElementById("calculatedDFO").innerHTML = "";
        document.getElementById("calculatedMPT").innerHTML = "";
        document.getElementById("long").innerHTML = "";
        document.getElementById("lat").innerHTML = "";
    }

		on(dom.byId("btnCopy"), "click", copyText);
		function copyText(){
			document.querySelector("#coordDisp").focus();
      document.execCommand("selectAll",false,null);
  		document.execCommand("copy");
		}

    on(dom.byId("btnCopyURL"), "click", copyURL);
		function copyURL(){
      document.querySelector("#linkDisp").focus();
      document.execCommand("selectAll",false,null);
      document.execCommand("copy");
		}

		dojo.query(".MeasureUnits").forEach(function (result){
				on(result, "click", changeUnits);
		});

		function changeUnits(event) {
				measureUnits=event.target.value;
				unitsHandler();
		}

		function createToolbar() {
		  toolbar = new Draw(map);
		  toolbar.on("draw-complete", addToMap);
		}

		function activateTool(theTool) {
			var tool;
			if (theTool == "POLYLINE") {
				tool = Draw.POLYLINE;
			}
		 	map.setInfoWindowOnClick(false);
		 	toolbar.activate(tool);
		  	map.hideZoomSlider();
		  	search.hide();
		}

		function deActivateTool(theTool) {
		  	var tool;
			if (theTool == "POLYLINE") {
				tool = Draw.POLYLINE;
			}
			map.setInfoWindowOnClick(true);
		  	toolbar.deactivate(tool);
		  	map.showZoomSlider();
		  	search.show();
		}

		function addToMap(evt) {
			var lineColorCode = "#D80000";
			var lineColor = new Color(lineColorCode);
			var theLine = new CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, lineColor, 3, CartographicLineSymbol.CAP_ROUND, CartographicLineSymbol.JOIN_MITER, 5);
			var defaultSymbol = new SimpleFillSymbol("solid", theLine, null);
			var graphic = new Graphic(evt.geometry,defaultSymbol);
			map.graphics.add(graphic);

			if (activeTab=="sketchTab"){
				deLength = parseFloat(deLength) + parseFloat(theDistMeasured);
			}

			theDistMeasured=0;
			xPointArray.length=0;
			currentMeasure=0;
		}

		function showCoordinates(evt) {
		  var mp = new webMercatorUtils.webMercatorToGeographic(evt.mapPoint);
		  globalX = mp.x.toFixed(6);
		  globalY = mp.y.toFixed(6);
		  var coords = mp.y.toFixed(6) + ", " + mp.x.toFixed(6);
		  document.getElementById("info2").innerHTML = coords;
		}

		function showZoom(evt) {
      var zoomLev2 = map.getZoom(evt)+1 // fix zoom level display -mw;
      document.getElementById("info").innerHTML = "Level:  " + zoomLev2 + ", ";
    }

		dojo.query(".Basemaps").forEach(function (result){
				on(result, "click", changeBaseMap);
		});

    // the following 2 functions prevent basemap from zoom past 21 on imagery
    // using 19 due to vector tiles setting wrong scale
    function preventZoomOnImagery(evt) {
      var basemap = map.getLayer(map.layerIds[0]);
      if (basemap.id == "layer2"){
        imageryZoomOut();
      };
    }
    function imageryZoomOut() {
      if (map.getZoom()>19){
        console.log("Zoom Lv: "+map.getZoom()+"; Back Off!");
        map.setLevel(19);
      }
    }
		function changeBaseMap(event) {
			getBasemapLayers();
			clearStyle("tocMaps");
			var newMap = event.target.id;
			document.getElementById(newMap).style.color='red';
			map.removeLayer(layer0);
			if (newMap=="TxDOT") {
				map.addLayer(TxDOTVectorTileLayer);
				document.getElementById("credits").innerHTML = "TxDOT, TPP-GIS";
			}
			if (newMap=="Google") {
        imageryZoomOut(); // prevent zoom past 21 on imagery -mw
				map.addLayer(google);
				document.getElementById("credits").innerHTML = "Texas Imagery Service";
			}
			if (newMap=="txdotLightGray") {
				txdotLightGray = new VectorTileLayer("https://www.arcgis.com/sharing/rest/content/items/507a9905e7154ce484617c7327ee8bc4/resources/styles/root.json?f=pjson");
				map.addLayer(txdotLightGray);
				document.getElementById("credits").innerHTML = "TxDOT, TPP-GIS";
			}
            if (newMap=="txdotDarkGray") {
				txdotDarkGray = new VectorTileLayer("https://www.arcgis.com/sharing/rest/content/items/4bd376c56f314bc5a36446630db604a6/resources/styles/root.json?f=pjson");
				map.addLayer(txdotDarkGray);
				document.getElementById("credits").innerHTML = "TxDOT, TPP-GIS";
			}
			if (newMap=="esriStreets") {
				esriStreets = new VectorTileLayer("https://www.arcgis.com/sharing/rest/content/items/a60a37a27cc140ddad15f919cd5a69f2/resources/styles/root.json?f=pjson");
				map.addLayer(esriStreets);
				document.getElementById("credits").innerHTML = "Esri";
			}
			if (newMap=="openStreetMap") {
				osmLayer = new OpenStreetMapLayer();
       	 		map.addLayer(osmLayer);
       	 		document.getElementById("credits").innerHTML = " OpenStreetMap contributors";
			}
      // make sure INRIX traffic layer above other basemaps if selected
      if (inrixTrafficLyr){
        map.reorderLayer(inrixTrafficLyr,1);
      }

			if (activeOverlay) {
				activeOverlay.show();
			}
		}

		dojo.query(".Tabs").forEach(function (result){
				on(result, "click", changeTab);
		});

    function changeTab(event) {
      if (activeTab == 'queryTab') {
        resetQuery();
      }

			var ID = event.target.id;
			if (ID == 'tcMap') {
				activeTab = 'mapTab';
			}
			else if (ID == 'tcLRS') {
				activeTab = 'lrsTab';
			}
			else if (ID == 'tcMeasure') {
				activeTab = 'measureTab';
			}
			else if (ID == 'tcQuery') {
				activeTab = 'queryTab';
			}
			else if (ID == 'tcSketch') {
				activeTab = 'sketchTab';
			}
			else if (ID == 'tcLegend') {
				activeTab = 'legendTab';
			}
			else if (ID == 'tcAbout') {
				activeTab = 'aboutTab';
        document.getElementById('btnReleaseNotes').innerHTML = appVersion;
			}

			map.graphics.clear();
			map.infoWindow.hide();
			clearMeasure();
      document.getElementById("mapDiv_container").style.cursor = "default"; // reset cursor to default -mw

			if (activeTab=="queryTab"||activeTab=="sketchTab") {
				hideAllOverlays();
        activeOverlaysArray=[];
				document.getElementById("CLEAR").style.color = "red";
				document.getElementById("radMile").checked = true;
        clearInrixLegend();
			}

			clearStyle("tcTabs");
			document.getElementById("mapTab").style.display="none";
			document.getElementById("measureTab").style.display="none";
			document.getElementById("queryTab").style.display="none";
			document.getElementById("sketchTab").style.display="none";
			document.getElementById("legendTab").style.display="none";
			document.getElementById("aboutTab").style.display="none";
      document.getElementById("lrsTab").style.display="none";
			document.getElementById(activeTab).style.display="block";
			document.getElementById(ID).style.color='white';
			document.getElementById(ID).style.backgroundColor='#143c5c';

			if (activeTab=="measureTab"||activeTab=="sketchTab") {
			  measureUnits="Miles";
        document.getElementById("radMile").checked = true;
			  theDistMeasured=0;
			  xPointArray.length=0;
			  currentMeasure=0;
			  deLength=0;
			  polyline = {};
	      activateTool("POLYLINE");
  			home.hide();
        clearInrixLegend();
			}
			else {
			  deActivateTool("POLYLINE");
			  home.show();
			}

			if (activeTab=="legendTab") {
				createLegend();
			}
      if (activeTab=="lrsTab") { // adding controls for lrs tab -mw
        map.setInfoWindowOnClick(false);
        map.hideZoomSlider();
        search.hide();
        home.hide();
        document.getElementById("mapDiv_container").style.cursor = "crosshair";
      }
		}

		function panTo(theX,theY) {
		  	var thePt = new Point(theX,theY, new SpatialReference({ wkid: 4269 }));
		  	map.centerAt(webMercatorUtils.geographicToWebMercator(thePt));
		  	//onLoad();
		}

		function zoomTo(event) {
			var params = event.target.id;
			var paramsList = params.split(',');
			var theX = paramsList[0];
			var theY = paramsList[1];
			var theZ = paramsList[2];
		  	var thePt = new Point(theX,theY, new SpatialReference({ wkid: 4269 }));
		  	map.centerAndZoom(webMercatorUtils.geographicToWebMercator(thePt),theZ);
		  	//onLoad();
		}

		function clearStyle(theTable) {
		  var tcTbl = document.getElementById(theTable);
		  var tds = tcTbl.getElementsByTagName("td");

	      for(var i = 0; i < tds.length; i++) {
	        tds[i].style.color="black";
    			if (theTable=="tcTabs") {
    				tds[i].style.backgroundColor="white";
    			}
	      }
		}

		function scaleDependentQueries() {
      //Always for Roadways
      if (map.getZoom()<8) {
           roadwaysLyr.setDefinitionExpression("RTE_PRFX = 'IH' AND RDBD_TYPE = 'Single Roadbed'");
           roadwaysLyr.setVisibility(true);
      }
      if (map.getZoom()==8) {
           roadwaysLyr.setDefinitionExpression("RTE_PRFX IN ('IH', 'US') AND RDBD_TYPE = 'Single Roadbed'");
           roadwaysLyr.setVisibility(true);
      }
      if (map.getZoom()==9) {
           roadwaysLyr.setDefinitionExpression("RTE_PRFX IN ('IH', 'US', 'SH', 'SL', 'FM', 'RM') AND RDBD_TYPE = 'Single Roadbed'");
           roadwaysLyr.setVisibility(true);
      }
      if (map.getZoom()>9&&map.getZoom()<13) {
           roadwaysLyr.setDefinitionExpression("RTE_PRFX NOT IN ('CS', 'PR') AND RDBD_TYPE = 'Single Roadbed'");
           roadwaysLyr.setVisibility(true);
      }
      if (map.getZoom()>12) {
           roadwaysLyr.setDefinitionExpression("");
           roadwaysLyr.setVisibility(true);
      }

      //Only if overlay is active
			if (activeOverlay) {
				if (aadtLyr) {
					aadtLyr.setDefinitionExpression("zLevel<" + (map.getZoom() + 1));
				}

				if (FCLyr) {
					if (map.getZoom()<9) {
				       FCLyr.setDefinitionExpression("RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'");
					}
					if (map.getZoom()>8&&map.getZoom()<11) {
				       FCLyr.setDefinitionExpression("(RTE_PRFX IN ('IH', 'US') OR F_SYSTEM IN (1,2,3)) AND RDBD_TYPE = 'KG'");
					}
          if (map.getZoom()>10&&map.getZoom()<13) {
             FCLyr.setDefinitionExpression("RDBD_TYPE = 'KG'");
          }
					if (map.getZoom()>=13) {
				       FCLyr.setDefinitionExpression("");
					}
				}

				if (MarkerLyr) {
					if (map.getZoom()<9) {
						MarkerLyr.setDefinitionExpression("RTE_PRFX='IH' AND MRKR_NBR LIKE '%25'");
					}
					if (map.getZoom()>8&&map.getZoom()<11) {
				       MarkerLyr.setDefinitionExpression("(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0'))");
					}
					if (map.getZoom()>10&&map.getZoom()<13) {
				       MarkerLyr.setDefinitionExpression("(RTE_PRFX='IH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='US' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SH' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5')) or (RTE_PRFX='SL' AND (MRKR_NBR LIKE '%0' OR MRKR_NBR LIKE '%5'))");
					}
					if (map.getZoom()>12) {
				       MarkerLyr.setDefinitionExpression("");
					}
				}

				if (controlSectionLyr) {
					if (map.getZoom()<9) {
				       controlSectionLyr.setDefinitionExpression("RTE_PRFX='IH'");
				       labelLayerCS.hide();
					}
					if (map.getZoom()>8&&map.getZoom()<10) {
				       controlSectionLyr.setDefinitionExpression("(RTE_PRFX='IH' or RTE_PRFX='US')");
				       labelLayerCS.hide();
					}
					if (map.getZoom()>9&&map.getZoom()<11) {
				       controlSectionLyr.setDefinitionExpression("(RTE_PRFX='IH' or RTE_PRFX='SH' or RTE_PRFX='US' or RTE_PRFX='SL')");
				       labelLayerCS.show();
					}
					if (map.getZoom()>10&&map.getZoom()<13) {
				       controlSectionLyr.setDefinitionExpression("RTE_PRFX NOT IN ('CS', 'FC', 'CR', 'FD', 'PR')");
				       labelLayerCS.show();
					}
					if (map.getZoom()>12&&map.getZoom()<15) {
				       controlSectionLyr.setDefinitionExpression("RTE_PRFX <> 'CS'");
				       labelLayerCS.show();
					}
					if (map.getZoom()>14) {
				       controlSectionLyr.setDefinitionExpression("");
				       labelLayerCS.show();
					}
				}

				if (speedLimitLyr) {
					if (map.getZoom()<9) {
				       speedLimitLyr.setDefinitionExpression("RTE_PRFX ='IH' AND RDBD_TYPE = 'KG'");
					}
					if (map.getZoom()>8&&map.getZoom()<11) {
				       speedLimitLyr.setDefinitionExpression("RTE_PRFX IN ('IH','US') AND RDBD_TYPE = 'KG'");
					}
					if (map.getZoom()>10&&map.getZoom()<13) {
				       speedLimitLyr.setDefinitionExpression("RTE_PRFX IN ('IH','SH','US','SL') AND RDBD_TYPE = 'KG'");
					}
					if (map.getZoom()>12) {
				       speedLimitLyr.setDefinitionExpression("");
					}
				}

				if (futureTrafficLyr) {
					if (map.getZoom()<9) {
				       futureTrafficLyr.setDefinitionExpression("SUBSTRING(RIA_RTE_ID,1,2)='IH'");
					}
					if (map.getZoom()>8&&map.getZoom()<11) {
				       futureTrafficLyr.setDefinitionExpression("(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')");
					}
					if (map.getZoom()>10&&map.getZoom()<13) {
				       futureTrafficLyr.setDefinitionExpression("(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US' or SUBSTRING(RIA_RTE_ID,1,2)='SH' or SUBSTRING(RIA_RTE_ID,1,2)='SL' or SUBSTRING(RIA_RTE_ID,1,2)='TL')");
					}
					if (map.getZoom()>12) {
				       futureTrafficLyr.setDefinitionExpression("");
					}
				}

				if (pavementConditionLyr) {
					if (map.getZoom()<9) {
				       pavementConditionLyr.setDefinitionExpression("SUBSTRING(ROUTE_ID,1,2)");
					}
					if (map.getZoom()>8&&map.getZoom()<11) {
				       pavementConditionLyr.setDefinitionExpression("(SUBSTRING(ROUTE_ID,1,2)='IH' or SUBSTRING(ROUTE_ID,1,2)='US')");
					}
					if (map.getZoom()>10&&map.getZoom()<13) {
				       pavementConditionLyr.setDefinitionExpression("(SUBSTRING(ROUTE_ID,1,2)='IH' or SUBSTRING(ROUTE_ID,1,2)='US' or SUBSTRING(ROUTE_ID,1,2)='SH' or SUBSTRING(ROUTE_ID,1,2)='SL')");
					}
					if (map.getZoom()>12) {
				       pavementConditionLyr.setDefinitionExpression("");
					}
				}

				if (top100Lyr) {
					if (map.getZoom()<10) {
				       top100Lyr.setDefinitionExpression("");
				       labelLayerTop100.hide();
					}
					if (map.getZoom()>8) {
				       top100Lyr.setDefinitionExpression("");
				       labelLayerTop100.show();
					}
				}

				if (rdwyInvLyr) {
					if (map.getZoom()<=8) {
				       rdwyInvLyr.setDefinitionExpression("SUBSTRING(RIA_RTE_ID,1,2)='IH'");
					}
					if (map.getZoom()>8&&map.getZoom()<=11) {
				       rdwyInvLyr.setDefinitionExpression("(SUBSTRING(RIA_RTE_ID,1,2)='IH' or SUBSTRING(RIA_RTE_ID,1,2)='US')");
					}
					if (map.getZoom()>11) {
				       rdwyInvLyr.setDefinitionExpression("");
					}
				}

				if (cemeteryLyr) {
					if (map.getZoom()<=8) {
				       cemeteryLyr.setDefinitionExpression("Zoom <= 7");
					}
					if (map.getZoom()>8&&map.getZoom()<=11) {
				       cemeteryLyr.setDefinitionExpression("Zoom <= 10");
					}
					if (map.getZoom()>11) {
				       cemeteryLyr.setDefinitionExpression("Zoom <= 16");
					}
				}
			}
		}

		function hideAllOverlays() {
			activeOverlay = "";
			if (aadtLyr) {aadtLyr.hide(); labelLayerAADT.hide()}
			if (areaOfficeLyr) {areaOfficeLyr.hide();}
			if (COGLyr) {COGLyr.hide();}
			if (FCLyr) {FCLyr.hide();}
			if (FCLyr) {UZALyr.hide();}
			if (NatlFreightLyr) {NatlFreightLyr.hide();}
			if (TXFreightLyr) {TXFreightLyr.hide();}
			if (maintOfficeLyr) {maintOfficeLyr.hide();}
			if (maintSecRoutesLyr) {maintSecRoutesLyr.hide();}
			if (txTrunkLyr) {txTrunkLyr.hide();}
			if (txTrunkLyr) {UZALyr.hide();}
			if (MPOLyr) {MPOLyr.hide();}
			if (NHSLyr) {NHSLyr.hide();}
			if (NHSLyr) {MAP21Lyr.hide();}
			if (nonAttainLyr) {nonAttainLyr.hide();}
			if (MarkerLyr) {MarkerLyr.hide(); labelLayerMarker.hide();}
			if (controlSectionLyr) {controlSectionLyr.hide(); labelLayerCS.hide();}
			if (USHouseLyr) {USHouseLyr.hide();}
			if (railRoadLyr) {railRoadLyr.hide();}
			if (StateHouseLyr) {StateHouseLyr.hide();}
			if (speedLimitLyr) {speedLimitLyr.hide();}
			if (StateSenateLyr) {StateSenateLyr.hide();}
			if (futureTrafficLyr) {futureTrafficLyr.hide();}
			if (longTermPlanLyr) {longTermPlanLyr.hide();}
			if (constScheduledLyr) {constScheduledLyr.hide();}
			if (finalForConstLyr) {finalForConstLyr.hide();}
			if (underDevLyr) {underDevLyr.hide();}
			if (minuteOrderLyr) {minuteOrderLyr.hide();}
			if (pavementConditionLyr) {pavementConditionLyr.hide();}
			if (VerticalLyr) {VerticalLyr.hide();}
			if (permStationLyr) {permStationLyr.hide();}
			if (top100Lyr) {top100Lyr.hide(); labelLayerTop100.hide()}
			if (rdwyInvLyr) {rdwyInvLyr.hide();}
			if (cemeteryLyr) {cemeteryLyr.hide();}
			if (energySectorLyr) {energySectorLyr.hide();}
			if (shalePlaysLyr) {shalePlaysLyr.hide();} //if (shalePlaysLyr) {shalePlaysLyr.hide(); shaleBasinsLyr.hide();}
			if (RMAlyr) {RMAlyr.hide();}
			if (tollLyr) {tollLyr.hide();}
			if (futTollLyr) {futTollLyr.hide();}
			if (hurrEvacLyr) {hurrEvacLyr.hide();}
			if (altFuelPoints) {altFuelPoints.hide();}
      if (inrixTrafficLyr) {inrixTrafficLyr.hide();}
      if (memorialHighwayLyr) {memorialHighwayLyr.hide();}
      if (curCongLyr) {curCongLyr.hide();}
      if (futCongLyr) {futCongLyr.hide();}
      if (facLyr) {facLyr.hide();}
      if (bridgeLyr) {bridgeLyr.hide();}
      if (connCorrLyr) {connCorrLyr.hide();}
      if (STRAHNETLyr) {STRAHNETLyr.hide();}
      if (bikeLayer) {bikeLayer.hide();}
      if (projectsRI) {projectsRI.hide();}
			clearStyle("tocData");
      map.graphics.clear();
		}

		dojo.query(".Overlay").forEach(function (result){
				on(result, "click", changeOverlay);
		});

		function changeOverlay(event) {
			var tableText="";
	    clearStyle("tocData");
			hideAllOverlays();
			map.infoWindow.hide();
			map.infoWindow.resize(300,270);
			var theLayer = event.target.id;
			layerInfo.length = 0;

			if (theLayer=="CLEAR") {
				activeOverlay="";
				activeOverlaysArray=[];
				document.getElementById("CLEAR").style.color="red";
			}
			else{

				// if the selected overlay is already turned on (i.e. already in the array) then remove it from the array, which will effectively turn it off
				if (activeOverlaysArray.indexOf(theLayer)> -1){
					var index = activeOverlaysArray.indexOf(theLayer);
					activeOverlaysArray.splice(index,1);
				}
				else {
					// push the selected overlay name into an array
					activeOverlaysArray.push(theLayer);
				}
				// popup an alert to warn the user that only 2 overlays may be turned on at a time
				if (activeOverlaysArray.length > 4){
					document.getElementById("maskDiv").style.display="block";
        			document.getElementById("overlaysWarningDiv").style.display="block";
					activeOverlaysArray.pop();
				}

				// turn each off the currently selected overlay names red in the TOC
				array.forEach(activeOverlaysArray, function(item){
					document.getElementById(item).style.color='red';
				});

				if (activeOverlaysArray.indexOf("Minute_Orders")> -1) {
					var pos = activeOverlaysArray.indexOf("Minute_Orders");
					if (minuteOrderLyr) {
						minuteOrderLyr.show();
						map.reorderLayer(minuteOrderLyr,pos);
					}
					else {
						var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Control Section","${CTRL_SECT}"],["Minute Order Number","<a href='https://publicdocs.txdot.gov/Pages/Minute-Order-Search-Results.aspx#k=${MO_NBR}' target='_blank'>${MO_NBR}</a>"],["Approval Date","${APRV_DT}"],["Description","${DSPN_DSCR}"],["AASHTO Application","${AASHTO_APPLN}"]]);
						var infoTemplate = new InfoTemplate("Highway Designations:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Highway_Designations/FeatureServer/0"

						minuteOrderLyr = new FeatureLayer(projectsUrl, {id:"Minute Orders",visible: true,outFields:["RTE_NM","CTRL_SECT","MO_NBR","APRV_DT","DSPN_DSCR","AASHTO_APPLN"], infoTemplate: infoTemplate});
						map.addLayer(minuteOrderLyr);
					}
					activeOverlay = minuteOrderLyr;
					layerInfo.push({layer:minuteOrderLyr, title:"Highway Designations"});
				}

				if (activeOverlaysArray.indexOf("Speed_Limit")> -1) {
					var pos = activeOverlaysArray.indexOf("Speed_Limit");
					if (speedLimitLyr) {
						speedLimitLyr.show();
						map.reorderLayer(speedLimitLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Max Speed","${SPD_LMT}"],["From DFO","${BEGIN_DFO:NumberFormat(places:3)}"],["To DFO","${END_DFO:NumberFormat(places:3)}"]]);
						var infoTemplate = new InfoTemplate("Speed Limit:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Speed_Limits/FeatureServer/0";

						speedLimitLyr = new FeatureLayer(projectsUrl, {id:"Speed_Limit",visible: true,outFields:["RTE_NM","SPD_LMT","BEGIN_DFO","END_DFO"], infoTemplate: infoTemplate});
						map.addLayer(speedLimitLyr);
					}
					activeOverlay = speedLimitLyr;
					layerInfo.push({layer:speedLimitLyr, title:"Speed Limits"});
				}

				if (activeOverlaysArray.indexOf("Construction_Scheduled")> -1) {
					var pos = activeOverlaysArray.indexOf("Construction_Scheduled");
					if (constScheduledLyr) {
						constScheduledLyr.show();
						map.reorderLayer(constScheduledLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${HIGHWAY_NUMBER}"],["CSJ","${CONTROL_SECT_JOB}"],["Project Class","${PROJ_CLASS}"],["Type of Work","${TYPE_OF_WORK}"],["Layman Description","${LAYMAN_DESCRIPTION1}"],["Work Program","${TPP_WORK_PROGRAM}"]]);
						var infoTemplate = new InfoTemplate("Construction underway or begins soon:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0";

						var theSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([215,25,28]),3);
						var theRenderer = new SimpleRenderer(theSymbol);

						constScheduledLyr = new FeatureLayer(projectsUrl, {id:"Construction_Scheduled",visible: true,outFields:["HIGHWAY_NUMBER","CONTROL_SECT_JOB","PROJ_CLASS","TYPE_OF_WORK","LAYMAN_DESCRIPTION1","TPP_WORK_PROGRAM","PT_PHASE"], infoTemplate: infoTemplate});
						constScheduledLyr.setDefinitionExpression("PT_PHASE = 'Construction underway or begins soon' ");
						constScheduledLyr.setRenderer(theRenderer);
						map.addLayer(constScheduledLyr);
					}
					activeOverlay = constScheduledLyr;
					layerInfo.push({layer:constScheduledLyr, title:"TxDOT Projects - Construction underway or begins soon"});
					map.infoWindow.resize(360, 300);
				}

				if (activeOverlaysArray.indexOf("Finalizing_for_Construction")> -1) {
					var pos = activeOverlaysArray.indexOf("Finalizing_for_Construction");
					if (finalForConstLyr) {
						finalForConstLyr.show();
						map.reorderLayer(finalForConstLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${HIGHWAY_NUMBER}"],["CSJ","${CONTROL_SECT_JOB}"],["Project Class","${PROJ_CLASS}"],["Type of Work","${TYPE_OF_WORK}"],["Layman Description","${LAYMAN_DESCRIPTION1}"],["Work Program","${TPP_WORK_PROGRAM}"]]);
						var infoTemplate = new InfoTemplate("Construction begins within 4 years:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0";

						var theSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([253,174,97]),3);
						var theRenderer = new SimpleRenderer(theSymbol);

						finalForConstLyr = new FeatureLayer(projectsUrl, {id:"Finalizing_for_Construction",visible: true,outFields:["HIGHWAY_NUMBER","CONTROL_SECT_JOB","PROJ_CLASS","TYPE_OF_WORK","LAYMAN_DESCRIPTION1","TPP_WORK_PROGRAM","PT_PHASE"], infoTemplate: infoTemplate});
						finalForConstLyr.setDefinitionExpression("PT_PHASE = 'Construction begins within 4 years' ");
						finalForConstLyr.setRenderer(theRenderer);
						map.addLayer(finalForConstLyr);
					}
					activeOverlay = finalForConstLyr;
					layerInfo.push({layer:finalForConstLyr, title:"TxDOT Projects - Construction begins within 4 years"});
					map.infoWindow.resize(340, 300);
				}

				if (activeOverlaysArray.indexOf("Under_Development")> -1) {
					var pos = activeOverlaysArray.indexOf("Under_Development");
					if (underDevLyr) {
						underDevLyr.show();
						map.reorderLayer(underDevLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${HIGHWAY_NUMBER}"],["CSJ","${CONTROL_SECT_JOB}"],["Project Class","${PROJ_CLASS}"],["Type of Work","${TYPE_OF_WORK}"],["Layman Description","${LAYMAN_DESCRIPTION1}"],["Work Program","${TPP_WORK_PROGRAM}"]]);
						var infoTemplate = new InfoTemplate("Construction begins in 5 to 10 years:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0";

						var theSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([128,205,193]),3);
						var theRenderer = new SimpleRenderer(theSymbol);

						underDevLyr = new FeatureLayer(projectsUrl, {id:"Under_Development",visible: true,outFields:["HIGHWAY_NUMBER","CONTROL_SECT_JOB","PROJ_CLASS","TYPE_OF_WORK","LAYMAN_DESCRIPTION1","TPP_WORK_PROGRAM","PT_PHASE"], infoTemplate: infoTemplate});
						underDevLyr.setDefinitionExpression("PT_PHASE = 'Construction begins in 5 to 10 years'");
						underDevLyr.setRenderer(theRenderer);
						map.addLayer(underDevLyr);
					}
					activeOverlay = underDevLyr;
					layerInfo.push({layer:underDevLyr, title:"TxDOT Projects - Construction begins in 5 to 10 years"});
					map.infoWindow.resize(350, 300);
				}

				if (activeOverlaysArray.indexOf("Long_Term_Planning")> -1) {
					var pos = activeOverlaysArray.indexOf("Long_Term_Planning");
					if (longTermPlanLyr) {
						longTermPlanLyr.show();
						map.reorderLayer(longTermPlanLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${HIGHWAY_NUMBER}"],["CSJ","${CONTROL_SECT_JOB}"],["Project Class","${PROJ_CLASS}"],["Type of Work","${TYPE_OF_WORK}"],["Layman Description","${LAYMAN_DESCRIPTION1}"],["Work Program","${TPP_WORK_PROGRAM}"]]);
						var infoTemplate = new InfoTemplate("Corridor Studies, construction in 10+ years:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Projects/FeatureServer/0";

						var theSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,92,230]),3);
						var theRenderer = new SimpleRenderer(theSymbol);

						longTermPlanLyr = new FeatureLayer(projectsUrl, {id:"Long_Term_Planning",visible: true,outFields:["HIGHWAY_NUMBER","CONTROL_SECT_JOB","PROJ_CLASS","TYPE_OF_WORK","LAYMAN_DESCRIPTION1","TPP_WORK_PROGRAM","PT_PHASE"], infoTemplate: infoTemplate});
						longTermPlanLyr.setDefinitionExpression("PT_PHASE = 'Corridor Studies, construction in 10+ years' ");
						longTermPlanLyr.setRenderer(theRenderer);
						map.addLayer(longTermPlanLyr);
					}
					activeOverlay = longTermPlanLyr;
					layerInfo.push({layer:longTermPlanLyr, title:"TxDOT Projects - Corridor Studies, construction in 10+ years"});
					map.infoWindow.resize(390, 300);
				}

				if (activeOverlaysArray.indexOf("Future_Traffic")> -1) {
					var pos = activeOverlaysArray.indexOf("Future_Traffic");
					if (futureTrafficLyr) {
						futureTrafficLyr.show();
						map.reorderLayer(futureTrafficLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RIA_RTE_ID}"],["${ADT_YEAR} AADT","${ADT_CUR:NumberFormat}"],["${DESGN_YR} Estimated AADT","${AADT_DESGN:NumberFormat}"],["24 Hour Truck Percentage","${TRK_AADT_PCT}"]]);
            tableText += "<br>Future Traffic and Percent Truck data is for main lanes only.";
            var infoTemplate = new InfoTemplate("Future Traffic:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadway_Inventory/FeatureServer/0";
						var theRenderer = new ClassBreaksRenderer(null,function(feature){
							return feature.attributes.ADT_CUR;
						});

						theRenderer.addBreak({minValue:-Infinity,maxValue:50000,symbol:(new esri.symbol.CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, new esri.Color("#FF0000"),1.5, esri.symbol.CartographicLineSymbol.CAP_ROUND, esri.symbol.CartographicLineSymbol.JOIN_MITER,5)),label:"<= 40,000",field:"ADT_CUR"});
						theRenderer.addBreak({minValue:50000,maxValue:100000,symbol:(new esri.symbol.CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, new esri.Color("#FF0000"),3.45, esri.symbol.CartographicLineSymbol.CAP_ROUND, esri.symbol.CartographicLineSymbol.JOIN_MITER,5)),label:"50,000 - 99,999",field:"ADT_CUR"});
						theRenderer.addBreak({minValue:100000,maxValue:150000,symbol:(new esri.symbol.CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, new esri.Color("#FF0000"),5.4, esri.symbol.CartographicLineSymbol.CAP_ROUND, esri.symbol.CartographicLineSymbol.JOIN_MITER,5)),label:"100,000 - 149,999",field:"ADT_CUR"});
						theRenderer.addBreak({minValue:150000,maxValue:200000,symbol:(new esri.symbol.CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, new esri.Color("#FF0000"),7.35, esri.symbol.CartographicLineSymbol.CAP_ROUND, esri.symbol.CartographicLineSymbol.JOIN_MITER,5)),label:"150,000 - 199,999",field:"ADT_CUR"});
						theRenderer.addBreak({minValue:200000,maxValue:250000,symbol:(new esri.symbol.CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, new esri.Color("#FF0000"),9.3, esri.symbol.CartographicLineSymbol.CAP_ROUND, esri.symbol.CartographicLineSymbol.JOIN_MITER,5)),label:"200,000 - 249,999",field:"ADT_CUR"});
						theRenderer.addBreak({minValue:250000,maxValue:Infinity,symbol:(new esri.symbol.CartographicLineSymbol(esri.symbol.CartographicLineSymbol.STYLE_SOLID, new esri.Color("#FF0000"),11.25, esri.symbol.CartographicLineSymbol.CAP_ROUND, esri.symbol.CartographicLineSymbol.JOIN_MITER,5)),label:">= 250,000",field:"ADT_CUR"});

						futureTrafficLyr = new FeatureLayer(projectsUrl, {id:"Future_Traffic",visible: true,outFields:["RIA_RTE_ID","ADT_CUR","AADT_DESGN","TRK_AADT_PCT","ADT_YEAR","DESGN_YR"], infoTemplate: infoTemplate});

            //disabling webGL for this layer (conflict with its ClassBreaksRenderer)
            futureTrafficLyr.setWebGLEnabled(false);
            futureTrafficLyr.setRenderer(theRenderer);
						map.addLayer(futureTrafficLyr);
					}

					activeOverlay = futureTrafficLyr;
					layerInfo.push({layer:futureTrafficLyr, title:"Future Traffic and Percent Trucks.  Future is calculated as 2% growth rate and percent truck is 24 hour."});
				}

				if (activeOverlaysArray.indexOf("Railroads")> -1) {
					var pos = activeOverlaysArray.indexOf("Railroads");
					if (railRoadLyr) {
						railRoadLyr.show();
						map.reorderLayer(railRoadLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Railroad Name","${RR_COMPANY}"],["Railroad Abbreviation","${RR_ABRVN}"],["Status","${RR_STATUS}"],["Type","${RR_TYP}"],["Number","${RR_NBR}"]]);
						var infoTemplate = new InfoTemplate("Railroad:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Railroads/FeatureServer/0";

						railRoadLyr = new FeatureLayer(projectsUrl, {id:"Railroads",visible: true,outFields:["RR_COMPANY","RR_ABRVN","RR_STATUS","RR_TYP","RR_NBR"], infoTemplate: infoTemplate});
						railRoadLyr.setDefinitionExpression("RR_STATUS='Active' AND RR_TYP='Main Line'");
						map.addLayer(railRoadLyr);
					}
					activeOverlay = railRoadLyr;
					layerInfo.push({layer:railRoadLyr, title:"Mainline Railroads"});
				}

				if (activeOverlaysArray.indexOf("Non_Attainment")> -1) {
					var pos = activeOverlaysArray.indexOf("Non_Attainment");
					if (nonAttainLyr) {
						nonAttainLyr.show();
						map.reorderLayer(nonAttainLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["FIPS","${FIPS}"],["Region","${REGION}"],["Status","${STATUS}"]]);
						var infoTemplate = new InfoTemplate("Non Attainment:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_NonAttainment_Areas/FeatureServer/0";

						nonAttainLyr = new FeatureLayer(projectsUrl, {id:"Non_Attainment",visible: true,outFields:["FIPS","REGION","STATUS"], infoTemplate: infoTemplate});
						map.addLayer(nonAttainLyr);
					}
					activeOverlay = nonAttainLyr;
					layerInfo.push({layer:nonAttainLyr, title:"Non-Attainment or Near Non-Attainment Areas"});
				}

				if (activeOverlaysArray.indexOf("Texas_Trunk")> -1) {
					var pos = activeOverlaysArray.indexOf("Texas_Trunk");
					if (txTrunkLyr) {
						UZALyr.show();
						txTrunkLyr.show();
						map.reorderLayer(txTrunkLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Trunk System","${TRNK_SYS}"]]);

						function setUZAPopupContent(graphic){
              var uzaDescription = "";
							if (graphic.attributes.UZA_TYPE == "SUA"){
                uzaDescription = "Small Urban (Population 5,000  49,999)";
							}
							if (graphic.attributes.UZA_TYPE == "UA"){
                uzaDescription = "Urbanized (Population 50,000  199,999)";
							}
							if (graphic.attributes.UZA_TYPE == "LUA"){
                uzaDescription = "Large Urbanized (Population 200,000+)";
							}

              UZATableText = makeTableFromArrayNoHeader([["Name",graphic.attributes.UZA_NM],["Rural/Urban Code",graphic.attributes.UZA_TYPE],["Rural/Urban Description",uzaDescription],["Urban Area Number",graphic.attributes.UZA_NBR]]);
							return UZATableText;
						}
						var UZAInfoTemplate = new InfoTemplate("Urbanized Area:",setUZAPopupContent);
						var infoTemplate = new InfoTemplate("Texas Trunk System:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Texas_Trunk_System/FeatureServer/0";
						var theRenderer = new ClassBreaksRenderer(null,function(feature){
							return feature.attributes.POP2010;
						});

						theRenderer.addBreak({minValue:-Infinity,maxValue:50000,symbol:(new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DOT, new esri.Color([230,152,0]), 2.25),new esri.Color([182,137,48,0.50]))),label:"Small Urban Area",field:"POP2010"});
						theRenderer.addBreak({minValue:50000,maxValue:Infinity,symbol:(new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DOT, new esri.Color([0,77,168]), 2.25),new esri.Color([90,147,168,0.50]))),label:"Urbanized Area",field: "POP2010"});

						txTrunkLyr = new FeatureLayer(projectsUrl, {id:"Texas_Trunk",visible: true,outFields:["RTE_NM","TRNK_SYS"], infoTemplate: infoTemplate});
						UZALyr = new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Urbanized_Areas/FeatureServer/0",{outFields:["*"], infoTemplate:UZAInfoTemplate});

            //disabling webGL for this layer (conflict with its ClassBreaksRenderer)
            UZALyr.setWebGLEnabled(false);
            UZALyr.setRenderer(theRenderer);
						map.addLayers([UZALyr,txTrunkLyr]);
					}
					activeOverlay = txTrunkLyr;
					layerInfo.push({layer:UZALyr, title:"2010 Adjusted Urban Areas"},{layer:txTrunkLyr, title:"Texas Trunk System"});
				}

				if (activeOverlaysArray.indexOf("Maintenance_Section_Routes")> -1) {
					var pos = activeOverlaysArray.indexOf("Maintenance_Section_Routes");
					if (maintSecRoutesLyr) {
						maintSecRoutesLyr.show();
						map.reorderLayer(maintSecRoutesLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Section Number","${NBR}"],["Route Name","${RTE_NM}"],["District Name","${DIST_NM}"],["Begin DFO","${BEGIN_DFO:NumberFormat(places:3)}"],["End DFO","${END_DFO:NumberFormat(places:3)}"]]);
						var infoTemplate = new InfoTemplate("Maintenance Section Route:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Maintenance_Section_Routes/FeatureServer/0";

						maintSecRoutesLyr = new FeatureLayer(projectsUrl, {id:"Maintenance_Section_Routes",visible: true,outFields:["NBR","RTE_NM", "DIST_NM", "BEGIN_DFO", "END_DFO"], infoTemplate: infoTemplate});
						map.addLayer(maintSecRoutesLyr);
					}
					activeOverlay = maintSecRoutesLyr;
					layerInfo.push({layer:maintSecRoutesLyr, title:"Maintenance Section Routes"});
					map.infoWindow.resize(300, 500);
				}

				if (activeOverlaysArray.indexOf("Functional_Classification")> -1) {
					var pos = activeOverlaysArray.indexOf("Functional_Classification");
					if (FCLyr) {
						FCLyr.show();
						UZALyr.show();
						map.reorderLayer(FCLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["FC Description","${FC_DESC}"],["FC Code","${F_SYSTEM}"],["Proposed","${PRPS_RTE}"]]);

						// Manipulate the contents of the popup infoTemplate
            function setUZAPopupContent(graphic){
              var uzaDescription = "";
							if (graphic.attributes.UZA_TYPE == "SUA"){
                uzaDescription = "Small Urban (Population 5,000  49,999)";
							}
							if (graphic.attributes.UZA_TYPE == "UA"){
                uzaDescription = "Urbanized (Population 50,000  199,999)";
							}
							if (graphic.attributes.UZA_TYPE == "LUA"){
                uzaDescription = "Large Urbanized (Population 200,000+)";
							}

              UZATableText = makeTableFromArrayNoHeader([["Name",graphic.attributes.UZA_NM],["Rural/Urban Code",graphic.attributes.UZA_TYPE],["Rural/Urban Description",uzaDescription],["Urban Area Number",graphic.attributes.UZA_NBR]]);
							return UZATableText;
						}
						var UZAInfoTemplate = new InfoTemplate("Urbanized Area:",setUZAPopupContent);
						var infoTemplate = new InfoTemplate("Functional Classification:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Functional_Classification/FeatureServer/0";
						var theRenderer = new ClassBreaksRenderer(null,function(feature){
							return feature.attributes.POP2010;
						});

						theRenderer.addBreak({minValue:-Infinity,maxValue:50000,symbol:(new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DOT, new esri.Color([230,152,0]), 2.25),new esri.Color([182,137,48,0.50]))),label:"Small Urban Area",field:"POP2010"});
						theRenderer.addBreak({minValue:50000,maxValue:Infinity,symbol:(new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DOT, new esri.Color([0,77,168]), 2.25),new esri.Color([90,147,168,0.50]))),label:"Urbanized Area",field: "POP2010"});

						FCLyr = new FeatureLayer(projectsUrl, {id:"Functional_Classification",visible: true,outFields:["RTE_NM","PRPS_RTE","FC_DESC", "F_SYSTEM", "RDBD_TYPE", "SYSTEM"], infoTemplate: infoTemplate});
						UZALyr = new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Urbanized_Areas/FeatureServer/0",{outFields:["*"], infoTemplate:UZAInfoTemplate});

                        //disabling webGL for this layer (conflict with its ClassBreaksRenderer)
                        UZALyr.setWebGLEnabled(false);
                        UZALyr.setRenderer(theRenderer);
						map.addLayers([UZALyr,FCLyr]);
						//  Get details from the service, such as last edit date (as we're doing here), layers, etc. to use in the legend
						var request = esriRequest({
						    url: projectsUrl,
						    content: { f: "json" },
						    handleAs: "json",
						    callbackParamName: "callback"
						  });
						request.then(
						    function(response) {
						      console.log("Success: ", response);
						      fcLastEditDate = response.editingInfo.lastEditDate;
						  }, function(error) {
						      console.log("Error: ", error.message);
						  });
					}
					activeOverlay = FCLyr;
					layerInfo.push({layer:UZALyr, title:"2010 Adjusted Urban Areas"}, {layer:FCLyr, title:"Functional Classification"});
				}

				if (activeOverlaysArray.indexOf("Natl_Freight_Network")> -1) {
					var pos = activeOverlaysArray.indexOf("Natl_Freight_Network");
					if (NatlFreightLyr) {
						NatlFreightLyr.show();
						map.reorderLayer(NatlFreightLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_RB_NM}"]]);
						var infoTemplate = new InfoTemplate("National Highway Freight Network:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_National_Highway_Freight_Network/FeatureServer/0";

						NatlFreightLyr = new FeatureLayer(projectsUrl, {id:"National Highway Freight Network",visible: true,outFields:["RTE_RB_NM","NATL_FRT"], infoTemplate: infoTemplate});
						map.addLayer(NatlFreightLyr);
					}
					activeOverlay = NatlFreightLyr;
					layerInfo.push({layer:NatlFreightLyr, title:"National Highway Freight Network"});
					map.infoWindow.resize(350);
				}

				if (activeOverlaysArray.indexOf("TX_Freight_Network")> -1) {
					var pos = activeOverlaysArray.indexOf("TX_Freight_Network");
					if (TXFreightLyr) {
						TXFreightLyr.show();
						map.reorderLayer(TXFreightLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"]]);
						var infoTemplate = new InfoTemplate("Freight Network:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Texas_Highway_Freight_Network/FeatureServer/0";

						TXFreightLyr = new FeatureLayer(projectsUrl, {id:"Freight Network",visible: true,outFields:["RTE_NM"], infoTemplate: infoTemplate});
						map.addLayer(TXFreightLyr);
					}
					activeOverlay = TXFreightLyr;
					layerInfo.push({layer:TXFreightLyr, title:"Texas Highway Freight Network"});
				}

				if (activeOverlaysArray.indexOf("Vertical_Clearance")> -1) {
					var pos = activeOverlaysArray.indexOf("Vertical_Clearance");
					if (VerticalLyr) {
						VerticalLyr.show();
						map.reorderLayer(VerticalLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Status","${STATUS}"]]);
						var infoTemplate = new InfoTemplate("Vertical Clearance:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vertical_Clearances/FeatureServer/0";

						VerticalLyr = new FeatureLayer(projectsUrl, {id:"Vertical Clearance",visible: true,outFields:["STATUS"], infoTemplate: infoTemplate});
						map.addLayer(VerticalLyr);
					}
					activeOverlay = VerticalLyr;
					layerInfo.push({layer:VerticalLyr, title:"Vertical Clearance"});
				}

				if (activeOverlaysArray.indexOf("Permanent_Stations")> -1) {
					var pos = activeOverlaysArray.indexOf("Permanent_Stations");
					if (permStationLyr) {
						permStationLyr.show();
						map.reorderLayer(permStationLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Station ID","${T_FLAG}"],["Station Type","${STATION_TYPE}"]]);
						var infoTemplate = new InfoTemplate("Permanent Count Station:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Permanent_Count_Stations/FeatureServer/0";

						permStationLyr = new FeatureLayer(projectsUrl, {id:"Permanent Stations",visible: true,outFields:["T_FLAG","STATION_TYPE"], infoTemplate: infoTemplate});
						map.addLayer(permStationLyr);
					}
					activeOverlay = permStationLyr;
					layerInfo.push({layer:permStationLyr, title:"Permanent Count Stations"});
				}

				if (activeOverlaysArray.indexOf("AADT")> -1) {
					var pos = activeOverlaysArray.indexOf("AADT");
					if (aadtLyr) {
						aadtLyr.show();
						labelLayerAADT.show();
						map.reorderLayer(aadtLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Station Flag","${T_FLAG}"],["AADT 2020","${AADT_2020:NumberFormat}"],["AADT 2019","${AADT_2019:NumberFormat}"],["AADT 2018","${AADT_2018:NumberFormat}"],["AADT 2017","${AADT_2017:NumberFormat}"],["AADT 2016","${AADT_2016:NumberFormat}"],["AADT 2015","${AADT_2015:NumberFormat}"],["AADT 2014","${AADT_2014:NumberFormat}"],["AADT 2013","${AADT_2013:NumberFormat}"],["AADT 2012","${AADT_2012:NumberFormat}"],["AADT 2011","${AADT_2011:NumberFormat}"]
            ,["AADT 2010","${AADT_2010:NumberFormat}"],["AADT 2009","${AADT_2009:NumberFormat}"],["AADT 2008","${AADT_2008:NumberFormat}"],["AADT 2007","${AADT_2007:NumberFormat}"],["AADT 2006","${AADT_2006:NumberFormat}"],["AADT 2005","${AADT_2005:NumberFormat}"],["AADT 2004","${AADT_2004:NumberFormat}"],["AADT 2003","${AADT_2003:NumberFormat}"],["AADT 2002","${AADT_2002:NumberFormat}"],["AADT 2001","${AADT_2001:NumberFormat}"]]);

            var infoTemplate = new InfoTemplate("Traffic Count Station:","This count includes frontage roads when present.<br><br>" + tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_AADT_Annuals/FeatureServer/0";

						aadtLyr = new FeatureLayer(projectsUrl, {id:"AADT",visible: true,outFields:["*"], infoTemplate: infoTemplate});
						map.addLayer(aadtLyr);

						//Labeling
						var label_symbol =  new TextSymbol();
						label_symbol.setColor(new Color("#14385C"));
						label_symbol.setFont(new Font("10pt").setWeight(Font.WEIGHT_BOLD));
						label_symbol.setHaloSize(2);
						label_symbol.setHaloColor(new Color([255,255,255]));

						var label_renderer = new SimpleRenderer(label_symbol);
						labelLayerAADT = new LabelLayer({id:"AADT_Labels"});
						labelLayerAADT.addFeatureLayer(aadtLyr, label_renderer, "{AADT_2020}");
						map.addLayer(labelLayerAADT);
					}
					activeOverlay = aadtLyr;
					layerInfo.push({layer:aadtLyr, title:"Annual Average Daily Traffic - Count Location"});
					map.infoWindow.resize(300, 300);
				}

				if (activeOverlaysArray.indexOf("Reference_Markers")> -1) {
					var pos = activeOverlaysArray.indexOf("Reference_Markers");
					if (MarkerLyr) {
						MarkerLyr.show();
						labelLayerMarker.show();
						map.reorderLayer(MarkerLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Reference Marker","${MRKR_NBR}"],["Marker Suffix","${MRKR_SFX}"],["DFO","${DFO:NumberFormat(places:3)}"]]);
						var infoTemplate = new InfoTemplate("Reference Markers:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Reference_Markers/FeatureServer/0";

						MarkerLyr = new FeatureLayer(projectsUrl, {id:"Reference Marker",visible: true,outFields:["*"], infoTemplate: infoTemplate});
						map.addLayer(MarkerLyr);

						//Labeling
						var label_symbol =  new TextSymbol();
						label_symbol.setColor(new Color("#CC6633"));
						label_symbol.setFont(new Font("9pt").setWeight(Font.WEIGHT_BOLD));
						label_symbol.setHaloColor(new Color([255, 255, 255]));
						label_symbol.setHaloSize(2);


						var label_renderer = new SimpleRenderer(label_symbol);
						labelLayerMarker = new LabelLayer({id:"Marker_Labels"});
						labelLayerMarker.addFeatureLayer(MarkerLyr, label_renderer, "{MRKR_NBR}"+"{MRKR_SFX}");
						map.addLayer(labelLayerMarker);
					}
					activeOverlay = MarkerLyr;
					layerInfo.push({layer:MarkerLyr, title:"Reference Markers"});
				}

				if (activeOverlaysArray.indexOf("State_House_Districts")> -1) {
					var pos = activeOverlaysArray.indexOf("State_House_Districts");
					if (StateHouseLyr) {
						StateHouseLyr.show();
						map.reorderLayer(StateHouseLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["District","<a href='https://house.texas.gov/members/member-page/?district=${DIST_NBR}' target='_blank'>${DIST_NBR}</a>"]]);
						var infoTemplate = new InfoTemplate("State House District:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_State_House_Districts/FeatureServer/0";

						var theSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([223,115,255,255]), 3), new Color([0,0,0,0]));
						var theRenderer = new SimpleRenderer(theSymbol);

						StateHouseLyr = new FeatureLayer(projectsUrl, {id:"State House District",visible: true,outFields:["DIST_NBR","REP_NM"], infoTemplate: infoTemplate});
						StateHouseLyr.setRenderer(theRenderer);
						map.addLayer(StateHouseLyr);
					}
					activeOverlay = StateHouseLyr;
					layerInfo.push({layer:StateHouseLyr, title:"Texas House Districts"});
				}

				if (activeOverlaysArray.indexOf("State_Senate_Districts")> -1) {
					var pos = activeOverlaysArray.indexOf("State_Senate_Districts");
					if (StateSenateLyr) {
						StateSenateLyr.show();
						map.reorderLayer(StateSenateLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["District","<a href='https://senate.texas.gov/member.php?d=${DIST_NBR}' target='_blank'>${DIST_NBR}</a>"]]);
						var infoTemplate = new InfoTemplate("State Senate District:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_State_Senate_Districts/FeatureServer/0";

						var theSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([85,255,0,255]), 3), new Color([0,0,0,0]));
						var theRenderer = new SimpleRenderer(theSymbol);

						StateSenateLyr = new FeatureLayer(projectsUrl, {id:"State Senate District",visible: true,outFields:["DIST_NBR","REP_NM"], infoTemplate: infoTemplate});
						StateSenateLyr.setRenderer(theRenderer);
						map.addLayer(StateSenateLyr);
					}
					activeOverlay = StateSenateLyr;
					// theLegend.layerInfos=[{layer:StateSenateLyr, title:"Texas Senate Districts"}];
					layerInfo.push({layer:StateSenateLyr, title:"Texas Senate Districts"});
				}

				if (activeOverlaysArray.indexOf("US_House_Districts")> -1) {
					var pos = activeOverlaysArray.indexOf("US_House_Districts");
					if (USHouseLyr) {
						USHouseLyr.show();
						map.reorderLayer(USHouseLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["District","${DIST_NBR}"],["Representative","${REP_NM}"]]);
            tableText += "<br><a href='https://www.house.gov' target='_blank'>US House of Representatives</a>";
						var infoTemplate = new InfoTemplate("US House District:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_US_House_Districts/FeatureServer/0";

						var theSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([233,150,122,255]), 2), new Color([255,160,122,0]));
						var theRenderer = new SimpleRenderer(theSymbol);

						USHouseLyr = new FeatureLayer(projectsUrl, {id:"US House District",visible: true,outFields:["DIST_NBR","REP_NM"], infoTemplate: infoTemplate});
						USHouseLyr.setRenderer(theRenderer);
						map.addLayer(USHouseLyr);
					}
					activeOverlay = USHouseLyr;
					layerInfo.push({layer:USHouseLyr, title:"US House Districts"});
				}

				if (activeOverlaysArray.indexOf("NHS")> -1) {
					var pos = activeOverlaysArray.indexOf("NHS");
					if (NHSLyr) {
						NHSLyr.show();
						MAP21Lyr.show();
						map.reorderLayer(NHSLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["System Type","${SYSTEM}"],["NHS Type","${NHS_TYPE}"]]);
						var infoTemplate = new InfoTemplate("NHS:",tableText);

            var map21tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_ID}"],["System Type","${Sys_Type}"],["NHS Type","${NHS_TYPE}"]]);
						var map21infoTemplate = new InfoTemplate("MAP-21 Principal Arterial:",map21tableText);

						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_National_Highway_System/FeatureServer/0";

						NHSLyr = new FeatureLayer(projectsUrl, {id:"NHS",visible: true,outFields:["RTE_NM","SYSTEM","NHS_TYPE"], infoTemplate: infoTemplate});
						MAP21Lyr = new FeatureLayer("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Map_21/FeatureServer/0", {id:"MAP-21",visible: true,outFields:["RTE_ID", "Sys_Type", "NHS_TYPE"], infoTemplate: map21infoTemplate})
						map.addLayers([NHSLyr, MAP21Lyr]);
					}
					activeOverlay = NHSLyr;
					layerInfo.push({layer:NHSLyr, title:"National Highway System (NHS)"}, {layer:MAP21Lyr, title:"MAP-21 Principal Arterial"});
				}

				if (activeOverlaysArray.indexOf("Area_Offices")> -1) {
					var pos = activeOverlaysArray.indexOf("Area_Offices");
					if (areaOfficeLyr) {
						areaOfficeLyr.show();
						map.reorderLayer(areaOfficeLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Office Name","${OFFICE_NM}"],["District Name","${DIST_NM}"]]);
						var infoTemplate = new InfoTemplate("Area Office:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Area_Offices/FeatureServer/0";

						// Create renderer to deal with transparency problem
						var theSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([238,59,59,1]), 2), new Color([238,59,59,0]));
						var theRenderer = new SimpleRenderer(theSymbol);

						areaOfficeLyr = new FeatureLayer(projectsUrl, {id:"Area_Offices",visible: true,outFields:["OFFICE_NM", "DIST_NM"], infoTemplate: infoTemplate});
						areaOfficeLyr.setRenderer(theRenderer);
						map.addLayer(areaOfficeLyr);

					}
					activeOverlay = areaOfficeLyr;
					layerInfo.push({layer:areaOfficeLyr, title:"TxDOT Area Offices"});
				}

				if (activeOverlaysArray.indexOf("COG")> -1) {
					var pos = activeOverlaysArray.indexOf("COG");
					if (COGLyr) {
						COGLyr.show();
						map.reorderLayer(COGLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["COG Name","${COG_NM}"],["COG Abbreviation","${COG_ABRVN}"]]);
						var infoTemplate = new InfoTemplate("COG:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Councils_of_Governments/FeatureServer/0";

						COGLyr = new FeatureLayer(projectsUrl, {id:"COG",visible: true,outFields:["COG_NM","COG_ABRVN"], infoTemplate: infoTemplate});
						map.addLayer(COGLyr);
					}
					activeOverlay = COGLyr;
					layerInfo.push({layer:COGLyr, title:"Council of Governments"});
				}

				if (activeOverlaysArray.indexOf("MPO")> -1) {
					var pos = activeOverlaysArray.indexOf("MPO");
					if (MPOLyr) {
						MPOLyr.show();
						map.reorderLayer(MPOLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["MPO Name","${MPO_NM}"],["MPO Number","${MPO_NBR}"]]);
						var infoTemplate = new InfoTemplate("MPO:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Metropolitan_Planning_Organizations/FeatureServer/0";

						MPOLyr = new FeatureLayer(projectsUrl, {id:"MPO",visible: true,outFields:["MPO_NM","MPO_LBL","MPO_NBR"], infoTemplate: infoTemplate});
						map.addLayer(MPOLyr);
					}
					activeOverlay = MPOLyr;
					layerInfo.push({layer:MPOLyr, title:"Metropolitan Planning Organizations"});
				}

				if (activeOverlaysArray.indexOf("Control_Section")> -1) {
					var pos = activeOverlaysArray.indexOf("Control_Section");
					if (controlSectionLyr) {
						controlSectionLyr.show();
						labelLayerCS.show();
					}
					else {
						function getTextContent(graphic){
							var begDFO = graphic.attributes.BEGIN_DFO;
							var endDFO = graphic.attributes.END_DFO;
							var length = (endDFO-begDFO).toFixed(3);
              var tableText = makeTableFromArrayNoHeader([["Control Section",graphic.attributes.CTRL_SECT_NBR],["Route Name",graphic.attributes.RTE_NM],["Begin Mile Point",Math.round(graphic.attributes.BEGIN_MPT*1000)/1000],["End Mile Point",Math.round(graphic.attributes.END_MPT*1000)/1000],["Begin DFO",Math.round(graphic.attributes.BEGIN_DFO*1000)/1000],["End DFO",Math.round(graphic.attributes.END_DFO*1000)/1000],["Length",length]]);
							return tableText;
						}

						var infoTemplate = new InfoTemplate("Control Section:",getTextContent);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0";

						controlSectionLyr = new FeatureLayer(projectsUrl, {id:"Control_Section",visible: true,outFields:["CTRL_SECT_NBR","RTE_NM","BEGIN_MPT","END_MPT", "BEGIN_DFO", "END_DFO"], infoTemplate: infoTemplate});
						map.addLayer(controlSectionLyr, pos);

						//Labeling
						var label_symbol =  new TextSymbol();
						label_symbol.setColor(new Color([0,0,0]));
						label_symbol.setFont(new Font("10pt").setWeight(Font.WEIGHT_BOLD));
						label_symbol.setHaloSize(1);
						label_symbol.setHaloColor(new Color([253,253,253,253]));

						var label_renderer = new SimpleRenderer(label_symbol);
						labelLayerCS = new LabelLayer({id:"CS_Labels"});
						labelLayerCS.addFeatureLayer(controlSectionLyr, label_renderer, "{CTRL_SECT_NBR}");

            // function to crack open the label text and manipulate to add a hyphen in the CS number
						labelLayerCS._buildLabelText = function (b, d, c, e) {
						    var csNbr = d.attributes.CTRL_SECT_NBR;
						    var firstFour = csNbr.substring(0,4);
						    var lastTwo = csNbr.substring(4,6);
						    var fixed = firstFour + "-" + lastTwo;
						    return fixed;
						}
						map.addLayer(labelLayerCS);
					}
					activeOverlay = controlSectionLyr;
					layerInfo.push({layer:controlSectionLyr, title:"Control Section segment colors only serve to distinguish one segment from the next."});
				}

				if (activeOverlaysArray.indexOf("Energy_Sector")> -1) {
					var pos = activeOverlaysArray.indexOf("Energy_Sector");
					if (energySectorLyr) {
						energySectorLyr.show();
						map.reorderLayer(energySectorLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_RB_NM}"]]);
						var infoTemplate = new InfoTemplate("Energy Sector Corridor:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Energy_Sector_Corridors/FeatureServer/0";

						var theSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([244, 113, 66]),3);
						var theRenderer = new SimpleRenderer(theSymbol);

						energySectorLyr = new FeatureLayer(projectsUrl, {id:"Energy_Sector",visible: true,outFields:["RTE_RB_NM", "COUNTY", "ENRGY_SCTR"], infoTemplate: infoTemplate});
						energySectorLyr.setRenderer(theRenderer);
						map.addLayer(energySectorLyr);
					}
					activeOverlay = energySectorLyr;
					layerInfo.push({layer:energySectorLyr, title:"Energy Sector Corridors"});
				}

				if (activeOverlaysArray.indexOf("Shale_Plays")> -1) {
					var pos = activeOverlaysArray.indexOf("Shale_Plays");
					if (shalePlaysLyr) {
						shalePlaysLyr.show();
						// shaleBasinsLyr.show();
						map.reorderLayer(shalePlaysLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Shale Play Name","${Shale_play}"],["Shale Basin Name","${Basin}"]]);
            // var tableText2 = makeTableFromArrayNoHeader([["Basin Name","${NAME}"]]);
						var infoTemplate = new InfoTemplate("Shale Play:",tableText);
						// var infoTemplate2 = new InfoTemplate("Basin:",tableText2);

						shalePlaysLyr = new FeatureLayer("https://services2.arcgis.com/FiaPA4ga0iQKduv3/arcgis/rest/services/Tight_Oil_and_Shale_Gas_Plays_of_the_Contiguous_US_1/FeatureServer/0", {id:"Shale_Plays",visible: true,outFields:["*"], infoTemplate: infoTemplate});
						// shaleBasinsLyr = new FeatureLayer("https://landscape1.arcgis.com/arcgis/rest/services/USA_Oil_Shale_Basins/MapServer/0", {id:"Shale_Basins",visible: true,outFields:["*"], infoTemplate: infoTemplate2});
						map.addLayers([shalePlaysLyr]); //map.addLayers([shaleBasinsLyr, shalePlaysLyr]);

						// shalePlaysLyr.on("load", function(){
						// shalePlaysLyr.renderer.setOpacityInfo({opacityValues: [0.5]});
						// });
						// shaleBasinsLyr.on("load", function(){
						// shaleBasinsLyr.renderer.setOpacityInfo({opacityValues: [0.5]});
						// });
					}
					activeOverlay = shalePlaysLyr;
					layerInfo.push({layer:shalePlaysLyr, title:"Shale Plays"}); //layerInfo.push({layer:shalePlaysLyr, title:"Shale Plays"}, {layer:shaleBasinsLyr, title:"Shale Basins"});
				}

				if (activeOverlaysArray.indexOf("Top_100")> -1) {
					var pos = activeOverlaysArray.indexOf("Top_100");
					if (top100Lyr) {
						top100Lyr.show();
						labelLayerTop100.show();
						map.reorderLayer(top100Lyr,pos);
					}
					else {
						function addCommas(x) {
	    				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
						}

						function getTextContent(graphic){
							var costDelay = "$"+(graphic.attributes.COST_DLAY/1000000).toFixed(2)+" Million";
							var costTruck = "$"+(graphic.attributes.COST_TRK/1000000).toFixed(2)+" Million";
							var delayMile = addCommas(Math.round(parseFloat(graphic.attributes.DLAY_MILE)));
							var truckDelay = addCommas(Math.round(parseFloat(graphic.attributes.TRK_DLAY)));

              var trkDelayRank;
							if (graphic.attributes.TRK_RANK == 0){
                trkDelayRank = "-";
							}
							else{
                trkDelayRank = graphic.attributes.TRK_RANK;
							}

              var tableText = makeTableFromArrayNoHeader([["Route Name",graphic.attributes.RD_NM],["TxDOT District",graphic.attributes.DIST_NM],["Annual Cost of Delay",costDelay],["Annual Hours of Delay per Mile",delayMile],
              ["Truck Delay Rank",trkDelayRank],["Annual Hours of Truck Delay per Mile",truckDelay],["Annual Cost of Truck Delay",costTruck],["TCI",graphic.attributes.TCI]]);

              tableText += "TCI - Texas Congestion Index - ratio of the peak period average travel time to the free flow travel time. A value of 1.20 means that a 30 minute trip during light traffic would take 36 minutes during peak periods.<br><br>";
              tableText += "<a href='https://www.txdot.gov/inside-txdot/projects/100-congested-roadways.html' target='_blank'>List View</a>";

              return tableText;
						}

            var infoTemplate = new InfoTemplate("Rank: ${RANK} / Year: ${YR}",getTextContent);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Top_100_Congested_Roadways/FeatureServer/0";

						top100Lyr = new FeatureLayer(projectsUrl, {id:"Top 100:",visible: true,outFields:["RANK","TRK_RANK","SEG_ID","RD_NM","DLAY_MILE","TRK_DLAY","TCI","COST_DLAY","COST_TRK","DIST_NM","YR"], infoTemplate: infoTemplate});
						map.addLayer(top100Lyr);
						//Labeling
						var label_symbol =  new TextSymbol();
						label_symbol.setColor(new Color([255,255,0]));
						label_symbol.setFont(new Font("11pt"));
						label_symbol.setHaloColor(new Color([0,0,0]));
						label_symbol.setHaloSize(2);
						var label_renderer = new SimpleRenderer(label_symbol);
						labelLayerTop100 = new LabelLayer({id:"Top_100_Labels"});
						labelLayerTop100.addFeatureLayer(top100Lyr, label_renderer, "{RANK}",{lineLabelPosition:"InLine",labelRotation:false});
						map.addLayer(labelLayerTop100);
						map.infoWindow.resize(350,400);
					}

					activeOverlay = top100Lyr;
				}

				if (activeOverlaysArray.indexOf("Roadway_Inventory")> -1) {
					var pos = activeOverlaysArray.indexOf("Roadway_Inventory");
					if (rdwyInvLyr) {
						rdwyInvLyr.show();
						map.reorderLayer(rdwyInvLyr,pos);
					}
					else {

						function addCommas(x) {
	    				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
						}

						function getTextContent(graphic){
              map.infoWindow.resize(310,510);
							var ADT_CUR = addCommas(Math.round(parseFloat(graphic.attributes.ADT_CUR)));
							var AADT_DESGN = addCommas(Math.round(parseFloat(graphic.attributes.AADT_DESGN)));
							var toDFO = graphic.attributes.TO_DFO;
							var fromDFO = graphic.attributes.FRM_DFO;
							var len = toDFO - fromDFO;
							var rndLen = len.toFixed(3);
							var VMT = len * graphic.attributes.ADT_CUR;
							var rndVMT = addCommas(Math.round(parseFloat(VMT)));
							var ADT_YEAR = graphic.attributes.ADT_YEAR;
							var DESGN_YR = graphic.attributes.DESGN_YR;
              var DIR_TRAV = graphic.attributes.DIR_TRAV;

              var surfTypeText="";
              if (graphic.attributes.SRF_TYPE == 1){
								surfTypeText = "Unpaved";
							} else if (graphic.attributes.SRF_TYPE == 99){
								surfTypeText = "Unknown";
							}	else {
								surfTypeText = "Paved";
							}

              var outsideShoulderText="";
              if (graphic.attributes.S_TYPE_O == 2){
								outsideShoulderText = "Paved";
							}	else {
								outsideShoulderText = "Unpaved";
							}

              var tableText = "*For RG, LG, MG or SG roadbeds, AADT and Daily VMT values represent the combined total across all mainlanes (RG + LG + MG + SG). ";
              tableText += "For KG, AG or XG roadbeds, AADT and Daily VMT values are specific to the selected roadbed.";
              tableText += "<br><br>";

              tableText += makeTableFromArrayNoHeader([["Route Name",graphic.attributes.RIA_RTE_ID],["From DFO",graphic.attributes.FRM_DFO],["To DFO",graphic.attributes.TO_DFO],[ADT_YEAR+" AADT*",ADT_CUR],
              [DESGN_YR+" Estimated AADT*",AADT_DESGN],["Truck Percent",graphic.attributes.TRK_AADT_PCT],["Speed Limit",graphic.attributes.SPD_MAX],["Number of Lanes",graphic.attributes.NUM_LANES],
              ["Surface Type",surfTypeText],["Surface Width",graphic.attributes.SUR_W],["Roadbed Width",graphic.attributes.RB_WID],["ROW Width",graphic.attributes.ROW_MIN],["Median Width",graphic.attributes.MED_WID],["Outside Shoulder Width",graphic.attributes.S_WID_O],
              ["Outside Shoulder Type",outsideShoulderText],["Daily VMT*",rndVMT],["Segment Length",rndLen]]);

							return tableText;
						}

						var infoTemplate = new InfoTemplate("${ADT_YEAR} Roadway Inventory",getTextContent);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadway_Inventory_RB_OnSystem/FeatureServer/0";

						rdwyInvLyr = new FeatureLayer(projectsUrl, {id:"Roadway_Inventory",visible: true,outFields:["*"], infoTemplate: infoTemplate});
						map.addLayer(rdwyInvLyr);
					}
					activeOverlay = rdwyInvLyr;
					layerInfo.push({layer:rdwyInvLyr, title:"Roadway Inventory"});
				}

				if (activeOverlaysArray.indexOf("Cemetery")> -1) {
					var pos = activeOverlaysArray.indexOf("Cemetery");
					if (cemeteryLyr) {
						cemeteryLyr.show();
						map.reorderLayer(cemeteryLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Cemetery Name","${CEMETERY_NM}"],["County Name","${CNTY_NM}"]]);
						var infoTemplate = new InfoTemplate("Cemetery:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Cemeteries/FeatureServer/0";

						cemeteryLyr = new FeatureLayer(projectsUrl, {id:"Cemetery",visible: true,outFields:["CEMETERY_NM", "CNTY_NM", "Zoom"], infoTemplate: infoTemplate});
						map.addLayer(cemeteryLyr);
					}
					activeOverlay = cemeteryLyr;
					layerInfo.push({layer:cemeteryLyr, title:"Cemetery"});
				}
				if (activeOverlaysArray.indexOf("RMA")> -1) {
					var pos = activeOverlaysArray.indexOf("RMA");
					if (RMAlyr) {
						RMAlyr.show();
						map.reorderLayer(RMAlyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Name","${Label}"]]);
						var infoTemplate = new InfoTemplate("Regional Mobility Authority:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/Texas_Regional_Mobility_Authorities/FeatureServer/0";

						RMAlyr = new FeatureLayer(projectsUrl, {id:"RMA",visible: true,outFields:["Label"], infoTemplate: infoTemplate});
						map.addLayer(RMAlyr);
					}
					activeOverlay = RMAlyr;
					layerInfo.push({layer:RMAlyr, title:"Regional Mobility Authority (RMA)"});
				}
				if (activeOverlaysArray.indexOf("Tolls")> -1) {
					var pos = activeOverlaysArray.indexOf("Tolls");
					if (tollLyr) {
						tollLyr.show();
						map.reorderLayer(tollLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Toll Name","${TOLL_NM}"],["Route Name","${RTE_NM}"],["Charge Type","${CHRG_TYPE}"],["System","${SYSTEM}"]]);
						var infoTemplate = new InfoTemplate("Toll:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Texas_Toll_Roads/FeatureServer/0";

						tollLyr = new FeatureLayer(projectsUrl, {id:"Tolls",visible: true,outFields:["TOLL_NM", "RTE_NM", "CHRG_TYPE", "SYSTEM"], infoTemplate: infoTemplate});
						map.addLayer(tollLyr);
					}
					activeOverlay = tollLyr;
					layerInfo.push({layer:tollLyr, title:"Tolls"});
				}

				if (activeOverlaysArray.indexOf("Future_Tolls")> -1) {
					var pos = activeOverlaysArray.indexOf("Future_Tolls");
					if (futTollLyr) {
						futTollLyr.show();
						map.reorderLayer(futTollLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Toll Name","${TOLL_NM}"],["Alternate Segment Name","${ALT_NM_SEG}"],["Route Name","${RTE_RB_NM}"],["Toll Status","${TOLL_STAT}"],["Comment","${CMNT}"]]);
						var infoTemplate = new InfoTemplate("Toll (Future & Proposed):",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Future_Texas_Toll_Roads/FeatureServer/0";

						futTollLyr = new FeatureLayer(projectsUrl, {id:"Future_Tolls",visible: true,outFields:["TOLL_NM", "RTE_RB_NM", "TOLL_STAT", "ALT_NM_SEG", "CMNT"], infoTemplate: infoTemplate});
						map.addLayer(futTollLyr);
					}
					activeOverlay = futTollLyr;
					layerInfo.push({layer:futTollLyr, title:"Tolls (Future & Proposed)"});
				}

				if (activeOverlaysArray.indexOf("Memorial_Highway") > -1) {
                    var pos = activeOverlaysArray.indexOf("Memorial_Highway");
                    if (memorialHighwayLyr) {
                        memorialHighwayLyr.show();
                        map.reorderLayer(memorialHighwayLyr, pos);
                    }
                    else {
                        var tableText = makeTableFromArrayNoHeader([["Memorial Highway","${MEMORIAL_H}"],["Route Name","${RTE_NM}"]]);
                        var infoTemplate = new InfoTemplate("Memorial Highway:", tableText);
                        var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Memorial_Highways/FeatureServer/0";

                        memorialHighwayLyr = new FeatureLayer(projectsUrl, { id: "Memorial_Highway", visible: true, outFields: ["MEMORIAL_H", "RTE_NM"], infoTemplate: infoTemplate });
                        map.addLayer(memorialHighwayLyr);
                    }
                    activeOverlay = memorialHighwayLyr;
                }

				if (activeOverlaysArray.indexOf("Hurricane_Evac")> -1) {
					var pos = activeOverlaysArray.indexOf("Hurricane_Evac");
					if (hurrEvacLyr) {
						hurrEvacLyr.show();
						map.reorderLayer(hurrEvacLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_RB_NM}"],["Route Type","${ROUTE_TYPE}"]]);
						var infoTemplate = new InfoTemplate("Hurricane Evacuation Route:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Evacuation_Routes/FeatureServer/0";

						hurrEvacLyr = new FeatureLayer(projectsUrl, {id:"Hurricane_Evac",visible: true,outFields:["RTE_RB_NM", "ROUTE_TYPE"], infoTemplate: infoTemplate});
						map.addLayer(hurrEvacLyr);
					}
					activeOverlay = hurrEvacLyr;
					layerInfo.push({layer:hurrEvacLyr, title:"Hurricane Evacuation Routes"});
				}

				// da
				if (activeOverlaysArray.indexOf("Alt_Fuel_Points")> -1) {
					var pos = activeOverlaysArray.indexOf("Alt_Fuel_Points");
					if (altFuelPoints) {
						altFuelPoints.show();
						map.reorderLayer(altFuelPoints,pos);
					}
					else {
						
						// handle CORS  
						esriConfig.defaults.io.corsEnabledServers.push("https://developer.nrel.gov");

						const altFuelsRequestPromise = esriRequest({
							url: "https://developer.nrel.gov/api/alt-fuel-stations/v1.geojson?api_key=QnhomVJEoNJdkuSwUV1Kbz9FFsE70QBzuq3pZhoi&fuel_type=ELEC,LPG,HY,CNG,LNG&state=TX",
							handleAs: 'json'
        				});

						// using graphics layer
						let altFuelGrphLyr = new GraphicsLayer(projectsUrl, {id:"Alt_Fuel_Points",visible: true, styling: true, infoTemplate: infoTemplate});
						// let altFuelGrphLyr = new FeatureLayer(projectsUrl, {id:"Alt_Fuel_Points",visible: true, infoTemplate: infoTemplate});

						map.addLayer(altFuelGrphLyr);   


						// read the geojson data from esriRequest promise
						altFuelsRequestPromise.then((response) => {

						response.features.map((feature, i) => {
						const point = new Point(feature.geometry.coordinates);

							var chargeStationWebMer = webMercatorUtils.geographicToWebMercator(point);

							// attributes what else do we need? 
							const attributes = {
								ObjectID: i,
								station_name: feature.properties.station_name,
								fuel_type_code: feature.properties.fuel_type_code
							};

							// give each point type a color / size / ?
							const fuelTypeColor = [
								{fuelTypeCode : "CNG", fuelColor : [200 ,0, 0, 0.5]},
								{fuelTypeCode : "LPG", fuelColor : [0 ,0, 200, 0.5]},
								{fuelTypeCode : "HY", fuelColor : [0,200, 0, 0.5]},
								{fuelTypeCode : "LNG", fuelColor : [200 ,200, 200, 0.5]},
								{fuelTypeCode : "ELEC", fuelColor : [232 ,221 , 19, 0.5]}

							];

			
							// function for symbolizing point color / size
							let symbolizeAltFuels = (fuelPoint) => {
							if (attributes.fuel_type_code == fuelPoint.fuelTypeCode) {
								chargeStationMarker = new SimpleMarkerSymbol("solid", 5, null, new Color(fuelPoint.fuelColor))
								const graphic = new Graphic(chargeStationWebMer, chargeStationMarker, attributes);
								
								var tableText = makeTableFromArrayNoHeader([["Station Name",attributes.station_name],["Fuel Type",attributes.fuel_type_code]]);
								var infoTemplate = new InfoTemplate("Alternative Fuel Points:",tableText);
								var projectsUrl = "https://developer.nrel.gov/api/alt-fuel-stations/v1.geojson?api_key=QnhomVJEoNJdkuSwUV1Kbz9FFsE70QBzuq3pZhoi&fuel_type=ELEC,LPG,HY,CNG,LNG&state=TX"
								
								return altFuelGrphLyr.add(graphic);
								
							}
							}
							fuelTypeColor.map(symbolizeAltFuels);
 
							});
						}).otherwise((error) => {
							console.log("Error happened while loading alt fuels overlay", error);
						});												
					}

					activeOverlay = altFuelPoints;
					layerInfo.push({layer:altFuelPoints, title:"Alternative Fuel Points"});
				}



        if (activeOverlaysArray.indexOf("INRIX_Traffic")> -1) {
					var pos = activeOverlaysArray.indexOf("INRIX_Traffic");
					if (inrixTrafficLyr) {
						inrixTrafficLyr.show();
					}
					else {
            //Get the INRIX daily token and add to map
            xmlRequestWithProcessing(queryRecordFromService('https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/inrix_token_view/FeatureServer/0','OBJECTID>=0','token ASC','*'),getToken);

            //default link to start with (level, col, row, replaced with quadkey)
            var inrixLink = "http://tile-api.inrix.com/v1/tiles/${level}${col}${row}?roadsegmenttype=XDS&opacity=60&FRCLevel=1,2,3&penWidth=4&accessToken="+txAccessToken;

            //create the traffic layer
            inrixTrafficLyr = new WebTiledLayer(inrixLink, {
              "copyright": 'TxDOT, INRIX',
              "id": "INRIX Traffic"
            });

            //replace getTileUrl template with quadkey template.
            inrixTrafficLyr.getTileUrl = function (level,col,row) {
              var quadKey = tileXYToQuadKey(level,col,row);
              var penWidth = 9;
              var frcLevel = "1,2,3";

              //Adjust line width and data density by zoom level
              if (level<=8) {
                penWidth = 9;
                frcLevel = "1";
              } else if (level>8&&level<=10) {
                penWidth = 9;
                frcLevel = "1,2";
              } else if (level>10&&level<=12) {
                penWidth = 9;
                frcLevel = "1,2,3";
              } else if (level>12&&level<=14) {
                penWidth = 10;
                frcLevel = "1,2,3,4";
              } else {
                penWidth = 11;
                frcLevel = "1,2,3,4,5,6,7";
              }

              var url = "https://tile-api.inrix.com/v1/tiles/"+quadKey+"?accessToken="+txAccessToken+"&penWidth="+penWidth+"&opacity=60&frcLevel="+frcLevel+"&roadsegmenttype=XDS";
              return url;
            }
            // add layer with .25 second delay to wait for token
            setTimeout(function(){map.addLayer(inrixTrafficLyr)},250);

            function queryRecordFromService(theServiceName,theQuery,theOrder,theFields) {
              var theRequest = theServiceName + "/query?f=json&orderByFields=" + theOrder + "&returnGeometry=false&where=" + theQuery + "&outFields=" + theFields;
              return theRequest;
            }

            //XML HTTP Request - With callback to handle follow up processing in the onreadystatechange function
            //---------------------------------------
            function xmlRequestWithProcessing(theService,callback) {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.responseType = 'json';

                xmlhttp.onreadystatechange=function() {
                    if (xmlhttp.readyState==4 && xmlhttp.status==200)	{
                        callback(xmlhttp.response);
                    }
                };

                xmlhttp.open("POST",theService,true);
                xmlhttp.send();
            }
            //---------------------------------------

            function getToken(results) {
              txAccessToken = results.features[0].attributes.token;
              inrixTrafficLyr.refresh();
            }

        		//convert zoom, row, col to quad key
        		function tileXYToQuadKey(zoom,y,x) {
        			var key = [], quadKey, i, keyVal, mask;

        			for(i = zoom; i > 0; i--) {
        				keyVal = '0';
        				mask = 1 << (i-1);
        				if( (x & mask) !== 0)
        				{
        					keyVal++;
        				}
        				if( (y & mask) !== 0)
        				{
        					keyVal++;
        					keyVal++;
        				}
        				key.push(keyVal);
        			}
        			quadKey = key.join("");
        			return quadKey;
        		}
    			}
					activeOverlay = inrixTrafficLyr;
					layerInfo.push({layer:inrixTrafficLyr, title:"INRIX Live Traffic"});
          // make sure INRIX layer draws above other basemaps
          map.reorderLayer(inrixTrafficLyr,1)
				}

				if (activeOverlaysArray.indexOf("Current_Congestion")> -1) {
					var pos = activeOverlaysArray.indexOf("Current_Congestion");
					if (curCongLyr) {
						curCongLyr.show();
						map.reorderLayer(curCongLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Congestion Level","${CUR_CONG}"],["Base Year","${ADT_YEAR}"]]);
						var infoTemplate = new InfoTemplate("Congestion (Base Year):",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Congestion/FeatureServer/0";

						curCongLyr = new FeatureLayer(projectsUrl, {id:"Current_Congestion",visible: true,outFields:["RTE_NM", "CUR_CONG", "ADT_YEAR"], infoTemplate: infoTemplate});
						map.addLayer(curCongLyr);
					}
					activeOverlay = curCongLyr;
					layerInfo.push({layer:curCongLyr, title:"Congestion (Base Year)"});
				}

				if (activeOverlaysArray.indexOf("Future_Congestion")> -1) {
					var pos = activeOverlaysArray.indexOf("Future_Congestion");
					if (futCongLyr) {
						futCongLyr.show();
						map.reorderLayer(futCongLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["Congestion Level","${FUT_CONG}"],["Forecast Year","${DESGN_YR}"]]);
						var infoTemplate = new InfoTemplate("Congestion (Forecast Year):",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Future_Congestion/FeatureServer/0";

						futCongLyr = new FeatureLayer(projectsUrl, {id:"Future_Congestion",visible: true,outFields:["RTE_NM", "FUT_CONG", "DESGN_YR"], infoTemplate: infoTemplate});
						map.addLayer(futCongLyr);
					}
					activeOverlay = futCongLyr;
					layerInfo.push({layer:futCongLyr, title:"Congestion (Forecast Year)"});
				}
				if (activeOverlaysArray.indexOf("TxDOT_Facilities")> -1) {
					var pos = activeOverlaysArray.indexOf("TxDOT_Facilities");
					if (facLyr) {
						facLyr.show();
						map.reorderLayer(facLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Facility Name","${FCLTY_SITE_NM}"],["District","${TXDOT_DIST_NM}"],["District Headquarters","${DIST_FLAG}"],["Area Office","${AREA_FLAG}"],["Maintenance Section Office","${MNT_FLAG}"],["DMV Office","${VTR_FLAG}"],["Travel Information Center","${TIC_FLAG}"],["Rest Area","${REST_FLAG}"]]);
						var infoTemplate = new InfoTemplate("TxDOT Facility:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Offices/FeatureServer/0";

						facLyr = new FeatureLayer(projectsUrl, {id:"TxDOT_Facilities",visible: true,outFields:["*"], infoTemplate: infoTemplate});
						facLyr.setDefinitionExpression("STAT='A'");
						map.addLayer(facLyr);
						map.infoWindow.resize(300, 460);
					}
					activeOverlay = facLyr;
					layerInfo.push({layer:facLyr, title:"TxDOT Facilities"});
				}

				if (activeOverlaysArray.indexOf("Bridges")> -1) {
					var pos = activeOverlaysArray.indexOf("Bridges");
					if (bridgeLyr) {
						bridgeLyr.show();
						map.reorderLayer(bridgeLyr,pos);
					}
					else {
            var bridgeLink = "http://iapps/apps/txdot_gis_portal/BridgeReport.aspx?&BrgID=" + "${BRDG_ID}" + "&rc:Parameters=false";
            var tableText = makeTableFromArrayNoHeader([["Bridge ID","<a href='" + bridgeLink + "' target='_blank'>${BRDG_ID}</a>"],["Operational Status","${OPRTL_STAT}"],["Facility Carried","${FACLTY_CARRD_BY_STRUC}"],
            ["Feature Crossed","${FEAT_INTSECT}"],["Location","${LOCN}"],["Latitude","${LAT_DD}"],["Longitude","${LONG_DD}"],["Deck","${DECK_COND_RTNG}"],["Superstructure","${SUPERSTRUC_COND_RTNG}"],["Substructure","${SUBSTRUC_COND_RTNG}"],
            ["Culvert","${CULV_COND_RTNG}"],["Structural Evaluation","${APPRSL_RTNG_STRUC_EVAL}"],["Deck Geometry","${APPRSL_RTNG_DECK_GMTRY}"],["Underclearances, Vertical and Horizontal","${APPRSL_RTNG_VERT_HRZNTL_UNDR}"],["Waterway Adequacy","${APPRSL_RTNG_WATRWY}"],["Approach Roadway Alignment","${APPRSL_RTNG_APRCH_ALGN}"],
            ["Year Built","${YR_BLT}"],["Year Reconstructed or Widened","${YR_RECNSTR}"],["Structure Length","${STRUC_LNGTH}"],["NBIS Bridge Length","${NBIS_BRDG_LNGTH}"]]);

						var infoTemplate = new InfoTemplate("Bridge:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Bridges/FeatureServer/0";

						bridgeLyr = new FeatureLayer(projectsUrl, {id:"Bridges",visible: true,outFields:["*"], infoTemplate: infoTemplate});
						map.addLayer(bridgeLyr);
						map.infoWindow.resize(420, 580);
					}
					activeOverlay = bridgeLyr;
					layerInfo.push({layer:bridgeLyr, title:"Bridges"});
				}

				if (activeOverlaysArray.indexOf("Connectivitiy_Corridors")> -1) {
					var pos = activeOverlaysArray.indexOf("Connectivitiy_Corridors");
					if (connCorrLyr) {
						connCorrLyr.show();
						map.reorderLayer(connCorrLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NAME}"]]);
						var infoTemplate = new InfoTemplate("Connectivity Corridor:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Statewide_Connectivity_Corridors/FeatureServer/0";

						connCorrLyr = new FeatureLayer(projectsUrl, {id:"Connectivitiy_Corridors",visible: true,outFields:["RTE_NAME"], infoTemplate: infoTemplate});
						map.addLayer(connCorrLyr);
					}
					activeOverlay = connCorrLyr;
					layerInfo.push({layer:connCorrLyr, title:"Statewide Connectivity Corridors"});
				}

				if (activeOverlaysArray.indexOf("STRAHNET")> -1) {
					var pos = activeOverlaysArray.indexOf("STRAHNET");
					if (STRAHNETLyr) {
						STRAHNETLyr.show();
						map.reorderLayer(STRAHNETLyr,pos);
					}
					else {
            var tableText = makeTableFromArrayNoHeader([["Route Name","${RTE_NM}"],["STRAHNET Route Type","${STRAHNET}"]]);
						var infoTemplate = new InfoTemplate("STRAHNET:",tableText);
						var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_STRAHNET/FeatureServer/0";

						STRAHNETLyr = new FeatureLayer(projectsUrl, {id:"STRAHNET",visible: true,outFields:["RTE_NM", "STRAHNET"], infoTemplate: infoTemplate});
						map.addLayer(STRAHNETLyr);
					}
					activeOverlay = STRAHNETLyr;
					layerInfo.push({layer:STRAHNETLyr, title:"Strategic Highway Network (STRAHNET)"});
				}

        if (activeOverlaysArray.indexOf("Bicycle_Trails") > -1) {
            var pos = activeOverlaysArray.indexOf("Bicycle_Trails");
            if (bikeLayer) {
                bikeLayer.show();
                map.reorderLayer(bikeLayer, pos);
            }
            else {
                var tableText = makeTableFromArrayNoHeader([["Route Type","${TYPE}"],["Existing Facility","${EXIST_FCLTY}"],["Future Facility","${FUT_FCLTY}"],["Status","${STAT}"]]);
                var infoTemplate = new InfoTemplate("Bicycle Tourism Trail:", tableText);
                var projectsUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/TxDOT_Bicycle_Tourism_Trails_Example_Network/FeatureServer/0";

                bikeLayer = new FeatureLayer(projectsUrl, { id: "Bicycle_Trails", visible: true, outFields: ["*"], infoTemplate: infoTemplate });
                map.addLayer(bikeLayer);
            }
            activeOverlay = bikeLayer;
            layerInfo.push({layer:bikeLayer, title:"TxDOT Bicycle Tourism Trails Example Network"});
        }
			}

			scaleDependentQueries();
		}
		function addInventoryData() {
      function getTextContentQuery(graphic){
        map.infoWindow.resize(310,510);
        var ADT_CUR = addCommas(Math.round(parseFloat(graphic.attributes.ADT_CUR)));
        var AADT_DESGN = addCommas(Math.round(parseFloat(graphic.attributes.AADT_DESGN)));
        var toDFO = graphic.attributes.TO_DFO;
        var fromDFO = graphic.attributes.FRM_DFO;
        var len = toDFO - fromDFO;
        var rndLen = len.toFixed(3);
        var VMT = len * graphic.attributes.ADT_CUR;
        var rndVMT = addCommas(Math.round(parseFloat(VMT)));
        var ADT_YEAR = graphic.attributes.ADT_YEAR;
        var DESGN_YR = graphic.attributes.DESGN_YR;
        var DIR_TRAV = graphic.attributes.DIR_TRAV;

        var surfTypeText="";
        if (graphic.attributes.SRF_TYPE == 1){
          surfTypeText = "Unpaved";
        } else if (graphic.attributes.SRF_TYPE == 99){
          surfTypeText = "Unknown";
        }	else {
          surfTypeText = "Paved";
        }

        var outsideShoulderText="";
        if (graphic.attributes.S_TYPE_O == 2){
          outsideShoulderText = "Paved";
        }	else {
          outsideShoulderText = "Unpaved";
        }

        var tableText = makeTableFromArrayNoHeader([["Route Name",graphic.attributes.RIA_RTE_ID],["From DFO",graphic.attributes.FRM_DFO],["To DFO",graphic.attributes.TO_DFO],[ADT_YEAR+" AADT*",ADT_CUR],
        [DESGN_YR+" Estimated AADT*",AADT_DESGN],["Truck Percent",graphic.attributes.TRK_AADT_PCT],["Speed Limit",graphic.attributes.SPD_MAX],["Number of Lanes",graphic.attributes.NUM_LANES],
        ["Surface Type",surfTypeText],["Surface Width",graphic.attributes.SUR_W],["Roadbed Width",graphic.attributes.RB_WID],["ROW Width",graphic.attributes.ROW_MIN],["Median Width",graphic.attributes.MED_WID],["Outside Shoulder Width",graphic.attributes.S_WID_O],
        ["Outside Shoulder Type",outsideShoulderText],["Daily VMT*",rndVMT],["Segment Length",rndLen]]);

        return tableText;
      }

      var infoTemplate = new InfoTemplate("${ADT_YEAR} Roadway Inventory:",getTextContentQuery);
      var projectsRIUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/ArcGIS/rest/services/TxDOT_Roadway_Inventory_OnSystem/FeatureServer/0";

			var theSymbol = new esri.symbol.SimpleLineSymbol("solid", new esri.Color("#FF0000"), 5);
			//var theSymbol = new CartographicLineSymbol(CartographicLineSymbol.STYLE_SOLID, new Color("#FF0000"), 5, CartographicLineSymbol.CAP_ROUND, CartographicLineSymbol.JOIN_MITER, 5);
			var theRenderer = new SimpleRenderer(theSymbol);

			//Add the layer - outFields: ["*"] if you want to use all fields
			projectsRI = new FeatureLayer(projectsRIUrl, {id:"RoadwayInventory",visible: false,outFields:["*"], infoTemplate: infoTemplate});
      projectsRI.setRenderer(theRenderer);
			projectsRI.setAutoGeneralize(false);
			map.addLayer(projectsRI);
		}

    function addBridgeData() {
        var bridgeLink = "http://iapps/apps/txdot_gis_portal/BridgeReport.aspx?&BrgID=" + "${BRDG_ID}" + "&rc:Parameters=false";
        var tableText = makeTableFromArrayNoHeader([["Bridge ID","<a href='" + bridgeLink + "' target='_blank'>${BRDG_ID}</a>"],["Operational Status","${OPRTL_STAT}"],["Facility Carried","${FACLTY_CARRD_BY_STRUC}"],
        ["Feature Crossed","${FEAT_INTSECT}"],["Location","${LOCN}"],["Latitude","${LAT_DD}"],["Longitude","${LONG_DD}"],["Deck","${DECK_COND_RTNG}"],["Superstructure","${SUPERSTRUC_COND_RTNG}"],["Substructure","${SUBSTRUC_COND_RTNG}"],
        ["Culvert","${CULV_COND_RTNG}"],["Structural Evaluation","${APPRSL_RTNG_STRUC_EVAL}"],["Deck Geometry","${APPRSL_RTNG_DECK_GMTRY}"],["Underclearances, Vertical and Horizontal","${APPRSL_RTNG_VERT_HRZNTL_UNDR}"],["Waterway Adequacy","${APPRSL_RTNG_WATRWY}"],["Approach Roadway Alignment","${APPRSL_RTNG_APRCH_ALGN}"],
        ["Year Built","${YR_BLT}"],["Year Reconstructed or Widened","${YR_RECNSTR}"],["Structure Length","${STRUC_LNGTH}"],["NBIS Bridge Length","${NBIS_BRDG_LNGTH}"]]);

  			var infoTemplate = new InfoTemplate("Bridge:",tableText);
  			var projectsBridgeUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Bridges/FeatureServer/0";

  			bridgeLyr = new FeatureLayer(projectsBridgeUrl, {id:"Bridges",visible: false,outFields:["*"], infoTemplate: infoTemplate});
  			map.addLayer(bridgeLyr);
    }

    //this function resets the query parameters, removes RI or bridge graphics/infowindows, and recenters the map
		function resetQuery() {
      document.getElementById("print").innerHTML = "";
      document.getElementById("conditions").value = "";
      document.getElementById("queryResults").innerHTML = "Query parameters have been reset, please enter new values";
      queries = [];
      map.centerAndZoom(webMercatorUtils.geographicToWebMercator(theCenter),theZoom);
      map.infoWindow.hide();
      projectsRI.setDefinitionExpression("OBJECTID>=0");
      projectsRI.hide();
      bridgeLyr.setDefinitionExpression("OBJECTID>=0");
      bridgeLyr.hide();
		}

    function selectAttributes(theQuery) {
			if (document.getElementById("radBridge").checked) {
				bridgeLyr.setDefinitionExpression(theQuery);
				noResults("queryResults","Running Query.....");

				bridgeLyr.selectFeatures(theQuery,FeatureLayer.SELECTION_NEW,function(featureSet){
					if (featureSet.length>0) {
					    if (featureSet.length<150) {
							map.setExtent(graphicsUtils.graphicsExtent(featureSet));
							noResults("queryResults",featureSet.length + " records returned.  Click mapped segments to view details.");
						}
						else {
							noResults("queryResults","More than 150 records returned.  Zoom out to view results, then click mapped segments to view details.");
						}
						bridgeLyr.show();
					}
					else {
						noResults("queryResults","Query returned 0 records.<br>Please try again.");
						bridgeLyr.hide();
					}
				});
			} else {
				projectsRI.setDefinitionExpression(theQuery);
				noResults("queryResults","Running Query.....");

				projectsRI.selectFeatures(theQuery,FeatureLayer.SELECTION_NEW,function(featureSet){
					if (featureSet.length>0) {
					    if (featureSet.length<150) {
							map.setExtent(graphicsUtils.graphicsExtent(featureSet));
							noResults("queryResults",featureSet.length + " records returned.  Click mapped segments to view details.");
						}
						else {
							noResults("queryResults","More than 150 records returned.  Zoom out to view results, then click mapped segments to view details.");
						}
						projectsRI.show();
					}
					else {
						noResults("queryResults","Query returned 0 records.<br>Please try again.");
						projectsRI.hide();
					}
				});
			}
		}

		function noResults(theDiv,theText) {
			document.getElementById(theDiv).innerHTML = theText;
		}

		on(dom.byId("btnCalcCost"), "click", deCalculateCost);
		function deCalculateCost() {
			if (deLength>0) {
			   //Nothing
			}
			else {
				alert("Please draw a line before calculating costs.");
				return;
			}

			var deProjectType = document.getElementById("selPrjType").value;
			var deAreaType = document.getElementById("selPrjAreaType").value;
			var deRouteType = document.getElementById("selPrjRouteType").value;
	    var deDivided = document.getElementById("selPrjDividedType").value;
	    var deFrontageRoads = document.getElementById("selPrjFrontageRoads").value;
	    var deLanes = document.getElementById("txtPrjLanes").value;
	    var deProjectLength = Math.round(deLength*1000)/1000;

			if (deLanes<1) {
				alert("Number of Lanes must be greater than 0.");
				return;
			}

			if (deRouteType=="E") {
				deDivided = "H";
			}

			var userProjectInput = deProjectType + deAreaType + deRouteType + deDivided;
			var codeArray = new Array("ADFH","ADFI","BDFH","BDFI","ADGH","ADGI","BDGH","BDGI","ADEH","BDEH","ACFH","ACFI","BCFH","BCFI","ACGH","ACGI","BCGH","BCGI","ACEH","BCEH");
			var costArray = new Array(2891181,1523096,679775,410606,1567558,1142895,743221,527346,2500000,585985,3307443,1424801,883591,742257,2948087,1413481,1213519,853382,5463629,917134);
		    var prjCostPerMile;

			var i;
			for (i=0;i<20;i++) {
				if (userProjectInput==codeArray[i]) {
					prjCostPerMile = costArray[i];
				}
			}

			var totalRoadTypeCost = prjCostPerMile * deLanes * deProjectLength;
		    var totalFrontageRoadCost=0;

			if (deFrontageRoads=="2") {
				totalFrontageRoadCost = 1250000 * deProjectLength * 4;
			}
			else {
				totalFrontageRoadCost = 0;
			}

			//Summing total project cost and writing to output
			var theOutputArea = document.getElementById("deCostResult");
			var totalProjectCost = totalRoadTypeCost + totalFrontageRoadCost;
			totalProjectCost = Math.round(totalProjectCost/1000)*1000;
			theOutputArea.innerHTML = "<br>Project Length: <br>" + deProjectLength + " miles<br><br>Estimated Construction Cost: <br>$" + addCommas(totalProjectCost);
		}

		function addCommas(nStr) {
		  nStr += '';
		  x = nStr.split('.');
		  x1 = x[0];
		  x2 = x.length > 1 ? '.' + x[1] : '';
		  var rgx = /(\d+)(\d{3})/;
		  while (rgx.test(x1)) {
			x1 = x1.replace(rgx, '$1' + ',' + '$2');
		  }
		  return x1 + x2;
		}

		on(dom.byId("btnClearProject"), "click", deClear);
		function deClear() {
			map.graphics.clear();
			deActivateTool("POLYLINE");
			document.getElementById("deCostResult").innerHTML = "";
			theDistMeasured=0;
			xPointArray.length=0;
			currentMeasure=0;
			deLength=0;
	        activateTool("POLYLINE");
		}

		on(dom.byId("googleLink"), "click", openGoogleMaps);
        function openGoogleMaps() {
        	var ctr = map.extent.getCenter();
            var lat = ctr.getLatitude();
            var lon = ctr.getLongitude();
            var level = map.getLevel();
            window.open("https://www.google.com/maps/@"+lat+","+lon+","+level+"z");
        }
        on(dom.byId("bingLink"), "click", openBingMaps);
        function openBingMaps() {
        	var ctr = map.extent.getCenter();
            var lat = ctr.getLatitude();
            var lon = ctr.getLongitude();
            var level = map.getLevel();
            window.open("https://www.bing.com/mapspreview?cp="+lat+"~"+lon+"&lvl="+level+"&style=r");
        }

 		on(dom.byId("btnReleaseNotes"), "click", showReleaseNotes);
        function showReleaseNotes(){
        	document.getElementById("maskDiv").style.display="block";
        	document.getElementById("releaseNotesDiv").style.display="block";
        	document.getElementById('version').innerHTML = appVersion;
    	}
    	on(dom.byId("btnOpenDataPortal"), "click", openODP);
        function openODP() {
        	window.open("https://www.txdot.gov/opendata");

        }

        //Play a sound---------------------------
        function beep() {
           var snd = new Audio("resources/engage.mp3");
           snd.play();
        }
        //---------------------------------------

        function addSecondCondition() {
    			if (document.getElementById("radBridge").checked) {
    				var txtAttributes = document.getElementById("bridgeAttributes").value;
    			} else {
    				var txtAttributes = document.getElementById("riAttributes").value;
    			}

    			var txtOperator = document.getElementById("operators").value;
    			var txtConditions = document.getElementById("conditions").value;

          if (txtConditions.length<1) {
              alert("Please add a condition.");
              return;
          }

    			if (isNaN(txtConditions)) {
    				txtConditions = "'" + txtConditions + "'";
    			}

    			if (getLeftCharacters(txtConditions,1)=="0") {
    				txtConditions = "'" + txtConditions + "'";
    			}

          var currentValueCheck = queries.indexOf(txtAttributes + txtOperator + txtConditions);
          if (currentValueCheck>=0) {
              //Nothing, already there
          }
          else {
              queries.push(txtAttributes + txtOperator + txtConditions);
              listQueries();
          }
        }

        function removeLastCondition() {
            queries.pop();
            listQueries();
        }

        function listQueries() {
            var theOutput = "";
            for (var i = 0; i < queries.length; i++) {
                    theOutput += "<br>" + queries[i];
            }

            document.getElementById("print").innerHTML = theOutput;
        }

        var queries = [];
        function runQuery() {
    			if (document.getElementById("radBridge").checked) {
    				var txtAttributes = document.getElementById("bridgeAttributes").value;
    			} else {
    				var txtAttributes = document.getElementById("riAttributes").value;
    			}

    			var txtOperator = document.getElementById("operators").value;
    			var txtConditions = document.getElementById("conditions").value;

          if (txtConditions.length<1&&queries.length<1) {
              alert("Please add a condition.");
              return;
          }

          if (txtConditions.length>0) {
            if (isNaN(txtConditions)) {
      				txtConditions = "'" + txtConditions + "'";
      			}

      			if (getLeftCharacters(txtConditions,1)=="0") {
      				txtConditions = "'" + txtConditions + "'";
      			}

            var currentValueCheck = queries.indexOf(txtAttributes + txtOperator + txtConditions);
            if (currentValueCheck>=0) {
                //Nothing, already there
            }
            else {
                queries.push(txtAttributes + txtOperator + txtConditions);
            }
          }

          listQueries();

          var queryConditions = "";

          for (var i = 0; i < queries.length; i++) {
                  queryConditions += " AND "; //was &
                  queryConditions += queries[i];
          }

          selectAttributes(getRightCharacters(queryConditions, queryConditions.length-5));
        }

    		function getLeftCharacters(theData,theNumber) {
    		    //console.log(theData.substring(0, theNumber));
    		    return theData.substring(0, theNumber);
    		}

        function activateBridge() {
        	resetQuery();
        	document.getElementById("bridgeAttributes").style.display="block";
          document.getElementById("refBridge").style.display="block";
          document.getElementById("refBridgeDD").style.display="block";
        	document.getElementById("riAttributes").style.display="none";
          document.getElementById("refRoadway").style.display="none";
        }

        function activateRoadwayInventory () {
        	resetQuery();
        	document.getElementById("bridgeAttributes").style.display="none";
          document.getElementById("refBridge").style.display="none";
          document.getElementById("refBridgeDD").style.display="none";
        	document.getElementById("riAttributes").style.display="block";
          document.getElementById("refRoadway").style.display="block";
        }
        //---------------------------------------

        //HTML Table accepts a multi-dimensional array.  No field names.
        //---------------------------------------
        function makeTableFromArrayNoHeader(dataArray) {
            var result = "<table border=1 cellspacing=0 cellpadding=3 style='font-size:small'>";
            for(var i=0; i<dataArray.length; i++) {
                result += "<tr>";
                for(var j=0; j<dataArray[i].length; j++){
                    result += "<td>" + dataArray[i][j] + "</td>";
                }
                result += "</tr>";
            }
            result += "</table>";

            return result;
        }
        //---------------------------------------

        //HTML Table accepts a multi-dimensional array.  First set in the array should contain field names.  Example: [["ID","NAME","AGE"],["1", "Michael",43], ["2", "Jessica",40]]
        //---------------------------------------
        function makeTableFromArray(dataArray) {
            var result = "<table>";
            for(var i=0; i<dataArray.length; i++) {
                result += "<tr>";
                for(var j=0; j<dataArray[i].length; j++){
                    if (i==0) {
                        result += "<th>" + dataArray[i][j] + "</th>";
                    }
                    else {
                        result += "<td>" + dataArray[i][j] + "</td>";
                    }
                }
                result += "</tr>";
            }
            result += "</table>";

            return result;
        }
        //---------------------------------------

	});
		// These functions are outside of the Require so that they will be recognized in the HTML below.
		function closeReleaseNotes(){
			document.getElementById("maskDiv").style.display="none";
        	document.getElementById("releaseNotesDiv").style.display="none";
		}

		function closeOverlaysWarningDiv(){
			document.getElementById("maskDiv").style.display="none";
        	document.getElementById("overlaysWarningDiv").style.display="none";
		}
		//Get coordinates as text from info2 div and place in popup
        //Set URL link in popup
	    function getCoords(){
	      var coords = document.getElementById("info2").innerText;
	      document.getElementById("coordDisp").innerText = coords;
	      document.getElementById("maskDiv").style.display="block";
	      document.getElementById("getCoordsDiv").style.display="block";
          document.getElementById("getCoordsDiv").style.width="280px";
          document.getElementById("getCoordsDiv").style.height="240px";

          var long = globalY;
          var lat = globalX;
          var zoom = map.getZoom();
          //check if URL already has parameters and reset
          if (window.location.href.indexOf("?") > -1) {
              var index = window.location.href.indexOf("?");
              var baseURL = window.location.href.slice(0,index);
              url = baseURL+"?coords="+long+","+lat+"&z="+zoom;
          }
          else {
              url = window.location.href+"?coords="+long+","+lat+"&z="+zoom;
          }
          document.getElementById("linkDisp").innerText = url;
	    }
	    function closegetCoordsDiv(){
		  document.getElementById("maskDiv").style.display="none";
	      document.getElementById("getCoordsDiv").style.display="none";
          document.getElementById("linkDisp").innerText = "";
		}

  </script>
</head>
<body oncontextmenu="return false;" class="claro"; style="font-family: Calibri">
<div id="maskDiv"></div>
<div id="overlaysWarningDiv">
	<h1><strong>Whoops</strong></h1>
	<p2><strong>4 Overlay Maximum</strong></p3>
	<br>
	<br>
	<p1>Please turn off at least one other overlay in order to turn on another.</p1>
	<br>
	<button id="btnClose" style="padding: 5px 10px; position:relative; top: 20px; " onclick="closeOverlaysWarningDiv()">Close</button>
</div>
<div id="getCoordsDiv">
	<h1><strong>Coordinates</strong></h1>
	<p><strong><h3 align="left">Latitude, Longitude:</h3></strong></p>
    <div id="btnDiv">
    	<button id="btnCopy" style="padding: 5px 10px; top: 20px; margin-left: 5px; float: right;">Copy Lat/Long</button>
        <div id="coordDisp" contenteditable style="padding-top: 5px; padding-bottom: 5px; font-size: larger; overflow:hidden; white-space: nowrap; outline: auto;">coordinates go here</div>
    </div>
    <p><strong><h3 align="left">URL Link:</h3></strong></p>
    <div id="URLcontainer">
        <button id="btnCopyURL" style="padding: 5px 10px; top: 20px; margin-left: 5px; float: right;">Copy Link</button>
        <div id="linkDisp" contenteditable style="padding-top: 5px; padding-bottom: 5px; font-size: larger; overflow:hidden; white-space: nowrap; outline: auto;">url goes here</div>
    </div>
    <br>
    <button id="btnClose" style="padding: 5px 10px; top: 20px; " onclick="closegetCoordsDiv()">Close</button>

</div>
<div id="releaseNotesDiv">
	<h1><strong>RELEASE NOTES</strong></h1>
	<p3 id="version"></p3>
	<ul>
      <li>Added INRIX Traffic layer</li>
      <li>Increased Maximum Overlays to 4</li>
      <li>(v4.4.10) Bug fix for Imagery zoom level</li>
      <li>(v.4.4.9) Updates to Shale Play layer</li>
      <li>(v4.4.8) AADT layer updates to add 2020 data</li>
      <li>(v4.4.7) Added linear referencing Drag and Drop .csv support, updated Query Tab, bridge info box includes link to Bridge Report</li>
      <li>(v4.4.6) Bug fix related to Query tool</li>
      <li>(v4.4.5) Updated AADT popups and labels for 2019 data</li>
      <li>(v4.4.4) Added "TxDOT Bicycle Tourism Trails Example Network" layer</li>
      <li>(v4.4.4) Updated Reference Marker labels to include suffix</li>
      <li>(v4.4.4) Minor update related to Imagery Service attribution</li>
      <!-- <li>(v4.4.3) Added new "TxDOT Dark Grey" basemap</li>
      <li>(v4.4.3) Standardized popup text for "Route Name" field</li>
      <li>(v4.4.3) Updated API to 3.32</li>
      <li>(v4.4.3) Bug fix related to layer visibilty and zoom level</li>
      <li>(v4.4.3) Bug fix related to TxDOT Light Gray basemap labels</li> -->
      <!-- <li>(v4.4.2) Bug fix related to UZA layer</li> -->
      <!-- <li>(v4.4.1) Improved LRS performance</li>
      <li>(v4.4.1) Bug Fix related to Roadways popup</li> -->
      <!-- <li>(v4.4.0) Added Reference Marker Offset to LRS Tool and Updated LRS Readout</li>
      <li>(v4.4.0) Updated API to v3.31</li>
      <li>(v4.4.0) Added WebGL for faster rendering</li> -->
      <!-- <li>(v4.3.1) Removed Maintenance Section Overlay</li>
      <li>(v4.3.1) Added ability to copy URL link to clipboard</li>
      <li>(v4.3.1) Bug fix related to Control Section popup</li> -->
      <!-- <li>(v4.3.0) Added LRS Readout Tool</li>
      <li>(v4.3.0) Replaced Esri Light Gray basemap with custom "TxDOT Light Gray" basemap</li>
      <li>(v4.3.0) Create custom bookmarks by appending latitude, longitude, and zoom level to URL in format: <br>
          <strong style="color:blue";>?coords=26.177137,-98.186930&z=13</strong></li> -->
	  <!-- <li>(v4.2.0) Updated TxDOT Projects source layer, layer names, and popups to more closely align with Project Tracker</li> -->
	  <!-- <li>(v4.1.1) Bug fix for Control Section labels, which weren't rendering</li> -->
	  <!-- <li>(v4.1.1) Updated API to v 3.28</li> -->
	  <!-- <li>(v4.1.0) Bug fix related to the basemap</li> -->
	  <!-- <li>(v4.0.9) Added additional fields to popup for Bridge overlay</li> -->
	</ul>
	<button id="btnClose" style="padding: 5px 10px; position:relative; bottom: 5px; " onclick="closeReleaseNotes()">Close</button>
</div>
  <div id="toc">
      <div id="tabControl">
		  <table id="tcTabs">
			  <tr align="center">
				  <!-- <td class="Tabs" id="tcMap" bgcolor='#143c5c' style="color:white">Maps</td> -->
                  <td class="Tabs" id="tcMap" bgcolor='#143c5c' rowspan="2" style="color:white; border:solid 1px #143c5c; border-radius:2px";>Maps</td>
				  <td class="Tabs" id="tcMeasure" >Measure</td>
				  <td class="Tabs" id="tcQuery" >Query</td>
                  <td class="Tabs" id="tcLRS" >LRS</td>
			  </tr>
			  <tr align="center">
				  <td class="Tabs" id="tcSketch" >Sketch</td>
				  <td class="Tabs" id="tcLegend" >Legend</td>
				  <td class="Tabs" id="tcAbout" >About</td>
			  </tr>
		  </table>
	  </div>
	  <div id="mapTab">
		<table id="tocMaps" class="tocTables">
		  <tr><th>Basemaps</th></tr>
          <tr><td class="Basemaps" id='TxDOT' style="color:red; font-weight: bold;">TxDOT</td></tr>
		  <tr><td class="Basemaps" id='Google'>Texas Imagery Service</td></tr>
		  <tr><td class="Basemaps" id='txdotLightGray'>TxDOT Light Gray</td></tr>
          <tr><td class="Basemaps" id='txdotDarkGray'>TxDOT Dark Gray</td></tr>
		  <tr><td class="Basemaps" id='esriStreets'>Esri Streets</td></tr>
		  <tr><td class="Basemaps" id='openStreetMap'>Open Street Map</td></tr>
		</table>
		<table id="tocData" class="tocTables">
		  <tr><th>Overlays</th></tr>
		  <tr><td class="Overlay" id="CLEAR" style="color:red; font-weight: bold;">Clear Overlays</td></tr>
		  <tr><td class="Overlay" id='AADT'>AADT</td></tr>
		  <tr><td class="Overlay" id='Alt_Fuel_Points'>Alternative Fuel Points</td></tr>
		  <tr><td class="Overlay" id='Area_Offices'>Area Offices</td></tr>
		  <tr><td class="Overlay" id='Bridges'>Bridges</td></tr>
		  <tr><td class="Overlay" id='Cemetery'>Cemeteries</td></tr>
		  <tr><td class="Overlay" id='Control_Section'>Control Sections</td></tr>
		  <tr><td class="Overlay" id='COG'>Councils of Governments (COG)</td></tr>
		  <tr><td class="Overlay" id='Connectivitiy_Corridors'>Connectivity Corridors</td></tr>
		  <tr><td class="Overlay" id='Current_Congestion'>Congestion (Base Year)</td></tr>
		  <tr><td class="Overlay" id='Future_Congestion'>Congestion (Forecast Year)</td></tr>
		  <tr><td class="Overlay" id='Energy_Sector'>Energy Sector Corridors</td></tr>
		  <tr><td class="Overlay" id='Natl_Freight_Network'>Freight Network (FHWA)</td></tr>
		  <tr><td class="Overlay" id='TX_Freight_Network'>Freight Network (TxDOT)</td></tr>
		  <tr><td class="Overlay" id='Functional_Classification'>Functional Classification & Urban Areas</td></tr>
		  <tr><td class="Overlay" id='Future_Traffic'>Future Traffic & Percent Truck</td></tr>
		  <tr><td class="Overlay" id='Minute_Orders'>Highway Designations</td></tr>
		  <tr><td class="Overlay" id='Hurricane_Evac'>Hurricane Evacuation Routes</td></tr>
	 	  <tr><td class="Overlay" id='INRIX_Traffic'>Live Traffic</td></tr>
	 	  <tr><td class="Overlay" id='Maintenance_Section_Routes'>Maintenance Section Routes</td></tr>
          <tr><td class="Overlay" id='Memorial_Highway'>Memorial Highways</td></tr>
		  <tr><td class="Overlay" id='MPO'>Metropolitan Planning Organizations (MPO)</td></tr>
		  <tr><td class="Overlay" id='NHS'>National Highway System</td></tr>
		  <tr><td class="Overlay" id='Non_Attainment'>Non-Attainment Areas</td></tr>
		  <!-- <tr><td class="Overlay" id='Pavement_Conditions'>Pavement Conditions</td></tr> -->
		  <tr><td class="Overlay" id='Permanent_Stations'>Permanent Count Stations</td></tr>
          <tr><td class="Overlay" id='Construction_Scheduled'>Projects - Construction underway or begins soon</td></tr>
		  <tr><td class="Overlay" id='Finalizing_for_Construction'>Projects - Construction begins within 4 years</td></tr>
		  <tr><td class="Overlay" id='Under_Development'>Projects - Construction begins in 5 to 10 years</td></tr>
          <tr><td class="Overlay" id='Long_Term_Planning'>Projects - Corridor Studies, construction in 10+ years</td></tr>
		  <tr><td class="Overlay" id='Railroads'>Railroads</td></tr>
	      <tr><td class="Overlay" id='Reference_Markers'>Reference Markers</td></tr>
	      <tr><td class="Overlay" id='RMA'>Regional Mobility Authorities (RMA)</td></tr>
	      <tr><td class="Overlay" id='Roadway_Inventory'>Roadway Inventory - On-System Roadbeds</td></tr>
		  <tr><td class="Overlay" id='Shale_Plays'>Shale Plays</td></tr>
		  <tr><td class="Overlay" id='Speed_Limit'>Speed Limits</td></tr>
		  <tr><td class="Overlay" id='State_House_Districts'>State House Districts</td></tr>
		  <tr><td class="Overlay" id='State_Senate_Districts'>State Senate Districts</td></tr>
		  <tr><td class="Overlay" id='STRAHNET'>Strategic Highway Network (STRAHNET)</td></tr>
		  <tr><td class="Overlay" id='Texas_Trunk'>Texas Trunk System & Urban Areas</td></tr>
		  <tr><td class="Overlay" id='Tolls'>Tolls</td></tr>
		  <tr><td class="Overlay" id='Future_Tolls'>Tolls (Future & Proposed)</td></tr>
		  <tr><td class="Overlay" id='Top_100'>Top 100 Congested Roadways</td></tr>
          <tr><td class="Overlay" id='Bicycle_Trails'>TxDOT Bicycle Tourism Example Network</td></tr>
		  <tr><td class="Overlay" id='TxDOT_Facilities'>TxDOT Facilities</td></tr>
		  <tr><td class="Overlay" id='US_House_Districts'>US House Districts</td></tr>
		  <tr><td class="Overlay" id='Vertical_Clearance'>Vertical Clearance</td></tr>
		</table>
	  </div>
	  <div id="measureTab">
		<table class="tocTables">
         <tr><th>Units</th></tr>
		 <tr><td colspan="2">
		 <label class='clickable'><input type="radio" class="MeasureUnits" name="unitsList" value="Meters" title="Meters"> Meters</label>
		 <br>
		 <label class='clickable'><input type="radio" class="MeasureUnits" name="unitsList" value="Kilometers" title="Kilometers"> Kilometers</label>
		 <br>
		 <label class='clickable'><input type="radio" class="MeasureUnits" name="unitsList" value="Feet" title="Feet"> Feet</label>
		 <br>
		 <label class='clickable'><input id="radMile" type="radio" class="MeasureUnits" name="unitsList" value="Miles" checked="checked" title="Miles"> Miles</label>
		 </td></tr>
		 <tr><td width="100" colspan="2" align="left" id="measuredDistance">0.0</td></tr>
		 <tr><td><button title="Clear Graphics" id="clearMeasure">Clear</button></td></tr>
      	</table>
	  </div>

    <div id="queryTab">
			<table class="tocTables">
			<tr><th>Choose Query Layer</th></tr>
			</table>
			<br>
      <a href='https://txdot.maps.arcgis.com/sharing/rest/content/items/296c473f466e44dba31ad3edf2700af6/data' target='_blank' id="refBridge" style="display:none;">Bridge Coding Guide</a>
      <a href='https://txdot.maps.arcgis.com/sharing/rest/content/items/e9d8d0e3a9794be19be6ecaf5a24c176/data' target='_blank' id="refBridgeDD" style="display:none;">Bridge Data Dictionary</a>
      <a href="https://gis-txdot.opendata.arcgis.com/datasets/txdot-roadway-inventory-specifications-2018" target="_blank" id="refRoadway">Roadway Data Dictionary</a>
      <br>
      <br>
			<input type="radio" id="radBridge" name="dataType" value="bridge" title="Select Bridge Data">
			<label for="bridge">Bridge</label><br>
			<input type="radio" checked id="radRoadwayInventory" name="dataType" value="roadwayInventory" title="Select Roadway Inventory Data">
			<label for="roadwayInventory">Roadway Inventory</label><br>
			<br>
			<br>
            <form name="riInput">
                <label class="qryLabel" for="riAttributes">Pick an Attribute</label>
                <select class="qryInputs" id="riAttributes" name="riAttributes">
                    <option title="Roadway Inventory ID with Roadbed Extension - Examples: IH0035-KG, IH0035-RG, IH0035-LG" value="RIA_RTE_ID">Roadway ID (Ex. IH0035-KG)</option>
                    <option value="FRM_DFO">From DFO</option>
                    <option value="TO_DFO">To DFO</option>
                    <option value="C_SEC">Control Section</option>
                    <option value="BMP">Begin Milepoint</option>
                    <option value="EMP">End Milepoint</option>
                    <option value="CO">County (Ex. 227)</option>
                    <option value="DI">District (Ex. 15)</option>
                    <option value="ACES_CTRL">Access Control</option>
                    <option value="ADT_YEAR">Annual Average Daily Traffic Year</option>
                    <option value="ADT_CUR">Annual Average Daily Traffic</option>
                    <option value="DESGN_YR">Annual Average Daily Traffic - Future Year</option>
                    <option value="AADT_DESGN">Annual Average Daily Traffic - Future</option>
                    <option value="AADT_TRUCKS">Annual Average Daily Traffic - Truck</option>
                    <option value="AADT_SINGLE_UNIT">Annual Average Daily Single Unit Truck</option>
                    <option value="AADT_COMBINATION">Annual Average Daily Combined Axle Truck</option>
                    <option value="CITY">City</option>
                    <option value="DVMT">Daily Vehicle Miles Traveled</option>
                    <option value="DTRKVMT">Daily Vehicle Miles Traveled - Truck</option>
                    <option value="F_SYSTEM">Functional System</option>
                    <option value="LN_MILES">Lane Miles</option>
                    <option value="LANE_WIDTH">Lane Width</option>
                    <option value="MED_TYPE">Median Type</option>
                    <option value="MED_WID">Median Width</option>
                    <option value="MPA">Metropolitan Planning Area</option>
                    <option value="SEC_NHS">National Highway System</option>
                    <option value="NUM_LANES">Number of Lanes</option>
                    <option value="TRK_AADT_PCT">Percent Trucks</option>
                    <option value="PCT_SADT">Percent Truck Single Unit</option>
                    <option value="PCT_CADT">Percent Truck Combined Axle</option>
                    <option value="SPD_MAX">Posted Speed Limit</option>
                    <option value="ROW_MIN">Right of Way - Minimum</option>
                    <option value="RB_WID">Roadbed Width</option>
                    <option value="RU">Rural/Urban</option>
                    <option value="S_TYPE_I">Shoulder Type - Inside</option>
                    <option value="S_TYPE_O">Shoulder Type - Outside</option>
                    <option value="S_USE_I">Shoulder Use - Inside</option>
                    <option value="S_USE_O">Shoulder Use - Outside</option>
                    <option value="S_WID_I">Shoulder Width - Inside</option>
                    <option value="S_WID_O">Shoulder Width - Outside</option>
                    <option value="SUR_W">Surface Width</option>
                    <option value="SRF_TYPE">Surface Type</option>
                    <option value="SEC_TRUNK">Texas Trunk System</option>
                    <option value="TRF_STA_ID">Traffic Station ID</option>
                </select>
                <select style="display:none;" class="qryInputs" id="bridgeAttributes" name="bridgeAttributes">
                    <option value="APRCH_RDWAY_WIDTH">Approach Roadway Width</option>
                    <option value="ADT">Average Daily Traffic (ADT)</option>
                    <option value="ADT_TRK">Average Daily Truck Percent</option>
                    <option value="BRDG_ID">Bridge ID</option>
                    <option value="BRDG_RDWAY_WIDTH_CURB_CURB">Bridge Roadway Width (Curb-to-Curb)</option>
                    <option value="CITY_TOWN_CD">City Code</option>
                    <option value="CHNL_COND_RTNG">Condition Rating  Channel & Channel Protection</option>
                    <option value="CULV_COND_RTNG">Condition Rating  Culverts</option>
                    <option value="DECK_COND_RTNG">Condition Rating  Deck</option>
                    <option value="SUBSTRUC_COND_RTNG">Condition Rating - Substructure</option>
                    <option value="SUPERSTRUC_COND_RTNG">Condition Rating - Superstructure</option>
                    <option value="CNTY_CD">County (Ex. 227)</option>
                    <option value="DEFIC_OBSO_CD">Deficient/Obsolete Code</option>
                    <option value="STATE_HWY_DEPT_DIST">District (Ex. 15)</option>
                    <option title="Roadway Name - Examples: IH 35" value="FACLTY_CARRD_BY_STRUC">Facility Carried (Ex. IH 35)</option>
                    <option value="INV_RTE_HRZNTL_CLEAR">Inventory Route, Total Horizontal Clearance</option>
                    <option value="LANES_ON_STRUC">Lanes On The Structure</option>
                    <option value="LANES_UNDER_STRUC">Lanes Under The Structure</option>
                    <option value="MAINT_SECT_NBR">Maintenance Section Number</option>
                    <option value="MEMB_TYPE">Member Type</option>
                    <option value="MIN_VERT_UNDR_CLRNC_IN">Minimum Vertical Under clearance (Inches)</option>
                    <option value="MIN_VERT_UNDR_CLRNC_FT">Minimum Vertical Under clearance (Feet)</option>
                    <option value="OPRTL_STAT_CD">Operational Status</option>
                    <option value="PRNCPL_INV_RTE">Principle Inventory Route</option>
                    <option value="RDWAY_TYPE">Roadway Type</option>
                    <option value="RTE_NBR">Route Number (Ex. 0035)</option>
                    <option value="SCOUR_CRIT">Scour Critical Bridges</option>
                    <option value="SKEW">Skew</option>
                    <option value="SPAN_TYPE">Span Type</option>
                    <option value="STRUC_LNGTH">Structure Length</option>
                    <option value="SUBSTRUC_MAIN_SPAN_ABOVE">Substructure Type, Main Spans (Above)</option>
                    <option value="SUBSTRUC_MAIN_SPAN_BELOW">Substructure Type, Main Spans (Below)</option>
                    <option value="SUBSTRUC_MAIN_SPAN_BENT_CAP">Substructure Type, Main Spans (Bent Cap)</option>
                    <option value="SUFF_RTNG">Sufficiency Rating</option>
                    <option value="TOTL_NBR_SPANS">Total Number of Spans</option>
                    <option value="YR_BLT">Year Built</option>
                    <option value="YR_RECNSTR">Year Reconstructed</option>
                </select>
                <br><br>
                <label class="qryLabel" for="operators">Pick an Operator</label>
                <select class="qryInputs" id="operators" name="Operator">
                    <option value="<">Less Than</option>
                    <option value=">">Greater Than</option>
                    <option value="=">Equal To</option>
                </select>
                <br><br>
                <label class="qryLabel" for="conditions">Add Condition</label>
                <input class="qryInputs" type="text" id="conditions" name="conditions"/>
            </form>

            <p id="print"></p>

            <button id="btnAddSecondCondition" class="qryButton" title="Click to save current condition and add another.">Add Condition</button>
            <button id="btnRemoveLastCondition" class="qryButton" title="Click to remove last condition on list.">Remove Last</button>
            <button id="btnRunQuery" class="qryButton" title="Click to view results.">Run</button>
            <br><br>
            <div id="queryResults"></div>
	  	</div>

      <div id="lrsTab">
		<table class="tocTables">
         <tr><th colspan="2">LRS Readout Tool</th></tr>
         <tr><td colspan="2">
         <br>
         Click on a route in the map to populate the table and calculate the following:
         <br>
         <br>
         <a href="https://www.arcgis.com/home/item.html?id=8d65f4b0455a4be0b4d1de759678209c" target="_blank">Control Section Milepoint</a>
         <br>
         <br>
         <a href="https://www.arcgis.com/home/item.html?id=fe58a88d6196446981017fe161f4b1fd" target="_blank">Reference Marker Offset</a>
         <br>
         <br>
         <a href="https://www.arcgis.com/home/item.html?id=d4f7206d27af4358acb70cb1cc819d10" target="_blank">Distance from Origin</a>
         <br>
         <br>Latitude/Longitude
         <br>
         <br>
         <br>
         * Note - Calculated Control Section Milepoint values available on centerlines only.
         <br><br></td></tr>
		 <tr><td colspan="2">
		 </td></tr>
         <th colspan="2" class="lrsTH">Control Section Milepoint</th>
         <tr><td></td></tr>
         <tr><td>Control Section: </td><td width="100" colspan="2" align="left" id="csNBR"></td></tr>
         <tr><td></td></tr>
         <tr><td>Calculated MPT: </td><td width="100" colspan="2" align="left" id="calculatedMPT" style="color:red;"></td></tr>
         <tr><td></td></tr>
         <tr><td>Begin MPT: </td><td width="100" colspan="2" align="left" id="beginMPT"></td></tr>
         <tr><td></td></tr>
         <tr><td>End MPT: </td><td width="100" colspan="2" align="left" id="endMPT"></td></tr>
         <tr><td></td></tr>
         <th colspan="2" class="lrsTH">Reference Marker Offset</th>
         <tr><td></td></tr>
         <tr><td>Marker Number: </td><td width="100" colspan="2" align="left" id="refMarker"></td></tr>
         <tr><td></td></tr>
         <tr><td>Offset: </td><td width="100" colspan="2" align="left" id="offset" style="color:red;"></td></tr>
         <tr><td></td></tr>
         <th colspan="2" class="lrsTH">Distance from Origin</th>
         <tr><td></td></tr>
         <tr><td >Route Name: </td><td width="100" align="left" id="rteNM"></td></tr>
         <tr><td></td></tr>
         <tr><td>Calculated DFO: </td><td width="100" colspan="2" align="left" id="calculatedDFO" style="color:red;"></td></tr>
         <tr><td></td></tr>
         <tr><td>Begin DFO: </td><td width="100" colspan="2" align="left" id="beginDFO"></td></tr>
         <tr><td></td></tr>
         <tr><td>End DFO: </td><td width="100" colspan="2" align="left" id="endDFO"></td></tr>
         <tr><td></td></tr>
         <th colspan="2" class="lrsTH">Latitude and Longitude</th>
         <tr><td></td></tr>
         <tr><td>Latitude: </td><td width="100" colspan="2" align="left" id="lat"></td></tr>
         <tr><td></td></tr>
         <tr><td>Longitude: </td><td width="100" colspan="2" align="left" id="long"></td></tr>
         <tr><td></td></tr>
         <tr><td height="40px"></td></tr>

         <tr><td><button title="Reset Readout" id="resetReadout">Reset All</button></td></tr>
      	</table>
	  </div>
		<div id="sketchTab">
			<table class="tocTables">
				<tr><th colspan=2>Sketch Planning Tool</th><tr>
				<tr><td>
				* Note - This tool is for planning purposes only.  It is not a tool for roadway design or engineering purposes.
				<br><br>Construction cost estimates are calculated using average project cost by type from August 2003 to August 2013 in 2013 dollars.
				<br><br>Frontage roads assumed two lanes per direction when selected.
				<br><br>
				</td></tr>
				<tr><td>
					<label Class="PRJFields" id="lblPrjType">Project Type</label>
					<select Class="PRJFields" id="selPrjType" name="selPrjType">
						<option value="A">New Roadway</option>
						<option value="B">Reconstruction</option>
					</select>
					<br>
					<label Class="PRJFields" id="lblAreaType">Area Type</label>
					<select Class="PRJFields" id="selPrjAreaType" name="selPrjAreaType">
						<option value="C">Urban</option>
						<option value="D">Rural</option>
					</select>
					<br>
					<label Class="PRJFields" id="lblPrjRouteType">Route Type</label>
					<select Class="PRJFields" id="selPrjRouteType" name="selPrjRouteType">
						<option value="E">Freeway</option>
						<option value="F">Arterial</option>
						<option value="G">Collector</option>
					</select>
					<br>
					<label Class="PRJFields" id="lblPrjDivided">Configuration</label>
					<select Class="PRJFields" id="selPrjDividedType" name="selPrjDividedType">
						<option value="H">Divided</option>
						<option value="I">Undivided</option>
					</select>
					<br>
					<label Class="PRJFields" id="lblPrjFrontageRoads">Frontage Roads</label>
					<select Class="PRJFields" id="selPrjFrontageRoads" name="selPrjFrontageRoads">
						<option value="1">No</option>
						<option value="2">Yes</option>
					</select>
					<br>
					<label Class="PRJFields" id="lblPrjLanes">Number of Main Lanes</label>
					<input Class="PRJFields" type="number" id="txtPrjLanes" name="txtPrjLanes">
					<br><br>
					<button id="btnCalcCost" title="Estimate Project Cost">Calculate Cost</button>
					<button id="btnClearProject" title="Clear Project">Clear</button>
					<div id="deCostResult"></div>
				</td></tr>
			</table>
		</div>
		<div id="legendTab">
			<table class="tocTables">
				<tr><th>Map Legend</th><tr>
				<tr><td>
					<div id="legendDiv"></div>
					<div id="legendNotesDiv" style="display:none"><b>NOTES:</b></div>
					<div id="legendDescDiv"></div>
				</td><tr>
			</table>
		</div>
		<div id="aboutTab">
			<table class="tocTables">
				<tr><th>Map Disclaimer</th><tr>
				<tr><td>The Statewide Planning Map displays data in support of planning operations at TxDOT.
				<br><br>Although we try to update information as often as possible, we are not assuming any responsibility for any damages or inaccuracies if you rely on it.
				<br><br>We offer no warranty that this application is accurate or complete. The information shown is for informational purposes and may not have been prepared for or be suitable for legal, engineering, or surveying purposes.
				<br><br>It does not represent an on-the-ground survey and represents only the approximate relative location of property/administrative boundaries.
				<br><br><button type="button" id="btnReleaseNotes"></button>
				</td><tr>
			</table>
		</div>
  </div>
 <div id="search"></div>
 <div id="mapDiv" oncontextmenu="getCoords()">
	 <div id="HomeButton" class="button"></div>
     <span id="info"></span>
     <span id="info2"></span>
	 <button id="btnClearHighlighter" title="Clear Highlight" style="display:none">
	 	<span>x</span>
	 </button>
 </div>
 <div id="credits"></div>
<div class="divODP">
	<button id="btnOpenDataPortal" title="Open Data Portal" target="_blank">Download Data</button>
</div>
 <nav>
    <ul>
      <li><a href="javascript: void(0)">Jump To...</a>
      		<ul>
      			<li id = "googleLink"><a href="javascript: void(0)">Google Maps</a></li>
      			<li id = "bingLink"><a href="javascript: void(0)">Bing Maps</a></li>
      		</ul>
      </li>
	</ul>
  </nav>
</body>
</html>
